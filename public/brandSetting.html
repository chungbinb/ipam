<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>品牌设置</title>
    <link rel="stylesheet" type="text/css" href="../public/css/Pagestyle.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .container { padding: 40px; max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 2rem; color: #2d3e50; margin-bottom: 32px; }
        .brand-section { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; margin-bottom: 32px; padding: 32px 24px; }
        .brand-section h2 { font-size: 1.3rem; color: #007bff; margin-bottom: 18px; }
        .brand-actions { margin-bottom: 12px; }
        .brand-actions button { background: #007bff; color: #fff; border: none; padding: 8px 24px; border-radius: 6px; cursor: pointer; }
        .brand-actions button:hover { background: #0056b3; }
        table.brand-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px #0001; }
        table.brand-table th, table.brand-table td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; }
        table.brand-table th { background: #f4f6fa; color: #2d3e50; font-weight: 500; }
        table.brand-table td.brand-action-cell { text-align: center; }
        .brand-action-btn { background: none; border: none; color: #007bff; cursor: pointer; margin-right: 8px; }
        .brand-action-btn.delete { color: #d9534f; }
        /* 弹窗样式 */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 9999; }
        .modal-mask.show { display: block; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; padding: 32px 24px; border-radius: 10px; box-shadow: 0 2px 16px #0002; min-width: 260px; max-width: 320px; text-align: center; }
        .modal-content h3 { margin-top:0; color:#2d3e50; }
        .modal-content label { font-weight:500; color:#2d3e50; }
        .modal-content input, .modal-content select { width: 100%; margin-bottom: 12px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 15px; }
        .modal-actions { text-align:right; margin-top:16px; }
        .modal-actions button { margin-left:8px; padding:8px 24px; border-radius:6px; border:none; font-size:15px; cursor:pointer; background:#007bff; color:#fff; }
        .modal-actions button.cancel { background:#6c757d; }
        .modal-actions button.delete { background:#d9534f; }
        .modal-actions button.delete:hover { background:#b52a1a; }
        /* 统计卡片样式 */
        .stat-card { flex: 1; padding: 24px; border-radius: 10px; color: #fff; font-size: 1.2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .stat-card div { text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 品牌类型统计卡片 -->
        <div style="display:flex;gap:24px;margin-bottom:32px;">
            <div class="stat-card" style="background:#007bff;">
                <div id="brandCountMonitor">0</div>
                <div>显示器品牌数</div>
            </div>
            <div class="stat-card" style="background:#43b1ea;">
                <div id="brandCountServer">0</div>
                <div>服务器品牌数</div>
            </div>
            <div class="stat-card" style="background:#3f51b5;">
                <div id="brandCountHost">0</div>
                <div>电脑品牌数</div>
            </div>
            <div class="stat-card" style="background:#009688;">
                <div id="brandCountLaptop">0</div>
                <div>笔记本品牌数</div>
            </div>
            <div class="stat-card" style="background:#ff9800;">
                <div id="brandCountConsumable">0</div>
                <div>打印机品牌数</div>
            </div>
            <div class="stat-card" style="background:#6c757d;">
                <div id="brandCountCamera">0</div>
                <div>监控品牌数</div>
            </div>
        </div>
        <!-- 只保留一个品牌区域 -->
        <div class="brand-section">
            <h2>品牌总表</h2>
            <div class="brand-actions" style="display:flex;gap:12px;">
                <button onclick="showBrandModal('all')">新增品牌</button>
                <button id="batchDeleteBrandBtn" style="background:#d9534f;">批量删除</button>
            </div>
            <table class="brand-table" id="table_all">
                <thead>
                    <tr>
                        <th style="width:40px;text-align:center;">
                            <input type="checkbox" id="selectAllBrand" style="cursor:pointer;">
                        </th>
                        <th style="width:60px;">序号</th>
                        <th>品牌名称</th>
                        <th>所属类型</th>
                        <th style="width:120px;">操作</th>
                    </tr>
                </thead>
                <tbody id="tbody_all"></tbody>
            </table>
        </div>
    </div>
    <!-- 右侧抽屉弹窗（新增/编辑品牌） -->
    <div id="brandDrawerMask" style="display:none;position:fixed;top:0;right:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;">
        <div id="brandDrawerContent"
            style="position:absolute;top:0;right:0;width:400px;height:100vh;background:#fff;box-shadow:-2px 0 16px #0002;padding:32px 24px;overflow-y:auto;transition:transform 0.4s cubic-bezier(.4,0,.2,1);transform:translateX(100%);border-radius:10px 0 0 10px;">
            <h3 id="brandDrawerTitle" style="margin-top:0;color:#2d3e50;">新增品牌</h3>
            <form id="brandDrawerForm" style="display:flex;flex-direction:column;gap:18px;">
                <input type="hidden" name="type">
                <input type="hidden" name="id">
                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                    <label style="font-weight:500;color:#2d3e50;margin-bottom:6px;">品牌名称 <span style="color:red">*</span></label>
                    <input type="text" name="name" required placeholder="请输入品牌名称" style="width:100%;margin-bottom:0;">
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                    <label style="font-weight:500;color:#2d3e50;margin-bottom:6px;">所属类型 <span style="color:red">*</span></label>
                    <select name="brandType" required style="width:100%;margin-bottom:0;">
                        <option value="">请选择类型</option>
                        <option value="monitor">显示器</option>
                        <option value="server">服务器</option>
                        <option value="host">电脑</option>
                        <option value="laptop">笔记本</option>
                        <option value="consumable">打印机</option>
                        <option value="camera">监控</option>
                    </select>
                </div>
                <div class="modal-actions" style="margin-top:24px;text-align:right;">
                    <button type="button" class="cancel" id="brandDrawerCancelBtn" style="background:#6c757d;">取消</button>
                    <button type="submit" id="brandDrawerOkBtn" style="background:#007bff;">确定</button>
                </div>
            </form>
        </div>
    </div>
    <!-- 删除弹窗 -->
    <div id="deleteModal" class="modal-mask">
        <div class="modal-content">
            <div style="font-size:18px;margin-bottom:24px;display:flex;align-items:center;justify-content:center;gap:8px;">
                <span style="font-size:24px;color:#ffc107;">&#9888;</span>
                <span id="deleteModalText" style="color:#d9534f;">确定要删除该品牌吗？</span>
            </div>
            <div class="modal-actions" style="text-align:center;display:flex;justify-content:center;gap:16px;margin-top:16px;">
                <button class="cancel" id="deleteModalCancelBtn">取消</button>
                <button class="delete" id="deleteModalOkBtn">删除</button>
            </div>
        </div>
    </div>
    <script>
        // 品牌类型定义
        const BRAND_TYPES = [
            { key: 'monitor', label: '显示器品牌' },
            { key: 'server', label: '服务器品牌' },
            { key: 'host', label: '主机品牌' },
            { key: 'laptop', label: '笔记本品牌' },
            { key: 'consumable', label: '打印机品牌' }, // 修改为打印机品牌
            { key: 'camera', label: '监控品牌' }
        ];
        const BRAND_TYPE_LABELS = {
            monitor: '显示器',
            server: '服务器',
            host: '电脑',
            laptop: '笔记本',
            consumable: '打印机', // 修改为打印机
            camera: '监控'
        };

        // 品牌数据缓存
        let brandData = {
            monitor: [],
            server: [],
            host: [],
            laptop: [],
            camera: [],
            consumable: [],
            all: []
        };

        // 当前弹窗状态
        let currentType = '';
        let currentEditId = null;
        let currentDeleteType = '';
        let currentDeleteId = null;

        // 渲染品牌表格
        function renderBrandTable(type) {
            let list = [];
            if (type === 'all') {
                // 合并所有类型
                list = [];
                BRAND_TYPES.forEach(t => {
                    (brandData[t.key] || []).forEach(item => {
                        list.push({ ...item, brandType: t.key });
                    });
                });
            } else {
                list = brandData[type] || [];
            }
            const tbody = document.getElementById('tbody_' + type);
            if (!tbody) return; // 防止tbody为null导致报错
            tbody.innerHTML = '';
            list.forEach((item, idx) => {
                const brandType = item.brandType || type;
                const typeLabel = BRAND_TYPE_LABELS[brandType] || '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:center;">
                        <input type="checkbox" class="rowBrandCheckbox" data-id="${item.id}" data-type="${brandType}" style="cursor:pointer;">
                    </td>
                    <td>${idx + 1}</td>
                    <td>${item.name}</td>
                    <td>${typeLabel}</td>
                    <td class="brand-action-cell">
                        <button class="brand-action-btn" onclick="showBrandModal('${type}', ${item.id}, '${item.name}', '${brandType}')">
                            <span style="display:inline-block;vertical-align:middle;">
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                    <path d="M4 13.5V16h2.5l9-9-2.5-2.5-9 9z" stroke="#007bff" stroke-width="2" fill="none"/>
                                    <path d="M13.5 6.5l2 2" stroke="#007bff" stroke-width="2" fill="none"/>
                                </svg>
                            </span>
                            编辑
                        </button>
                        <button class="brand-action-btn delete" onclick="showDeleteModal('${type}', ${item.id}, '${item.name}')">
                            <span style="display:inline-block;vertical-align:middle;">
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                    <rect x="5" y="7" width="10" height="8" rx="2" stroke="#d9534f" stroke-width="2" fill="none"/>
                                    <path d="M7 7V5a3 3 0 0 1 6 0v2" stroke="#d9534f" stroke-width="2" fill="none"/>
                                    <line x1="8" y1="10" x2="8" y2="14" stroke="#d9534f" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="12" y1="10" x2="12" y2="14" stroke="#d9534f" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </span>
                            删除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 绑定全选
            const selectAll = document.getElementById('selectAllBrand');
            if (selectAll) {
                selectAll.checked = false;
                selectAll.onclick = function() {
                    const checked = this.checked;
                    document.querySelectorAll('.rowBrandCheckbox').forEach(cb => { cb.checked = checked; });
                };
            }
            document.querySelectorAll('.rowBrandCheckbox').forEach(cb => {
                cb.onclick = function() {
                    const all = document.querySelectorAll('.rowBrandCheckbox');
                    const allChecked = Array.from(all).every(x => x.checked);
                    if (selectAll) selectAll.checked = allChecked;
                };
            });
        }

        // 获取品牌数据（从后端API读取）
        function fetchBrandList(type) {
            if (type === 'all') {
                // 获取所有品牌（后端API返回所有类型）
                fetch('../api/brand')
                    .then(res => res.json())
                    .then(res => {
                        if (res.code === 0 && Array.isArray(res.data)) {
                            // 按类型分组
                            BRAND_TYPES.forEach(t => {
                                brandData[t.key] = res.data.filter(item => item.type === t.key);
                            });
                            brandData.all = res.data;
                            renderBrandTable('all');
                            renderBrandStats();
                        } else {
                            BRAND_TYPES.forEach(t => { brandData[t.key] = []; });
                            brandData.all = [];
                            renderBrandTable('all');
                            renderBrandStats();
                        }
                    });
            } else {
                // 获取某一类型品牌
                fetch(`../api/brand?type=${type}`)
                    .then(res => res.json())
                    .then(res => {
                        if (res.code === 0 && Array.isArray(res.data)) {
                            brandData[type] = res.data;
                            renderBrandTable(type);
                            renderBrandStats();
                        } else {
                            brandData[type] = [];
                            renderBrandTable(type);
                            renderBrandStats();
                        }
                    });
            }
        }

        // 品牌统计卡片渲染
        function renderBrandStats() {
            document.getElementById('brandCountMonitor').innerText = brandData.monitor.length;
            document.getElementById('brandCountServer').innerText = brandData.server.length;
            document.getElementById('brandCountHost').innerText = brandData.host.length;
            document.getElementById('brandCountLaptop').innerText = brandData.laptop.length;
            document.getElementById('brandCountConsumable').innerText = brandData.consumable.length;
            document.getElementById('brandCountCamera').innerText = brandData.camera.length;
        }

        // 初始化所有品牌数据
        function initBrandData() {
            fetchBrandList('all');
        }

        // 替换弹窗为抽屉
        window.showBrandModal = function(type, id, name, brandType) {
            currentType = type;
            currentEditId = id || null;
            document.getElementById('brandDrawerTitle').innerText = id ? '编辑品牌' : '新增品牌';
            const form = document.getElementById('brandDrawerForm');
            form.type.value = type;
            form.id.value = id || '';
            form.name.value = name || '';
            form.brandType.value = brandType || (type !== 'all' ? type : '');
            // 显示抽屉
            const mask = document.getElementById('brandDrawerMask');
            const content = document.getElementById('brandDrawerContent');
            mask.style.display = 'block';
            content.classList.remove('active');
            setTimeout(() => {
                content.classList.add('active');
                content.style.transform = 'translateX(0)';
            }, 10);
        };
        document.getElementById('brandDrawerCancelBtn').onclick = function() {
            hideBrandDrawer();
        };
        document.getElementById('brandDrawerMask').addEventListener('mousedown', function(e) {
            if (e.target === this) hideBrandDrawer();
        });
        function hideBrandDrawer() {
            const mask = document.getElementById('brandDrawerMask');
            const content = document.getElementById('brandDrawerContent');
            content.classList.remove('active');
            content.style.transform = 'translateX(100%)';
            setTimeout(() => {
                mask.style.display = 'none';
                document.getElementById('brandDrawerForm').reset();
            }, 400);
        }

        // 新增/编辑提交（抽屉表单）
        document.getElementById('brandDrawerForm').onsubmit = function(e) {
            e.preventDefault();
            const type = this.type.value;
            const id = this.id.value;
            const name = this.name.value.trim();
            const brandType = this.brandType.value;
            if (!name || !brandType) {
                alert('品牌名称和所属类型不能为空');
                return;
            }
            // 新增/编辑时写入数据库
            if (id) {
                // 编辑
                fetch(`../api/brand/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type: brandType })
                }).then(res => res.json()).then(res => {
                    if (res.code === 0) {
                        fetchBrandList(brandType);
                        fetchBrandList('all');
                        renderBrandStats();
                        hideBrandDrawer();
                    } else {
                        alert('编辑失败');
                    }
                });
            } else {
                // 新增
                fetch('../api/brand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type: brandType })
                }).then(res => res.json()).then(res => {
                    if (res.code === 0) {
                        fetchBrandList(brandType);
                        fetchBrandList('all');
                        renderBrandStats();
                        hideBrandDrawer();
                    } else {
                        alert('新增失败');
                    }
                });
            }
        };

        // 删除弹窗
        window.showDeleteModal = function(type, id, name) {
            currentDeleteType = type;
            currentDeleteId = id;
            document.getElementById('deleteModalText').innerText = `确定要删除品牌：${name} 吗？`;
            document.getElementById('deleteModal').classList.add('show');
        };
        document.getElementById('deleteModalCancelBtn').onclick = function() {
            document.getElementById('deleteModal').classList.remove('show');
        };
        document.getElementById('deleteModal').addEventListener('mousedown', function(e) {
            if (e.target === this) this.classList.remove('show');
        });
        document.getElementById('deleteModalOkBtn').onclick = function() {
            let type = currentDeleteType;
            let id = currentDeleteId;
            // 删除时需确定所属类型
            let foundType = type;
            if (type === 'all') {
                // 在所有类型中查找
                for (let t of BRAND_TYPES) {
                    let arr = brandData[t.key] || [];
                    if (arr.some(item => item.id == id)) {
                        foundType = t.key;
                        break;
                    }
                }
            }
            // 删除数据库数据
            fetch(`../api/brand/${id}`, {
                method: 'DELETE'
            }).then(res => res.json()).then(res => {
                if (res.code === 0) {
                    fetchBrandList(foundType);
                    fetchBrandList('all');
                    renderBrandStats();
                    document.getElementById('deleteModal').classList.remove('show');
                } else {
                    alert('删除失败');
                }
            });
        };

        // 批量删除按钮逻辑
        document.getElementById('batchDeleteBrandBtn').onclick = function() {
            const checkedBoxes = Array.from(document.querySelectorAll('.rowBrandCheckbox')).filter(cb => cb.checked);
            if (checkedBoxes.length === 0) {
                alert('请先选择要删除的品牌');
                return;
            }
            if (!confirm(`确定要删除选中的${checkedBoxes.length}项吗？`)) return;
            // 收集所有选中的id
            const ids = checkedBoxes.map(cb => cb.getAttribute('data-id'));
            fetch('../api/brand/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            }).then(res => res.json()).then(res => {
                if (res.code === 0) {
                    fetchBrandList('all');
                    renderBrandStats();
                } else {
                    alert('批量删除失败');
                }
            });
        };

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            renderBrandTable('all');
            initBrandData();
        });
    </script>
</body>
</html>
