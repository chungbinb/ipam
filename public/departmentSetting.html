<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>部门设置</title>
    <link rel="stylesheet" type="text/css" href="../public/css/Pagestyle.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .container { padding: 40px; max-width: 1200px; margin: 0 auto; }
        h1 { font-size: 2rem; color: #2d3e50; margin-bottom: 32px; }
        .stat-card { flex:1; background:#007bff; padding:24px; border-radius:10px; box-shadow:0 2px 8px #0001; text-align:center; color: #fff; }
        .stat-card div:first-child { font-size:32px; font-weight:bold; color:#fff; }
        .stat-card div:last-child { color:#fff; margin-top:8px; }
        .department-section { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; margin-bottom: 32px; padding: 32px 24px; }
        .department-section h2 { font-size: 1.3rem; color: #007bff; margin-bottom: 18px; }
        .department-actions { margin-bottom: 12px; display:flex; gap:12px; }
        .department-actions button { background: #007bff; color: #fff; border: none; padding: 8px 24px; border-radius: 6px; cursor: pointer; }
        .department-actions button.delete { background: #d9534f; }
        .department-actions button:hover { background: #0056b3; }
        table.department-table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 8px #0001; }
        table.department-table th, table.department-table td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; }
        table.department-table th { background: #f4f6fa; color: #2d3e50; font-weight: 500; }
        table.department-table td.action-cell { text-align: center; }
        .action-btn { background: none; border: none; color: #007bff; cursor: pointer; margin-right: 8px; }
        .action-btn.delete { color: #d9534f; }
        /* 弹窗样式 */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 9999; }
        .modal-mask.show { display: block; }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; padding: 32px 24px; border-radius: 10px; box-shadow: 0 2px 16px #0002; min-width: 260px; max-width: 320px; text-align: center; }
        .modal-content h3 { margin-top:0; color:#2d3e50; }
        .modal-content label { font-weight:500; color:#2d3e50; }
        .modal-content input, .modal-content select { width: 100%; margin-bottom: 12px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 15px; }
        .modal-actions { text-align:right; margin-top:16px; }
        .modal-actions button { margin-left:8px; padding:8px 24px; border-radius:6px; border:none; font-size:15px; cursor:pointer; background:#007bff; color:#fff; }
        .modal-actions button.cancel { background:#6c757d; }
        .modal-actions button.delete { background:#d9534f; }
        .modal-actions button.delete:hover { background:#b52a1a; }
        /* 抽屉样式 */
        #departmentDrawerMask { display: none; position: fixed; top: 0; right: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 9999; }
        #departmentDrawerContent {
            position: absolute;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 16px #0002;
            padding: 0;
            overflow-y: auto;
            transition: transform 0.4s cubic-bezier(.4,0,.2,1);
            transform: translateX(100%);
            border-radius: 10px 0 0 10px;
        }
        #departmentDrawerContent.active {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>部门设置</h1>
        <!-- 顶部统计卡片 -->
        <div style="display:flex;gap:24px;margin-bottom:32px;">
            <div class="stat-card">
                <div id="departmentCount">0</div>
                <div>部门数量</div>
            </div>
            <div class="stat-card">
                <div id="regionCount">0</div>
                <div>地区数量</div>
            </div>
        </div>
        <div class="department-section">
            <h2>部门列表</h2>
            <div class="department-actions">
                <button onclick="showDepartmentModal()">新增部门</button>
                <button id="batchDeleteDepartmentBtn" class="delete">批量删除</button>
            </div>
            <table class="department-table" id="departmentTable">
                <thead>
                    <tr>
                        <th style="width:40px;text-align:center;">
                            <input type="checkbox" id="selectAllDepartment" style="cursor:pointer;">
                        </th>
                        <th style="width:60px;">序号</th>
                        <th>部门名称</th>
                        <th>地区</th>
                        <th>备注</th>
                        <th style="width:120px;">操作</th>
                    </tr>
                </thead>
                <tbody id="departmentTableBody"></tbody>
            </table>
        </div>
    </div>
    <!-- 新增/编辑弹窗 -->
    <div id="departmentModal" class="modal-mask">
        <div class="modal-content">
            <h3 id="departmentModalTitle">新增部门</h3>
            <form id="departmentForm" style="display:flex;flex-direction:column;gap:18px;">
                <input type="hidden" name="id">
                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                    <label>部门名称 <span style="color:red">*</span></label>
                    <input type="text" name="name" required placeholder="请输入部门名称">
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                    <label>地区 <span style="color:red">*</span></label>
                    <input type="text" name="region" required placeholder="请输入地区">
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                    <label>备注</label>
                    <input type="text" name="remark" placeholder="备注">
                </div>
                <div class="modal-actions" style="margin-top:24px;text-align:right;">
                    <button type="button" class="cancel" id="departmentModalCancelBtn" style="background:#6c757d;">取消</button>
                    <button type="submit" id="departmentModalOkBtn" style="background:#007bff;">确定</button>
                </div>
            </form>
        </div>
    </div>
    <!-- 删除弹窗 -->
    <div id="deleteDepartmentModal" class="modal-mask">
        <div class="modal-content">
            <div style="font-size:18px;margin-bottom:24px;display:flex;align-items:center;justify-content:center;gap:8px;">
                <span style="font-size:24px;color:#ffc107;">&#9888;</span>
                <span id="deleteDepartmentModalText" style="color:#d9534f;">确定要删除该部门吗？</span>
            </div>
            <div class="modal-actions" style="text-align:center;display:flex;justify-content:center;gap:16px;margin-top:16px;">
                <button class="cancel" id="deleteDepartmentModalCancelBtn">取消</button>
                <button class="delete" id="deleteDepartmentModalOkBtn">删除</button>
            </div>
        </div>
    </div>
    <!-- 新增/编辑抽屉弹窗 -->
    <div id="departmentDrawerMask" style="display:none;position:fixed;top:0;right:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;">
        <div id="departmentDrawerContent"
            style="position:absolute;top:0;right:0;width:400px;height:100vh;background:#fff;box-shadow:-2px 0 16px #0002;padding:0;overflow-y:auto;transition:transform 0.4s cubic-bezier(.4,0,.2,1);transform:translateX(100%);border-radius:10px 0 0 10px;">
            <div style="padding:32px 24px;">
                <h3 id="departmentDrawerTitle" style="margin-top:0;color:#2d3e50;font-size:22px;font-weight:bold;margin-bottom:24px;">新增部门</h3>
                <form id="departmentDrawerForm" style="display:flex;flex-direction:column;gap:0;">
                    <input type="hidden" name="id">
                    <div style="margin-bottom:18px;">
                        <label style="font-weight:500;color:#2d3e50;margin-bottom:6px;display:block;">部门名称 <span style="color:red">*</span></label>
                        <input type="text" name="name" required placeholder="请输入部门名称" style="width:100%;padding:8px 12px;border-radius:4px;border:1px solid #ccc;font-size:15px;">
                    </div>
                    <div style="margin-bottom:18px;">
                        <label style="font-weight:500;color:#2d3e50;margin-bottom:6px;display:block;">地区 <span style="color:red">*</span></label>
                        <input type="text" name="region" required placeholder="请输入地区" style="width:100%;padding:8px 12px;border-radius:4px;border:1px solid #ccc;font-size:15px;">
                    </div>
                    <div style="margin-bottom:18px;">
                        <label style="font-weight:500;color:#2d3e50;margin-bottom:6px;display:block;">备注</label>
                        <input type="text" name="remark" placeholder="备注" style="width:100%;padding:8px 12px;border-radius:4px;border:1px solid #ccc;font-size:15px;">
                    </div>
                    <div class="modal-actions" style="margin-top:24px;text-align:right;">
                        <button type="button" class="cancel" id="departmentDrawerCancelBtn" style="background:#6c757d;">取消</button>
                        <button type="submit" id="departmentDrawerOkBtn" style="background:#007bff;">确定</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // 统一的API请求函数，自动处理身份验证和会话过期
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                // 如果是401错误，表示会话过期，重定向到登录页
                if (response.status === 401) {
                    console.log('会话已过期，正在重定向到登录页...');
                    window.location.href = '/login.html';
                    return null;
                }
                
                // 检查响应是否成功
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            }
        }

        // 部门数据缓存
        let departmentList = [];
        let currentEditId = null;
        let currentDeleteId = null;

        // 渲染部门表格
        function renderDepartmentTable() {
            const tbody = document.getElementById('departmentTableBody');
            tbody.innerHTML = '';
            departmentList.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:center;">
                        <input type="checkbox" class="rowDepartmentCheckbox" data-id="${item.id}" style="cursor:pointer;">
                    </td>
                    <td>${idx + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.region}</td>
                    <td>${item.remark || ''}</td>
                    <td class="action-cell">
                        <button class="action-btn" onclick="showDepartmentModal(${item.id}, '${item.name}', '${item.region}', '${item.remark || ''}')">
                            <span style="display:inline-block;vertical-align:middle;">
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                    <path d="M4 13.5V16h2.5l9-9-2.5-2.5-9 9z" stroke="#007bff" stroke-width="2" fill="none"/>
                                    <path d="M13.5 6.5l2 2" stroke="#007bff" stroke-width="2" fill="none"/>
                                </svg>
                            </span>
                            编辑
                        </button>
                        <button class="action-btn delete" onclick="showDeleteDepartmentModal(${item.id}, '${item.name}')">
                            <span style="display:inline-block;vertical-align:middle;">
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                    <rect x="5" y="7" width="10" height="8" rx="2" stroke="#d9534f" stroke-width="2" fill="none"/>
                                    <path d="M7 7V5a3 3 0 0 1 6 0v2" stroke="#d9534f" stroke-width="2" fill="none"/>
                                    <line x1="8" y1="10" x2="8" y2="14" stroke="#d9534f" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="12" y1="10" x2="12" y2="14" stroke="#d9534f" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </span>
                            删除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 绑定全选
            const selectAll = document.getElementById('selectAllDepartment');
            if (selectAll) {
                selectAll.checked = false;
                selectAll.onclick = function() {
                    const checked = this.checked;
                    document.querySelectorAll('.rowDepartmentCheckbox').forEach(cb => { cb.checked = checked; });
                };
            }
            document.querySelectorAll('.rowDepartmentCheckbox').forEach(cb => {
                cb.onclick = function() {
                    const all = document.querySelectorAll('.rowDepartmentCheckbox');
                    const allChecked = Array.from(all).every(x => x.checked);
                    if (selectAll) selectAll.checked = allChecked;
                };
            });
        }

        // 统计卡片渲染
        function renderDepartmentStats() {
            document.getElementById('departmentCount').innerText = departmentList.length;
            // 地区去重统计
            const regions = Array.from(new Set(departmentList.map(x => x.region)));
            document.getElementById('regionCount').innerText = regions.length;
        }

        // 获取部门数据（后端API）
        async function fetchDepartmentList() {
            try {
                const res = await apiRequest('../api/department');
                if (res && res.code === 0 && Array.isArray(res.data)) {
                    departmentList = res.data;
                } else {
                    departmentList = [];
                }
                renderDepartmentTable();
                renderDepartmentStats();
            } catch (error) {
                console.error('获取部门列表失败:', error);
                departmentList = [];
                renderDepartmentTable();
                renderDepartmentStats();
            }
        }

        // 新增/编辑弹窗逻辑
        window.showDepartmentModal = function(id, name, region, remark) {
            currentEditId = id || null;
            document.getElementById('departmentModalTitle').innerText = id ? '编辑部门' : '新增部门';
            const form = document.getElementById('departmentForm');
            form.id.value = id || '';
            form.name.value = name || '';
            form.region.value = region || '';
            form.remark.value = remark || '';
            document.getElementById('departmentModal').classList.add('show');
        };
        document.getElementById('departmentModalCancelBtn').onclick = function() {
            document.getElementById('departmentModal').classList.remove('show');
        };
        document.getElementById('departmentModal').addEventListener('mousedown', function(e) {
            if (e.target === this) this.classList.remove('show');
        });

        // 新增/编辑提交
        document.getElementById('departmentForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = this.id.value;
            const name = this.name.value.trim();
            const region = this.region.value.trim();
            const remark = this.remark.value.trim();
            if (!name || !region) {
                alert('部门名称和地区不能为空');
                return;
            }
            const payload = { name, region, remark };
            try {
                let res;
                if (id) {
                    // 编辑
                    res = await apiRequest(`../api/department/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                } else {
                    // 新增
                    res = await apiRequest('../api/department', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                }
                if (res && res.code === 0) {
                    fetchDepartmentList();
                    document.getElementById('departmentModal').classList.remove('show');
                } else {
                    alert(id ? '编辑失败' : '新增失败');
                }
            } catch (error) {
                console.error('部门操作失败:', error);
                alert(id ? '编辑失败' : '新增失败');
            }
        };

        // 删除弹窗逻辑
        window.showDeleteDepartmentModal = function(id, name) {
            currentDeleteId = id;
            document.getElementById('deleteDepartmentModalText').innerText = `确定要删除部门：${name} 吗？`;
            document.getElementById('deleteDepartmentModal').classList.add('show');
        };
        document.getElementById('deleteDepartmentModalCancelBtn').onclick = function() {
            document.getElementById('deleteDepartmentModal').classList.remove('show');
        };
        document.getElementById('deleteDepartmentModal').addEventListener('mousedown', function(e) {
            if (e.target === this) this.classList.remove('show');
        });
        document.getElementById('deleteDepartmentModalOkBtn').onclick = async function() {
            const id = currentDeleteId;
            try {
                const res = await apiRequest(`../api/department/${id}`, { method: 'DELETE' });
                if (res && res.code === 0) {
                    fetchDepartmentList();
                    document.getElementById('deleteDepartmentModal').classList.remove('show');
                } else {
                    alert('删除失败');
                }
            } catch (error) {
                console.error('删除部门失败:', error);
                alert('删除失败');
            }
        };

        // 批量删除
        document.getElementById('batchDeleteDepartmentBtn').onclick = async function() {
            const checkedBoxes = Array.from(document.querySelectorAll('.rowDepartmentCheckbox')).filter(cb => cb.checked);
            if (checkedBoxes.length === 0) {
                alert('请先选择要删除的部门');
                return;
            }
            if (!confirm(`确定要删除选中的${checkedBoxes.length}项吗？`)) return;
            const ids = checkedBoxes.map(cb => cb.getAttribute('data-id'));
            try {
                const res = await apiRequest('../api/department/batch', {
                    method: 'POST',
                    body: JSON.stringify({ ids })
                });
                if (res && res.code === 0) {
                    fetchDepartmentList();
                } else {
                    alert('批量删除失败');
                }
            } catch (error) {
                console.error('批量删除失败:', error);
                alert('批量删除失败');
            }
        };

        // 新增/编辑抽屉弹窗逻辑
        window.showDepartmentModal = function(id, name, region, remark) {
            currentEditId = id || null;
            document.getElementById('departmentDrawerTitle').innerText = id ? '编辑部门' : '新增部门';
            const form = document.getElementById('departmentDrawerForm');
            form.id.value = id || '';
            form.name.value = name || '';
            form.region.value = region || '';
            form.remark.value = remark || '';
            // 显示抽屉
            const mask = document.getElementById('departmentDrawerMask');
            const content = document.getElementById('departmentDrawerContent');
            mask.style.display = 'block';
            content.classList.remove('active');
            setTimeout(() => {
                content.classList.add('active');
                content.style.transform = 'translateX(0)';
            }, 10);
        };
        document.getElementById('departmentDrawerCancelBtn').onclick = function() {
            hideDepartmentDrawer();
        };
        document.getElementById('departmentDrawerMask').addEventListener('mousedown', function(e) {
            if (e.target === this) hideDepartmentDrawer();
        });
        function hideDepartmentDrawer() {
            const mask = document.getElementById('departmentDrawerMask');
            const content = document.getElementById('departmentDrawerContent');
            content.classList.remove('active');
            content.style.transform = 'translateX(100%)';
            setTimeout(() => {
                mask.style.display = 'none';
                document.getElementById('departmentDrawerForm').reset();
            }, 400);
        }

        // 新增/编辑提交（抽屉表单）
        document.getElementById('departmentDrawerForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = this.id.value;
            const name = this.name.value.trim();
            const region = this.region.value.trim();
            const remark = this.remark.value.trim();
            if (!name || !region) {
                alert('部门名称和地区不能为空');
                return;
            }
            const payload = { name, region, remark };
            try {
                let res;
                if (id) {
                    // 编辑
                    res = await apiRequest(`../api/department/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });
                } else {
                    // 新增
                    res = await apiRequest('../api/department', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                }
                if (res && res.code === 0) {
                    fetchDepartmentList();
                    hideDepartmentDrawer();
                } else {
                    alert(id ? '编辑失败' : '新增失败');
                }
            } catch (error) {
                console.error('部门操作失败:', error);
                alert(id ? '编辑失败' : '新增失败');
            }
        };

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            fetchDepartmentList();
        });
    </script>
</body>
</html>
