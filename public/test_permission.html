<!DOCTYPE html>
<html>
<head>
    <title>权限测试页面</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
        .test-title { font-weight: bold; color: #333; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        .user-info { background: #e7f3ff; padding: 10px; border-radius: 4px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>账号权限测试页面</h1>
    
    <div class="user-info">
        <div class="test-title">当前登录用户信息</div>
        <div id="currentUser">加载中...</div>
    </div>
    
    <div class="test-section">
        <div class="test-title">测试账号列表API</div>
        <button onclick="testAccountsList()">测试获取账号列表</button>
        <div id="accountsResult"></div>
    </div>
    
    <div class="test-section">
        <div class="test-title">测试原始数据</div>
        <button onclick="testRawData()">获取原始账号数据</button>
        <div id="rawDataResult"></div>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            container.appendChild(resultDiv);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // 获取当前用户信息
        function getCurrentUser() {
            fetch('../api/account/me')
                .then(response => response.json())
                .then(data => {
                    const userDiv = document.getElementById('currentUser');
                    if (data.code === 0) {
                        userDiv.innerHTML = `
                            <strong>用户ID:</strong> ${data.data.id} <br>
                            <strong>用户名:</strong> ${data.data.username} <br>
                            <strong>角色:</strong> ${data.data.role} <br>
                            <strong>状态:</strong> ${data.data.status}
                        `;
                    } else {
                        userDiv.innerHTML = '<span style="color: red;">获取用户信息失败: ' + data.msg + '</span>';
                    }
                })
                .catch(error => {
                    document.getElementById('currentUser').innerHTML = '<span style="color: red;">网络错误: ' + error.message + '</span>';
                });
        }

        // 测试账号列表
        function testAccountsList() {
            clearResults('accountsResult');
            log('accountsResult', '正在获取账号列表...', 'info');
            
            fetch('../api/accounts')
                .then(response => {
                    log('accountsResult', `响应状态码: ${response.status}`, response.ok ? 'success' : 'error');
                    return response.text();
                })
                .then(text => {
                    log('accountsResult', `原始响应: <pre>${text}</pre>`, 'info');
                    
                    try {
                        const data = JSON.parse(text);
                        if (data.code === 0) {
                            log('accountsResult', `成功获取 ${data.data.length} 个账号`, 'success');
                            
                            let accountsHtml = '<table border="1" style="width:100%; margin-top:10px;"><tr><th>ID</th><th>用户名</th><th>角色</th><th>状态</th></tr>';
                            data.data.forEach(account => {
                                accountsHtml += `<tr>
                                    <td>${account.id}</td>
                                    <td>${account.username}</td>
                                    <td>${account.role}</td>
                                    <td>${account.status}</td>
                                </tr>`;
                            });
                            accountsHtml += '</table>';
                            
                            log('accountsResult', accountsHtml, 'success');
                        } else {
                            log('accountsResult', `API返回错误: ${data.msg}`, 'error');
                        }
                    } catch (e) {
                        log('accountsResult', `JSON解析错误: ${e.message}`, 'error');
                    }
                })
                .catch(error => {
                    log('accountsResult', `网络错误: ${error.message}`, 'error');
                });
        }

        // 测试原始数据
        function testRawData() {
            clearResults('rawDataResult');
            log('rawDataResult', '正在获取原始账号数据...', 'info');
            
            fetch('/test_accounts_api.php')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        log('rawDataResult', `原始数据中共有 ${data.data.length} 个账号`, 'success');
                        
                        let rawHtml = '<table border="1" style="width:100%; margin-top:10px;"><tr><th>ID</th><th>用户名</th><th>角色</th><th>状态</th></tr>';
                        data.data.forEach(account => {
                            rawHtml += `<tr>
                                <td>${account.id}</td>
                                <td>${account.username}</td>
                                <td>${account.role}</td>
                                <td>${account.status}</td>
                            </tr>`;
                        });
                        rawHtml += '</table>';
                        
                        log('rawDataResult', rawHtml, 'success');
                    } else {
                        log('rawDataResult', `获取原始数据失败: ${data.msg}`, 'error');
                    }
                })
                .catch(error => {
                    log('rawDataResult', `网络错误: ${error.message}`, 'error');
                });
        }

        // 页面加载时获取当前用户信息
        window.onload = function() {
            getCurrentUser();
        };
    </script>
</body>
</html>
