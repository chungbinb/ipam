<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>IPæ®µç®¡ç†</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            padding: 40px;
            width: 100vw;
            max-width: 100vw;
            min-width: 800px;
            margin: 0;
            box-sizing: border-box;
            flex: 1 1 auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        h1 { font-size: 2rem; color: #2d3e50; margin-bottom: 32px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; background: #fff; box-shadow: 0 2px 8px #0001; }
        th, td { border: 1px solid #e0e0e0; padding: 10px 12px; text-align: left; }
        th { background: #f4f6fa; color: #2d3e50; font-weight: 500; }
        tr:nth-child(even) { background: #f8f9fa; }
        form { margin-bottom: 20px; }
        input, select, button { margin-right: 8px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; font-size: 15px; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        button { background: #007bff; color: #fff; border: none; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        .stat-card {
            flex:1;
            background:#007bff;
            padding:24px;
            border-radius:10px;
            box-shadow:0 2px 8px #0001;
            text-align:center;
            color: #fff;
        }
        .stat-card div:first-child {
            font-size:32px;
            font-weight:bold;
            color:#fff;
        }
        .stat-card div:last-child {
            color:#fff;
            margin-top:8px;
        }
        #addModal, #deleteModal, #editModal {
            display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
            background:rgba(0,0,0,0.18); z-index:999;
        }
        #addModal.show, #deleteModal.show, #editModal.show {
            display: block;
        }
        .modal-content {
            position: absolute;
            top: 0; right: 0;
            width: 400px; height: 100vh;
            background: #fff; padding:32px 24px; border-radius:10px 0 0 10px;
            box-shadow: -2px 0 16px #0002;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.7s cubic-bezier(.4,0,.2,1);
        }
        .modal-content.active {
            transform: translateX(0);
        }
        .modal-content h3 { margin-top:0; color:#2d3e50; }
        .modal-content label { font-weight:500; color:#2d3e50; }
        .modal-content input, .modal-content select { width:100%; margin-bottom:12px; }
        .modal-actions { text-align:right; margin-top:16px; }
        .modal-actions button { margin-left:8px; }
        .danger-btn { background:#d9534f; }
        .danger-btn:hover { background:#b52a1a; }
        #deleteModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.18); z-index: 999;
        }
        #deleteModal.show {
            display: block;
        }
        #deleteModal .modal-content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            max-width: 320px;
            min-width: 260px;
            text-align: center;
            background: #fff;
            padding: 32px 24px;
            border-radius: 10px;
            box-shadow: 0 2px 16px #0002;
            height: auto !important; /* ç›´æ¥è§„å®šé«˜åº¦ä¸ºè‡ªé€‚åº”å†…å®¹ */
            max-height: 90vh;        /* æœ€å¤šä¸è¶…è¿‡è§†å£é«˜åº¦ */
            overflow-y: auto;        /* å†…å®¹è¶…å‡ºæ—¶å¯æ»šåŠ¨ */
        }
        .segment-detail-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.18); z-index: 2000;
        }
        .segment-detail-modal.show {
            display: block;
        }
        .segment-detail-content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 24px #0003;
            width: max-content;
            min-width: 700px;
            max-width: 95vw;
            max-height: 90vh;
            padding: 32px 32px 24px 32px;
            overflow-y: auto;
            transition: all 0.5s cubic-bezier(.4,0,.2,1);
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .segment-detail-content.animating {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.7);
        }
        .segment-detail-content.closing {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.7);
        }
        .segment-detail-content.fullscreen-animating {
            /* å…¨å±åˆ‡æ¢åŠ¨ç”»çŠ¶æ€ */
            transition: all 0.5s cubic-bezier(.4,0,.2,1);
        }
        .segment-detail-modal.show .segment-detail-content:not(.animating):not(.closing) {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .segment-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
        }
        .segment-detail-title {
            font-size: 22px;
            font-weight: bold;
            color: #2d3e50;
        }
        .segment-detail-actions {
            display: flex;
            gap: 8px;
        }
        .segment-detail-actions button {
            background: #eee;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 16px;
        }
        .segment-detail-actions .close-btn {
            color: #d9534f;
            font-weight: bold;
        }
        .segment-detail-actions .fullscreen-btn {
            color: #007bff;
        }
        .segment-status-label {
            display: inline-block;
            padding: 4px 14px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 500;
            margin-right: 12px;
            margin-bottom: 10px;
            color: #fff;
        }
        .status-used { background: #007bff; }
        .status-unused { background: #6c757d; }
        .status-manual { background: #ff9800; }
        .segment-ip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(38px, 38px));
            gap: 6px;
            margin: 18px 0 24px 0;
            justify-content: start;
            width: 100%;
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
        }
        
        /* å“åº”å¼å¸ƒå±€ï¼šæ ¹æ®å®¹å™¨å®½åº¦æ™ºèƒ½è°ƒæ•´ */
        @media (min-width: 1600px) {
            .segment-ip-grid {
                grid-template-columns: repeat(25, minmax(38px, 38px));
            }
        }
        
        @media (min-width: 1200px) and (max-width: 1599px) {
            .segment-ip-grid {
                grid-template-columns: repeat(20, minmax(38px, 38px));
            }
        }
        
        @media (min-width: 900px) and (max-width: 1199px) {
            .segment-detail-content {
                min-width: 600px;
            }
            .segment-ip-grid {
                grid-template-columns: repeat(15, minmax(38px, 38px));
            }
        }
        
        @media (min-width: 600px) and (max-width: 899px) {
            .segment-detail-content {
                min-width: 500px;
                max-width: 90vw;
            }
            .segment-ip-grid {
                grid-template-columns: repeat(12, minmax(38px, 38px));
            }
        }
        
        @media (max-width: 599px) {
            .segment-detail-content {
                min-width: 350px;
                max-width: 95vw;
                padding: 16px !important;
            }
            .segment-ip-grid {
                grid-template-columns: repeat(8, minmax(38px, 38px));
            }
        }
        .segment-ip-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            color: #fff;
            background: #6c757d;
            user-select: none;
            transition: all 0.2s ease;
            cursor: pointer; /* æ–°å¢ï¼šé¼ æ ‡å˜ä¸ºæ‰‹å‹ */
        }
        .segment-ip-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .segment-ip-cell:active {
            transform: scale(0.95);
        }
        .segment-ip-cell.used { background: #007bff; }
        .segment-ip-cell.manual { background: #ff9800; }
        .segment-ip-cell.unused { background: #6c757d; }
        .segment-detail-footer {
            text-align: center;
            margin-top: 18px;
        }
        .segment-detail-footer button {
            padding: 8px 32px;
            border-radius: 6px;
            background: #007bff;
            color: #fff;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        @media (max-width: 800px) {
            .segment-detail-content { width: 98vw; padding: 12px; }
        }
        .segment-detail-modal.fullscreen {
            z-index: 10000;
        }
        .segment-detail-modal.fullscreen .segment-detail-content {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: calc(100vw - 64px) !important;
            height: calc(100vh - 64px) !important;
            min-width: unset !important;
            max-width: none !important;
            max-height: none !important;
            border-radius: 12px !important;
            padding: 32px !important;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
        }
        .segment-detail-modal.fullscreen .segment-ip-grid {
            /* æ ¹æ®å¯ç”¨å®½åº¦åŠ¨æ€è®¡ç®—åˆ—æ•° */
            grid-template-columns: repeat(auto-fill, minmax(38px, 38px)) !important;
            justify-content: start;
            max-width: 100%;
            transition: grid-template-columns 0.3s ease-in-out;
        }
        
        /* å…¨å±æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .segment-detail-actions .fullscreen-btn {
            color: #007bff;
            transition: all 0.2s ease;
            font-size: 14px;
            min-width: 32px;
            text-align: center;
        }
        .segment-detail-actions .fullscreen-btn:hover {
            background: #e3f2fd;
            transform: scale(1.05);
        }
        .segment-detail-actions .fullscreen-btn:active {
            transform: scale(0.95);
        }
        .ip-tooltip {
            position: fixed;
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .ip-tooltip.show {
            opacity: 1;
        }
        
        /* æ‰«æè¿›åº¦å¼¹çª—æ ·å¼ */
        .scan-progress-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; 
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .scan-progress-modal.show {
            display: flex;
        }
        .scan-progress-content {
            background: #fff;
            border-radius: 12px;
            padding: 32px;
            min-width: 380px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center;
        }
        .scan-progress-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .scan-icon {
            font-size: 24px;
            animation: scan-rotate 2s linear infinite;
        }
        .scan-title {
            font-size: 18px;
            font-weight: 500;
            color: #2d3e50;
        }
        .scan-progress-body {
            text-align: center;
        }
        #scanProgressText {
            color: #666;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .scan-progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .scan-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 4px;
            width: 0%;
            animation: scan-progress 3s ease-in-out infinite;
        }
        @keyframes scan-rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes scan-progress {
            0% { width: 0%; }
            50% { width: 80%; }
            100% { width: 100%; }
        }
        
        /* ä¿®å¤ç¼–è¾‘IPåœ°å€å¼¹çª—æ ·å¼ */
        .modal-ip-edit {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.18);
            z-index: 3000;
        }
        .modal-ip-edit.show {
            display: block;
        }
        .modal-content-ip {
            position: absolute;
            top: 0; right: 0;
            width: 400px; height: 100vh;
            background: #fff; padding: 32px 24px; border-radius: 10px 0 0 10px;
            box-shadow: -2px 0 16px #0002;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.7s cubic-bezier(.4,0,.2,1);
        }
        .modal-content-ip.active {
            transform: translateX(0);
        }
        .modal-content-ip.closing {
            transform: translateX(100%);
        }
        .modal-content-ip h3 { margin-top: 0; color: #2d3e50; }
        .modal-content-ip label { font-weight: 500; color: #2d3e50; display: block; margin-top: 12px; }
        .modal-content-ip input, .modal-content-ip select { width: 100%; margin-bottom: 12px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; }
        .modal-content-ip .modal-actions { text-align: right; margin-top: 16px; }
        .modal-content-ip .modal-actions button { margin-left: 8px; }
        .ip-action-btn {
            background: transparent;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 4px;
            margin: 0 2px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .ip-action-btn:hover {
            background-color: #e9ecef;
            color: #0056b3;
        }
        .ip-action-btn.delete {
            color: #d9534f;
        }
        .ip-action-btn.delete:hover {
            color: #b52a1a;
            background-color: #f8d7da;
        }
        .ip-action-btn .icon {
            display: inline-flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IPæ®µç®¡ç†</h1>
        <!-- ç»Ÿè®¡æ–¹æ ¼ -->
        <div style="display:flex;gap:24px;margin-bottom:32px;">
            <div class="stat-card">
                <div id="ipRangeCount">0</div>
                <div>IPæ®µæ•°é‡</div>
            </div>
            <div class="stat-card">
                <div id="ipAddrCount">0</div>
                <div>IPåœ°å€æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div id="ipAssignedCount">0</div>
                <div>å·²åˆ†é…æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div id="ipAvailableCount">0</div>
                <div>å¯ç”¨æ•°é‡</div>
            </div>
        </div>
        <!-- æŸ¥è¯¢è¡¨å• -->
        <form id="ipRangeSearchForm" style="margin-bottom:20px;display:flex;gap:16px;flex-wrap:wrap;">
            <input type="text" name="segment" placeholder="IPæ®µ">
            <input type="text" name="business" placeholder="ä½¿ç”¨ä¸šåŠ¡">
            <input type="text" name="department" placeholder="ä½¿ç”¨éƒ¨é—¨">
            <input type="text" name="vlan" placeholder="VLAN ID">
            <button type="submit">æŸ¥è¯¢</button>
        </form>
        <!-- åˆ—è¡¨æ“ä½œæŒ‰é’® -->
        <div style="margin-bottom:12px;">
            <button id="addIpRangeBtn">æ–°å¢</button>
            <button id="importIpRangeBtn" disabled style="background:#e0e0e0;color:#aaa;cursor:not-allowed;">å¯¼å…¥</button>
        </div>
        <!-- æ–°å¢å¼¹çª— -->
        <div id="addModal">
            <div class="modal-content">
                <h3>æ–°å¢IPæ®µ</h3>
                <form id="addIpRangeForm">
                    <label>IPæ®µ <span style="color:red">*</span></label>
                    <input type="text" name="segment" required placeholder="æ ¼å¼ï¼š192.168.0">
                    <label>IPæ©ç  <span style="color:red">*</span></label>
                    <select name="mask" id="maskSelect" required></select>
                    <label>ä½¿ç”¨ä¸šåŠ¡</label>
                    <input type="text" name="business">
                    <label>ä½¿ç”¨éƒ¨é—¨</label>
                    <input type="text" name="department">
                    <label>æœªä½¿ç”¨IPæƒ…å†µ</label>
                    <input type="text" name="unused">
                    <label>VLAN ID</label>
                    <input type="text" name="vlan">
                    <label>ç½‘æ®µæ ‡è¯†</label>
                    <input type="text" name="tag">
                    <label>å¤‡æ³¨</label>
                    <input type="text" name="remark">
                    <div class="modal-actions">
                        <button type="button" id="cancelAddBtn" style="background:#6c757d;">å–æ¶ˆ</button>
                        <button type="submit">æäº¤</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- é¡µé¢å¼¹çª— -->
        <div id="deleteModal">
            <div class="modal-content" style="max-width:320px;text-align:center;">
                <div style="font-size:18px;margin-bottom:24px;display:flex;align-items:center;justify-content:center;gap:8px;">
                    <span style="font-size:24px;color:#ffc107;">&#9888;</span>
                    <span style="color:#d9534f;">ç¡®å®šè¦åˆ é™¤è¯¥IPæ®µå—ï¼Ÿ</span>
                </div>
                <div class="modal-actions" style="text-align:center;display:flex;justify-content:center;gap:16px;margin-top:16px;">
                    <button id="cancelDeleteBtn" style="background:#6c757d;">å–æ¶ˆ</button>
                    <button id="confirmDeleteBtn" class="danger-btn">åˆ é™¤</button>
                </div>
            </div>
        </div>
        <!-- ç¼–è¾‘å¼¹çª— -->
        <div id="editModal">
            <div class="modal-content">
                <h3>ç¼–è¾‘IPæ®µ</h3>
                <form id="editIpRangeForm">
                    <input type="hidden" name="id">
                    <label>IPæ®µ</label>
                    <input type="text" name="segment" readonly>
                    <label>IPæ©ç </label>
                    <input type="text" name="mask" readonly>
                    <label>ä½¿ç”¨ä¸šåŠ¡</label>
                    <input type="text" name="business">
                    <label>ä½¿ç”¨éƒ¨é—¨</label>
                    <input type="text" name="department">
                    <label>æœªä½¿ç”¨IPæƒ…å†µ</label>
                    <input type="text" name="unused">
                    <label>VLAN ID</label>
                    <input type="text" name="vlan">
                    <label>ç½‘æ®µæ ‡è¯†</label>
                    <input type="text" name="tag">
                    <label>å¤‡æ³¨</label>
                    <input type="text" name="remark">
                    <div class="modal-actions">
                        <button type="button" id="cancelEditBtn" style="background:#6c757d;">å–æ¶ˆ</button>
                        <button type="submit">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- IPæ®µè¯¦æƒ…å¼¹çª— -->
        <div id="segmentDetailModal" class="segment-detail-modal">
            <div class="segment-detail-content">
                <div class="segment-detail-header">
                    <span class="segment-detail-title" id="segmentDetailTitle"></span>
                    <div class="segment-detail-actions">
                        <button class="fullscreen-btn" id="segmentDetailFullscreenBtn" title="å…¨å±">â›¶</button>
                        <button class="close-btn" id="segmentDetailCloseBtn" title="å…³é—­">âœ–</button>
                    </div>
                </div>
                <div id="segmentDetailStatus"></div>
                <div id="segmentIpGrid" class="segment-ip-grid"></div>
                <div class="segment-detail-footer">
                    <button id="segmentDetailFooterCloseBtn">å…³é—­</button>
                </div>
            </div>
        </div>
        <!-- IPæ ¼å­æ‚¬æµ®æç¤º -->
        <div id="ipTooltip" class="ip-tooltip"></div>
        
        <!-- æ‰«æè¿›åº¦å¼¹çª— -->
        <div id="scanProgressModal" class="scan-progress-modal">
            <div class="scan-progress-content">
                <div class="scan-progress-header">
                    <span class="scan-icon">ğŸ”</span>
                    <span class="scan-title">æ­£åœ¨æ‰«æIPæ®µ</span>
                </div>
                <div class="scan-progress-body">
                    <div id="scanProgressText">æ­£åœ¨æ‰«æä¸­ï¼Œè¯·ç¨å€™...</div>
                    <div class="scan-progress-bar">
                        <div class="scan-progress-fill"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- IPæ®µåˆ—è¡¨ -->
        <div class="table-scroll-x">
            <div class="table-scroll-y" id="ipSegmentTableScrollY">
                <table class="ip-segment-table" id="ipSegmentTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>IPæ®µ</th>
                            <th>ä½¿ç”¨ä¸šåŠ¡</th>
                            <th>ä½¿ç”¨éƒ¨é—¨</th>
                            <th>æœªä½¿ç”¨IPæƒ…å†µ</th>
                            <th>IPæ©ç </th>
                            <th>VLAN ID</th>
                            <th>ç½‘æ®µæ ‡è¯†</th>
                            <th>å¤‡æ³¨</th>
                            <th style="min-width:160px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="ipRangeTableBody">
                        <!-- æ•°æ®è¡Œç”±JSæ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- åˆ†é¡µæ§ä»¶ -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin:16px 0;">
            <div>
                æ¯é¡µ
                <select id="pageSizeSelect" style="padding:4px 12px;">
                    <option value="10">10è¡Œ</option>
                    <option value="20">20è¡Œ</option>
                    <option value="50">50è¡Œ</option>
                </select>
            </div>
            <div id="paginationBar" class="pagination-bar"></div>
        </div>
        <!-- ç¼–è¾‘IPåœ°å€å¼¹çª—ï¼ˆç¡®ä¿åœ¨bodyæœ«å°¾ï¼‰ -->
        <div id="editIpModal" class="modal-ip-edit">
            <div class="modal-content-ip">
                <h3>ç¼–è¾‘IPåœ°å€</h3>
                <form id="editIpForm">
                    <input type="hidden" name="id">
                    <label>IPåœ°å€</label>
                    <input type="text" name="ip" readonly>
                    <label>MACåœ°å€</label>
                    <input type="text" name="mac">
                    <label>ä¸»æœºå</label>
                    <input type="text" name="hostname">
                    <label>ä½¿ç”¨ä¸šåŠ¡</label>
                    <input type="text" name="business">
                    <label>ä½¿ç”¨éƒ¨é—¨</label>
                    <input type="text" name="department">
                    <label>ä½¿ç”¨äºº</label>
                    <input type="text" name="user">
                    <label>èµ„äº§ç¼–å·</label>
                    <input type="text" name="asset_number">
                    <label>æ‰‹åŠ¨æ ‡è®°</label>
                    <select name="manual">
                        <option value="">æ— </option>
                        <option value="å·²åˆ†é…">å·²åˆ†é…</option>
                        <option value="ä½¿ç”¨ä¸­">ä½¿ç”¨ä¸­</option>
                        <option value="æœªä½¿ç”¨">æœªä½¿ç”¨</option>
                        <option value="ä¸å¯ç”¨">ä¸å¯ç”¨</option>
                        <option value="æœªçŸ¥">æœªçŸ¥</option>
                    </select>
                    <label>å¤‡æ³¨</label>
                    <input type="text" name="remark">
                    <div class="modal-actions">
                        <button type="button" id="cancelEditIpBtn" style="background:#6c757d;">å–æ¶ˆ</button>
                        <button type="submit">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- æ–°å¢æˆåŠŸå¼¹çª— -->
        <div id="successModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:2000;">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:40px 60px;border-radius:12px;box-shadow:0 2px 16px #0002;text-align:center;">
                <div style="font-size:22px;color:#43ea7c;margin-bottom:18px;">æ–°å¢æˆåŠŸ</div>
                <button id="successModalCloseBtn" style="padding:8px 32px;border-radius:6px;background:#007bff;color:#fff;border:none;font-size:16px;cursor:pointer;">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <script>
        // ç»Ÿä¸€çš„APIè¯·æ±‚å‡½æ•°ï¼Œè‡ªåŠ¨å¤„ç†èº«ä»½éªŒè¯å’Œä¼šè¯è¿‡æœŸ
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                // å¦‚æœæ˜¯401é”™è¯¯ï¼Œè¡¨ç¤ºä¼šè¯è¿‡æœŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                if (response.status === 401) {
                    console.log('ä¼šè¯å·²è¿‡æœŸï¼Œæ­£åœ¨é‡å®šå‘åˆ°ç™»å½•é¡µ...');
                    window.location.href = '/login.html';
                    return null;
                }
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }

        // é¡µé¢åŠ è½½æ—¶ä»åç«¯è·å–æ•°æ®
        let ipRangeList = [];
        let ipAddrList = [];

        async function fetchIpAddrsForStats() {
            try {
                const data = await apiRequest('../api/ip-addresses');
                ipAddrList = Array.isArray(data) ? data : [];
                // æŸ¥æ‰¾æ‰‹åŠ¨æ ‡è®°çš„IP
                const manualIps = ipAddrList.filter(ip => ip.manual !== null && ip.manual !== undefined && ip.manual !== '');
            } catch (error) {
                console.error('è·å–IPåœ°å€åˆ—è¡¨å¤±è´¥:', error);
                ipAddrList = [];
            }
        }

        function renderIpRangeStats() {
            const totalSegments = ipRangeList.length;
            const totalIps = ipAddrList.length;
            let assigned = 0;
            let available = 0;

            ipAddrList.forEach(item => {
                // ä¿®å¤ï¼šæ­£ç¡®å¤„ç† manual å­—æ®µçš„ null å€¼ 
                if ((item.manual !== null && item.manual !== undefined && item.manual !== '') || (item.status && item.status.includes('åˆ†é…'))) {
                    assigned++;
                } else {
                    available++;
                }
            });

            document.getElementById('ipRangeCount').innerText = totalSegments;
            document.getElementById('ipAddrCount').innerText = totalIps;
            document.getElementById('ipAssignedCount').innerText = assigned;
            document.getElementById('ipAvailableCount').innerText = available;
        }

        async function fetchIpRanges() {
            try {
                const data = await apiRequest('../api/ip-segments');
                ipRangeList = Array.isArray(data) ? data : [];
                // å…ˆè·å–IPåœ°å€æ•°æ®å†æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
                await fetchIpAddrsForStats();
                renderIpRangeStats();
                renderIpRangeTable(ipRangeList);
            } catch (error) {
                console.error('è·å–IPæ®µåˆ—è¡¨å¤±è´¥:', error);
                ipRangeList = [];
                ipAddrList = [];
                renderIpRangeStats();
                renderIpRangeTable(ipRangeList);
            }
        }
        

        // åˆ é™¤å¼¹çª—ç›¸å…³å˜é‡
        let pendingDeleteId = null;

        function showDeleteModal(id) {
            pendingDeleteId = id;
            const modal = document.getElementById('deleteModal');
            const content = modal.querySelector('.modal-content');
            modal.classList.add('show');
            // å±…ä¸­åŠ¨ç”»
            setTimeout(() => {
                content.classList.add('active');
            }, 10);
        }

        function hideDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const content = modal.querySelector('.modal-content');
            content.classList.remove('active');
            setTimeout(() => {
                modal.classList.remove('show');
            }, 400);
            pendingDeleteId = null;
        }

        document.getElementById('cancelDeleteBtn').onclick = hideDeleteModal;
        document.getElementById('deleteModal').addEventListener('mousedown', function(e) {
            if (e.target === this) hideDeleteModal();
        });
        document.getElementById('confirmDeleteBtn').onclick = async function() {
            if (!pendingDeleteId) return;
            try {
                const result = await apiRequest('../api/ip-segments/' + pendingDeleteId, { method: 'DELETE' });
                hideDeleteModal();
                pendingDeleteId = null;
                if (result && result.success) {
                    fetchIpRanges();
                } else {
                    alert(result.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤IPæ®µå¤±è´¥:', error);
                hideDeleteModal();
                pendingDeleteId = null;
                alert('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥');
            }
        };

        // æ›¿æ¢åŸæ°”æ³¡å¼¹çª—ä¸ºå±…ä¸­å¼¹çª—
        window.showDeletePopover = function(btn, id) {
            showDeleteModal(id);
        };

        // ç¼–è¾‘IPå¼¹çª—æ˜¾ç¤º/éšè—
        // å½“å‰å¼¹çª—æ‰€å±IPæ®µID
        let currentSegmentId = null;

        function showEditIpModal(ipObj) {
            const modal = document.getElementById('editIpModal');
            const content = modal.querySelector('.modal-content-ip');
            const form = document.getElementById('editIpForm');
            form.id.value = ipObj.id || '';
            form.ip.value = ipObj.ip || '';
            form.mac.value = ipObj.mac || '';
            form.hostname.value = ipObj.hostname || '';
            form.business.value = ipObj.business || '';
            form.department.value = ipObj.department || '';
            form.user.value = ipObj.user || '';
            form.manual.value = ipObj.manual || '';
            form.remark.value = ipObj.remark || '';
            form.asset_number.value = ipObj.asset_number || '';
            // è®°å½•å½“å‰IPæ®µIDï¼ˆç”¨äºåˆ·æ–°è¯¦æƒ…ï¼‰
            currentSegmentId = ipObj.segment_id || ipObj.segmentId || null;
            content.classList.remove('closing');
            modal.classList.add('show');
            
            // ç¡®ä¿ç¼–è¾‘å¼¹çª—åœ¨æœ€ä¸Šå±‚
            modal.style.zIndex = '3000';
            
            setTimeout(() => {
                content.classList.add('active');
            }, 10);
        }
        function hideEditIpModal() {
            const modal = document.getElementById('editIpModal');
            const content = modal.querySelector('.modal-content-ip');
            const form = document.getElementById('editIpForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            submitBtn.textContent = 'ä¿å­˜';
            submitBtn.disabled = false;
            submitBtn.style.background = '';
            
            content.classList.remove('active');
            content.classList.add('closing');
            setTimeout(() => {
                modal.classList.remove('show');
                content.classList.remove('closing');
            }, 500);
        }
        document.getElementById('cancelEditIpBtn').onclick = hideEditIpModal;
        document.getElementById('editIpModal').addEventListener('mousedown', function(e) {
            if (e.target === this) hideEditIpModal();
        });



        function renderIpRangeTable(list) {
            filteredList = list;
            currentPage = 1;
            renderIpRangeTablePage();
        }

        // æ¸²æŸ“IPæ®µè¡¨æ ¼ï¼ˆå¸¦åˆ†é¡µï¼‰
        let currentPage = 1;
        let pageSize = 10;
        let filteredList = [];

        function renderIpRangeTablePage() {
            const total = filteredList.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            currentPage = Math.min(currentPage, totalPages);
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, total);
            const pageData = filteredList.slice(startIdx, endIdx);

            const tbody = document.getElementById('ipRangeTableBody');
            tbody.innerHTML = '';
            pageData.forEach((item, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${startIdx + idx + 1}</td>
                    <td>${item.segment}</td>
                    <td>${item.business}</td>
                    <td>${item.department}</td>
                    <td>${item.unused}</td>
                    <td>${item.mask}</td>
                    <td>${item.vlan}</td>
                    <td>${item.tag}</td>
                    <td>${item.remark}</td>
                    <td class="ip-table-action-cell" style="white-space:nowrap;">
                        <button class="ip-action-btn" onclick="scanIp(${item.id})">
                            <span class="icon">
                                <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                    <circle cx="9" cy="9" r="7" stroke="#007bff" stroke-width="2"/>
                                    <line x1="15" y1="15" x2="19" y2="19" stroke="#007bff" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span>æ‰«æIP</span>
                    </button>
                    <button class="ip-action-btn" onclick="showIpRange(${item.id})">
                        <span class="icon">
                            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                <ellipse cx="10" cy="10" rx="7" ry="5" stroke="#007bff" stroke-width="2"/>
                                <circle cx="10" cy="10" r="2" stroke="#007bff" stroke-width="2"/>
                            </svg>
                        </span>
                        <span>æ˜¾ç¤º</span>
                    </button>
                    <button class="ip-action-btn" onclick="editIpRange(${item.id})">
                        <span class="icon">
                            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                <path d="M4 13.5V16h2.5l9-9-2.5-2.5-9 9z" stroke="#007bff" stroke-width="2" fill="none"/>
                                <path d="M13.5 6.5l2 2" stroke="#007bff" stroke-width="2" fill="none"/>
                            </svg>
                        </span>
                        <span>ç¼–è¾‘</span>
                    </button>
                    <button class="ip-action-btn delete" onclick="showDeletePopover(this,${item.id})">
                        <span class="icon">
                            <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
                                <rect x="5" y="7" width="10" height="8" rx="2" stroke="#d9534f" stroke-width="2" fill="none"/>
                                <path d="M7 7V5a3 3 0 0 1 6 0v2" stroke="#d9534f" stroke-width="2" fill="none"/>
                                <line x1="8" y1="10" x2="8" y2="14" stroke="#d9534f" stroke-width="2" stroke-linecap="round"/>
                                <line x1="12" y1="10" x2="12" y2="14" stroke="#d9534f" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span>åˆ é™¤</span>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        renderPaginationBar(totalPages);

        // æ§åˆ¶çºµå‘æ»šåŠ¨æ¡
        const scrollY = document.getElementById('ipSegmentTableScrollY');
        if (pageData.length > 10) {
            scrollY.style.maxHeight = '420px';
            scrollY.style.overflowY = 'auto';
        } else {
            scrollY.style.maxHeight = '';
            scrollY.style.overflowY = '';
        }
    }

    function renderPaginationBar(totalPages) {
        const bar = document.getElementById('paginationBar');
        const total = filteredList.length;
        if (totalPages <= 1) {
            bar.innerHTML = `å…± ${total} æ¡æ•°æ®`;
            return;
        }
        let html = `å…± ${total} æ¡æ•°æ® `;
        // é¦–é¡µ/ä¸Šä¸€é¡µ
        html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="gotoPage(1)">é¦–é¡µ</button>`;
        html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="gotoPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;

        // é¡µç åŒºå—
        let pageBtns = [];
        let maxShow = 7;
        if (totalPages <= maxShow) {
            for (let i = 1; i <= totalPages; i++) {
                pageBtns.push(i);
            }
        } else {
            if (currentPage <= 4) {
                pageBtns = [1,2,3,4,5,'...',totalPages];
            } else if (currentPage >= totalPages - 3) {
                pageBtns = [1,'...',totalPages-4,totalPages-3,totalPages-2,totalPages-1,totalPages];
            } else {
                pageBtns = [1,'...',currentPage-1,currentPage,currentPage+1,'...',totalPages];
            }
        }
        pageBtns.forEach(p => {
            if (p === '...') {
                html += `<span style="padding:0 4px;">...</span>`;
            } else {
                html += `<button class="page-btn${p===currentPage?' active':''}" onclick="gotoPage(${p})">${p}</button>`;
            }
        });

        // ä¸‹ä¸€é¡µ/æœ«é¡µ
        html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="gotoPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
        html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="gotoPage(${totalPages})">æœ«é¡µ</button>`;

        // è·³è½¬è¾“å…¥æ¡†
        html += `<span style="margin-left:8px;">è·³è‡³</span>
            <input type="number" min="1" max="${totalPages}" id="jumpPageInput" class="jump-input" value="${currentPage}">
            <button class="jump-btn" onclick="jumpToPage(${totalPages})">ç¡®å®š</button>`;

        bar.innerHTML = html;

        // ç»‘å®šè·³è½¬äº‹ä»¶
        document.getElementById('jumpPageInput').onkeydown = function(e) {
            if (e.key === 'Enter') {
                jumpToPage(totalPages);
            }
        };
    }

    window.gotoPage = function(page) {
        page = Math.max(1, Math.min(page, Math.ceil(filteredList.length / pageSize)));
        currentPage = page;
        renderIpRangeTablePage();
    };

    window.jumpToPage = function(totalPages) {
        const input = document.getElementById('jumpPageInput');
        let val = parseInt(input.value, 10);
        if (!val || val < 1 || val > totalPages) return;
        gotoPage(val);
    };

    document.getElementById('pageSizeSelect').onchange = function() {
        pageSize = parseInt(this.value, 10);
        currentPage = 1;
        renderIpRangeTablePage();
    };

    // æœç´¢è¡¨å•
    document.getElementById('ipRangeSearchForm').onsubmit = function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        let filtered = ipRangeList.filter(item => {
            return (!fd.get('segment') || item.segment.includes(fd.get('segment')))
                && (!fd.get('business') || item.business.includes(fd.get('business')))
                && (!fd.get('department') || item.department.includes(fd.get('department')))
                && (!fd.get('vlan') || item.vlan.includes(fd.get('vlan')));
        });
        renderIpRangeTable(filtered);
    };

    document.addEventListener('DOMContentLoaded', function() {
        // æ–°å¢å¼¹çª—é€»è¾‘
        document.getElementById('addIpRangeBtn').onclick = function() {
            fillMaskSelect();
            // é‡ç½®è¡¨å•å†…å®¹
            const form = document.getElementById('addIpRangeForm');
            form.reset();
            showModal('addModal');
        };
        document.getElementById('cancelAddBtn').onclick = function() {
            hideModal('addModal');
        };

        // æ–°å¢æˆåŠŸå¼¹çª—å…³é—­
        document.getElementById('successModalCloseBtn').onclick = function() {
            document.getElementById('successModal').style.display = 'none';
        };

        // ç¼–è¾‘å¼¹çª—é€»è¾‘
        document.getElementById('cancelEditBtn').onclick = function() {
            hideModal('editModal');
        };
        document.getElementById('editIpRangeForm').onsubmit = function(e) {
            e.preventDefault();
            const fd = new FormData(this);
            fetch('../api/ip-segments/' + fd.get('id'), {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    business: fd.get('business'),
                    department: fd.get('department'),
                    unused: fd.get('unused'),
                    vlan: fd.get('vlan'),
                    tag: fd.get('tag'),
                    remark: fd.get('remark')
                })
            })
            .then(res => {
                return res.json().catch(err => {
                    return res.text().then(txt => {
                        console.error('ä¿å­˜å¤±è´¥ï¼Œæ¥å£è¿”å›éJSON:', txt);
                        throw new Error('æ¥å£è¿”å›éJSON');
                    });
                });
            })
            .then(result => {
                if (result.success) {
                    alert('ä¿å­˜æˆåŠŸ');
                    hideModal('editModal');
                    fetchIpRanges();
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                    console.error('ä¿å­˜å¤±è´¥:', result);
                }
            })
            .catch(err => {
                alert('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥');
                console.error('ç½‘ç»œé”™è¯¯:', err);
            });
        };

        // é®ç½©ç‚¹å‡»å…³é—­å¼¹çª—ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
        ['addModal', 'deleteModal', 'editModal'].forEach(function(modalId) {
            const modal = document.getElementById(modalId);
            modal.addEventListener('mousedown', function(e) {
                if (e.target === modal) {
                    hideModal(modalId);
                }
            });
        });

        fetchIpRanges();
    });

    // å…¨å±€å¼¹çª—æ˜¾ç¤º/éšè—å‡½æ•°
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        const content = modal.querySelector('.modal-content');
        modal.classList.add('show');
        // è®©æµè§ˆå™¨æ¸²æŸ“åå†åŠ åŠ¨ç”»ç±»
        requestAnimationFrame(() => {
            content.classList.add('active');
        });
    }
    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        const content = modal.querySelector('.modal-content');
        content.classList.remove('active');
        // åŠ¨ç”»ç»“æŸåå†éšè—çˆ¶å®¹å™¨
        setTimeout(() => {
            modal.classList.remove('show');
        }, 700);
    }

    // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
    ['addModal', 'deleteModal', 'editModal'].forEach(function(modalId) {
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById(modalId);
            modal.addEventListener('mousedown', function(e) {
                // åªåœ¨ç‚¹å‡»é®ç½©åŒºåŸŸæ—¶å…³é—­å¼¹çª—
                if (e.target === modal) {
                    hideModal(modalId);
                }
            });
        });
    });

    window.scanIp = function(id) {
        const segmentObj = ipRangeList.find(item => item.id == id);
        if (!segmentObj) {
            alert('æ‰¾ä¸åˆ°IPæ®µä¿¡æ¯');
            return;
        }
        
        if (!confirm(`ç¡®å®šè¦æ‰«æIPæ®µ ${segmentObj.segment}/${segmentObj.mask} å—ï¼Ÿ`)) {
            return;
        }
        
        // æç¤ºç”¨æˆ·åå°æ‰«æä¸­
        alert('åå°æ‰«æä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢æˆ–ç‚¹å‡»â€œæ˜¾ç¤ºâ€æŸ¥çœ‹æœ€æ–°çŠ¶æ€ã€‚');

        // æ–°å¢ï¼šè®°å½•æ“ä½œæ—¥å¿—
        fetch('../api/logs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                log_type: 'operation',
                level: 'info',
                message: `è¯·æ±‚æ‰«æIPæ®µ: ${segmentObj.segment}/${segmentObj.mask}`,
                context: JSON.stringify({ segment_id: id, segment: segmentObj.segment, mask: segmentObj.mask })
            })
        }).catch(err => console.error('è®°å½•æ“ä½œæ—¥å¿—å¤±è´¥:', err));

        // å¼€å§‹æ‰«æï¼Œæ— éœ€ç­‰å¾…ç»“æœ
        fetch('../api/ping-ip-segment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ segment_id: id })
        })
        .then(res => res.json())
        .then(result => {
            // å¯ä»¥åœ¨æ§åˆ¶å°è¾“å‡ºæˆåŠŸä¿¡æ¯ï¼Œä½†ä¸æ‰“æ‰°ç”¨æˆ·
            if (result.success) {
                console.log(`IPæ®µ ${segmentObj.segment} æ‰«æå®Œæˆã€‚`);
                // å¯ä»¥åœ¨è¿™é‡Œé™é»˜åˆ·æ–°æ•°æ®ï¼Œä»¥ä¾¿ç”¨æˆ·ä¸‹æ¬¡æŸ¥çœ‹æ—¶æ˜¯æ–°çš„
                fetchIpAddrsForStats().then(() => {
                    renderIpRangeStats();
                });
            } else {
                console.error(`IPæ®µ ${segmentObj.segment} æ‰«æå¤±è´¥: ${result.message}`);
            }
        })
        .catch(err => {
            console.error(`IPæ®µ ${segmentObj.segment} æ‰«æè¯·æ±‚å¤±è´¥:`, err);
        });
    };

    // ä¿®æ­£æ˜¾ç¤ºæŒ‰é’®ç»‘å®šä¸ºå¼¹çª—
    window.showIpRange = function(id) {
        // è·å–IPæ®µæ•°æ®
        const segmentObj = ipRangeList.find(item => item.id == id);
        if (!segmentObj) return;
        
        console.log('æ˜¾ç¤ºIPæ®µè¯¦æƒ…:', segmentObj.segment);
        
        // é‡æ–°è·å–æœ€æ–°çš„IPåœ°å€æ•°æ®
        fetch('../api/ip-addresses')
            .then(res => res.json())
            .then(data => {
                ipAddrList = Array.isArray(data) ? data : [];
                console.log('è·å–åˆ°æ•°æ®:', ipAddrList.length, 'æ¡');
                
                // ç»§ç»­æ‰§è¡ŒåŸæœ‰çš„æ˜¾ç¤ºé€»è¾‘
                showIpRangeDetails(segmentObj);
            })
            .catch(err => {
                console.error('è·å–IPåœ°å€æ•°æ®å¤±è´¥:', err);
                ipAddrList = [];
                showIpRangeDetails(segmentObj);
            });
    };
    
    function showIpRangeDetails(segmentObj) {
        
        // æ ‡é¢˜
        document.getElementById('segmentDetailTitle').innerText = `IPæ®µè¯¦æƒ…ï¼š${segmentObj.segment}${segmentObj.mask ? '/' + segmentObj.mask : ''}`;
        // çŠ¶æ€æ ‡ç­¾
        let statusHtml = '';
        // çŠ¶æ€æ ‡è®°ï¼šä½¿ç”¨ä¸­ã€æœªä½¿ç”¨ã€æ‰‹åŠ¨æ ‡è®°
        statusHtml += `<span class="segment-status-label status-used">ä½¿ç”¨ä¸­</span>`;
        statusHtml += `<span class="segment-status-label status-unused">æœªä½¿ç”¨</span>`;
        statusHtml += `<span class="segment-status-label status-manual">æ‰‹åŠ¨æ ‡è®°</span>`;
        document.getElementById('segmentDetailStatus').innerHTML = statusHtml;

        // è®¡ç®—IPèŒƒå›´
        let ipGridHtml = '';
        let baseIp = segmentObj.segment;
        let mask = parseInt(segmentObj.mask);
        let count = 0;
        if (baseIp && mask >= 8 && mask <= 30) {
            // åªæ”¯æŒA/B/Cæ®µ
            let ipParts = baseIp.split('.');
            if (ipParts.length === 3) {
                // åªæ”¯æŒå¦‚192.168.1
                count = Math.pow(2, 32 - mask) - 2;
                console.log(`IPæ®µ ${baseIp} å°†ç”Ÿæˆ ${count} ä¸ªIPåœ°å€`);
                
                for (let i = 1; i <= count; i++) {
                    let ip = `${ipParts[0]}.${ipParts[1]}.${ipParts[2]}.${i}`;
                    // æŸ¥æ‰¾IPåœ°å€çŠ¶æ€ - ä¼˜å…ˆé€‰æ‹©æœ‰manualæ ‡è®°çš„è®°å½•
                    let ipObjs = ipAddrList.filter(addr => addr.ip === ip);
                    let ipObj = null;
                    
                    if (ipObjs.length > 0) {
                        // å¦‚æœæœ‰å¤šä¸ªè®°å½•ï¼Œä¼˜å…ˆé€‰æ‹©æœ‰manualæ ‡è®°çš„
                        ipObj = ipObjs.find(obj => obj.manual !== null && obj.manual !== undefined && obj.manual !== '') || ipObjs[0];
                    }
                    
                    let cellClass = 'unused';
                    let hostname = '';
                    let user = '';
                    if (ipObj) {
                        hostname = ipObj.hostname || '';
                        user = ipObj.user || '';
                        
                        // åˆ¤æ–­IPçŠ¶æ€ï¼šæ‰‹åŠ¨æ ‡è®°ä¼˜å…ˆï¼Œç„¶åæ˜¯pingçŠ¶æ€ï¼Œæœ€åæ˜¯å…¶ä»–çŠ¶æ€
                        if (ipObj.manual !== null && ipObj.manual !== undefined && ipObj.manual !== '') {
                            cellClass = 'manual'; // æ©™è‰²ï¼šæ‰‹åŠ¨æ ‡è®°
                        } else if (ipObj.ping === 'é€š' || ipObj.status === 'ä½¿ç”¨ä¸­') {
                            cellClass = 'used'; // è“è‰²ï¼špingé€šæˆ–ä½¿ç”¨ä¸­
                        } else if (ipObj.status && ipObj.status.includes('åˆ†é…')) {
                            cellClass = 'used'; // è“è‰²ï¼šå·²åˆ†é…
                        }
                    }
                    // å¢åŠ  data-ipã€data-hostnameã€data-user å±æ€§
                    ipGridHtml += `<div class="segment-ip-cell ${cellClass}" data-ip="${ip}" data-hostname="${hostname}" data-user="${user}" data-idx="${i}">${i}</div>`;
                }
            }
        }
        document.getElementById('segmentIpGrid').innerHTML = ipGridHtml;

        // ç»‘å®šé¼ æ ‡æ‚¬åœå’Œç‚¹å‡»äº‹ä»¶
        const grid = document.getElementById('segmentIpGrid');
        grid.querySelectorAll('.segment-ip-cell').forEach(cell => {
            cell.onmouseenter = function(e) {
                const hostname = cell.getAttribute('data-hostname');
                const user = cell.getAttribute('data-user');
                let tip = '';
                if (hostname && hostname !== '') {
                    tip += 'ä¸»æœºå: ' + hostname;
                } else {
                    tip += 'ä¸»æœºå: æœªçŸ¥';
                }
                tip += '\n';
                if (user && user !== '') {
                    tip += 'ä½¿ç”¨äºº: ' + user;
                } else {
                    tip += 'ä½¿ç”¨äºº: æœªçŸ¥';
                }
                showIpTooltip(tip, e);
            };
            cell.onmousemove = function(e) {
                const hostname = cell.getAttribute('data-hostname');
                const user = cell.getAttribute('data-user');
                let tip = '';
                if (hostname && hostname !== '') {
                    tip += 'ä¸»æœºå: ' + hostname;
                } else {
                    tip += 'ä¸»æœºå: æœªçŸ¥';
                }
                tip += '\n';
                if (user && user !== '') {
                    tip += 'ä½¿ç”¨äºº: ' + user;
                } else {
                    tip += 'ä½¿ç”¨äºº: æœªçŸ¥';
                }
                showIpTooltip(tip, e);
            };
            cell.onmouseleave = function() {
                hideIpTooltip();
            };
            cell.onclick = function() {
                const ip = cell.getAttribute('data-ip');
                // ä¼˜å…ˆé€‰æ‹©æœ‰manualæ ‡è®°çš„è®°å½•
                let ipObjs = ipAddrList.filter(addr => addr.ip === ip);
                let ipObj = null;
                
                if (ipObjs.length > 0) {
                    // å¦‚æœæœ‰å¤šä¸ªè®°å½•ï¼Œä¼˜å…ˆé€‰æ‹©æœ‰manualæ ‡è®°çš„
                    ipObj = ipObjs.find(obj => obj.manual !== null && obj.manual !== undefined && obj.manual !== '') || ipObjs[0];
                } else {
                    ipObj = {ip};
                }
                
                // ä¼ é€’ segmentId
                ipObj.segment_id = segmentObj.id;
                showEditIpModal(ipObj);
            };
        });

        // åŠ¨ç”»å¤„ç†
        const modal = document.getElementById('segmentDetailModal');
        const content = modal.querySelector('.segment-detail-content');
        content.classList.add('animating');
        modal.classList.add('show');
        modal.classList.remove('fullscreen');
        // è§¦å‘å±•å¼€åŠ¨ç”»
        setTimeout(() => {
            content.classList.remove('animating');
        }, 10); // 10msåç§»é™¤ï¼Œè§¦å‘transitionåˆ°æ­£å¸¸çŠ¶æ€
    }

    // ä¿®æ­£ç¼–è¾‘æŒ‰é’®å¼¹çª—é€»è¾‘
    window.editIpRange = function(id) {
        const ipRange = ipRangeList.find(item => item.id == id);
        if (!ipRange) return;
        const editForm = document.getElementById('editIpRangeForm');
        editForm.id.value = ipRange.id;
        editForm.segment.value = ipRange.segment;
        editForm.mask.value = ipRange.mask;
        editForm.business.value = ipRange.business || '';
        editForm.department.value = ipRange.department || '';
        editForm.unused.value = ipRange.unused || '';
        editForm.vlan.value = ipRange.vlan || '';
        editForm.tag.value = ipRange.tag || '';
        editForm.remark.value = ipRange.remark || '';
        showModal('editModal');
    };

    // åŠ¨æ€ç”Ÿæˆæ‰€æœ‰æ©ç é€‰é¡¹ï¼Œå¹¶åœ¨é¡µé¢æ¸²æŸ“åè®¾ç½®é»˜è®¤å€¼ä¸º24
    function fillMaskSelect() {
        const maskSelect = document.getElementById('maskSelect');
        maskSelect.innerHTML = '';
        let defaultValue = 24;
        for (let i = 8; i <= 30; i++) {
            const mask = (0xFFFFFFFF << (32 - i)) >>> 0;
            const ipMask = [
                (mask >>> 24) & 0xFF,
                (mask >>> 16) & 0xFF,
                (mask >>> 8) & 0xFF,
                mask & 0xFF
            ].join('.');
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = `${ipMask} (${i})`;
            maskSelect.appendChild(opt);
        }
        // ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å†è®¾ç½®é»˜è®¤å€¼ï¼Œç¡®ä¿optionå·²æ¸²æŸ“
        setTimeout(() => {
            maskSelect.value = defaultValue.toString();
            //console.log('maskSelect.value after setTimeout:', maskSelect.value);
        }, 0);
    }

    // æ–°å¢å¼¹çª—é€»è¾‘
    const addModal = document.getElementById('addModal');
    document.getElementById('addIpRangeBtn').onclick = function() {
        fillMaskSelect();
        addModal.style.display = '';
    };
    document.getElementById('cancelAddBtn').onclick = function() {
        addModal.style.display = 'none';
    };

    document.getElementById('addIpRangeForm').onsubmit = function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        const segment = fd.get('segment');
        const mask = fd.get('mask');
        // æ ¡éªŒIPæ®µæ ¼å¼
        if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(segment)) {
            alert('IPæ®µæ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºå¦‚ 192.168.0');
            return;
        }
        if (!mask) {
            alert('è¯·é€‰æ‹©IPæ©ç ');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„IPæ®µï¼ˆæ— è®ºæ©ç æ˜¯å¦ç›¸åŒï¼‰
        const existingSegment = ipRangeList.find(item => item.segment === segment);
        if (existingSegment) {
            if (existingSegment.mask == mask) {
                alert(`IPæ®µ ${segment}/${mask} å·²å­˜åœ¨ï¼Œä¸èƒ½é‡å¤æ·»åŠ `);
            } else {
                alert(`IPæ®µ ${segment} å·²å­˜åœ¨ï¼ˆæ©ç ä¸º /${existingSegment.mask}ï¼‰ï¼Œè¯·å…ˆåˆ é™¤å·²å­˜åœ¨çš„IPæ®µæ‰èƒ½æ·»åŠ ç›¸åŒIPæ®µçš„ä¸åŒæ©ç `);
            }
            return;
        }
        
        fetch('../api/ip-segments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                segment: segment,
                mask: mask,
                business: fd.get('business'),
                department: fd.get('department'),
                unused: fd.get('unused'),
                vlan: fd.get('vlan'),
                tag: fd.get('tag'),
                remark: fd.get('remark')
            })
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(txt => {
                    console.error('æ¥å£é”™è¯¯:', txt);
                    throw new Error('æ¥å£é”™è¯¯: ' + res.status);
                });
            }
            return res.json();
        })
        .then(result => {
            if (result.success) {
                // é¡µé¢å¼¹çª—æç¤º
                hideModal('addModal');
                document.getElementById('successModal').style.display = 'block';
                fetchIpRanges(); // æ–°å¢åé‡æ–°åŠ è½½æ•°æ®
            } else {
                alert(result.message || 'æ–°å¢å¤±è´¥');
            }
        })
        .catch(err => {
            alert('ç½‘ç»œé”™è¯¯ï¼Œæ–°å¢å¤±è´¥');
            console.error('ç½‘ç»œé”™è¯¯:', err);
        });
    };

    // IPæ ¼å­æ‚¬æµ®æç¤ºé€»è¾‘
    const ipTooltip = document.getElementById('ipTooltip');
    function showIpTooltip(text, evt) {
        ipTooltip.innerText = text;
        ipTooltip.classList.add('show');
        // å®šä½åˆ°é¼ æ ‡é™„è¿‘
        const x = evt.clientX + 12;
        const y = evt.clientY + 12;
        ipTooltip.style.left = x + 'px';
        ipTooltip.style.top = y + 'px';
        // æ”¯æŒå¤šè¡Œ
        ipTooltip.style.whiteSpace = 'pre-line';
    }
    function hideIpTooltip() {
        ipTooltip.classList.remove('show');
    }
    
    // æ‰«æè¿›åº¦å¼¹çª—å‡½æ•°
    function showScanProgressModal(segmentObj) {
        const modal = document.getElementById('scanProgressModal');
        const progressText = document.getElementById('scanProgressText');
        progressText.textContent = `æ­£åœ¨æ‰«æ ${segmentObj.segment}/${segmentObj.mask}ï¼Œè¯·ç¨å€™...`;
        modal.classList.add('show');
    }
    
    function hideScanProgressModal() {
        const modal = document.getElementById('scanProgressModal');
        modal.classList.remove('show');
    }

    // è·å–èµ„äº§ç¼–å·åˆ—è¡¨å¹¶æ¸²æŸ“åˆ°ä¸‹æ‹‰æ¡†
    let assetNumberList = [];
    function fetchAssetNumbers(selectedValue) {
        return fetch('../api/asset-numbers')
            .then(res => res.json())
            .then(list => {
                assetNumberList = Array.isArray(list) ? list : [];
                const select = document.getElementById('assetNumberSelect');
                select.innerHTML = '<option value="">æœªç»‘å®š</option>';
                assetNumberList.forEach(item => {
                    select.innerHTML += `<option value="${item.asset_number}">${item.asset_number}</option>`;
                });
                if (selectedValue) select.value = selectedValue;
            });
    }

    document.getElementById('editIpForm').onsubmit = function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        
        // æ·»åŠ ä¿å­˜ä¸­çš„çŠ¶æ€
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'ä¿å­˜ä¸­...';
        submitBtn.disabled = true;
        
        fetch('../api/ip-addresses/' + fd.get('id'), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mac: fd.get('mac'),
                hostname: fd.get('hostname'),
                business: fd.get('business'),
                department: fd.get('department'),
                user: fd.get('user'),
                manual: fd.get('manual'),
                remark: fd.get('remark'),
                asset_number: fd.get('asset_number')
            })
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œç„¶åè‡ªåŠ¨å…³é—­
                submitBtn.textContent = 'ä¿å­˜æˆåŠŸ âœ“';
                submitBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    hideEditIpModal();
                    fetchIpAddrsForStats().then(() => {
                        renderIpRangeStats();
                        // è‡ªåŠ¨åˆ·æ–°å½“å‰IPæ®µè¯¦æƒ…
                        if (currentSegmentId) {
                            window.showIpRange(currentSegmentId);
                        }
                    });
                }, 800);
            } else {
                alert(result.message || 'ä¿å­˜å¤±è´¥');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                submitBtn.style.background = '';
            }
        })
        .catch(() => {
            alert('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            submitBtn.style.background = '';
        });
    };

    // å…³é—­è¯¦æƒ…å¼¹çª—åŠ¨ç”»
    function hideSegmentDetailModal() {
        const modal = document.getElementById('segmentDetailModal');
        const content = modal.querySelector('.segment-detail-content');
        const fullscreenBtn = document.getElementById('segmentDetailFullscreenBtn');
        
        content.classList.add('closing');
        setTimeout(() => {
            modal.classList.remove('show');
            modal.classList.remove('fullscreen');
            content.classList.remove('closing');
            // é‡ç½®å…¨å±æŒ‰é’®
            fullscreenBtn.textContent = 'â›¶';
            fullscreenBtn.title = 'å…¨å±';
        }, 400); // åŠ¨ç”»æ—¶é•¿ä¸CSSä¸€è‡´
    }

    // å…¨å±åˆ‡æ¢
    document.getElementById('segmentDetailFullscreenBtn').onclick = function() {
        const modal = document.getElementById('segmentDetailModal');
        const content = modal.querySelector('.segment-detail-content');
        const fullscreenBtn = this;
        
        // æ·»åŠ åŠ¨ç”»ç±»
        content.classList.add('fullscreen-animating');
        
        // åˆ‡æ¢å…¨å±çŠ¶æ€
        const isFullscreen = modal.classList.contains('fullscreen');
        
        if (isFullscreen) {
            // é€€å‡ºå…¨å±
            modal.classList.remove('fullscreen');
            fullscreenBtn.textContent = 'â›¶';
            fullscreenBtn.title = 'å…¨å±';
        } else {
            // è¿›å…¥å…¨å±
            modal.classList.add('fullscreen');
            fullscreenBtn.textContent = 'ğŸ——';
            fullscreenBtn.title = 'é€€å‡ºå…¨å±';
        }
        
        // åŠ¨ç”»å®Œæˆåç§»é™¤åŠ¨ç”»ç±»
        setTimeout(() => {
            content.classList.remove('fullscreen-animating');
        }, 500); // ä¸CSSåŠ¨ç”»æ—¶é•¿ä¸€è‡´
    };
    document.getElementById('segmentDetailCloseBtn').onclick = hideSegmentDetailModal;
    document.getElementById('segmentDetailFooterCloseBtn').onclick = hideSegmentDetailModal;

    // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
    document.getElementById('segmentDetailModal').addEventListener('mousedown', function(e) {
        if (e.target === this) hideSegmentDetailModal();
    });
    </script>
</body>
</html>