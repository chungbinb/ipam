<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>日志管理</title>
    <link rel="stylesheet" type="text/css" href="../public/css/Pagestyle.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f8f9fa; }
        .container { 
            padding: 40px; 
            width: 100%;
            max-width: none;
            min-width: 800px;
            margin: 0;
            box-sizing: border-box;
        }
        .security-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .stats-container { 
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 15px; 
            margin-bottom: 30px;
            padding-bottom: 5px;
        }
        .stat-card { 
            flex: 0 0 auto;
            min-width: 120px;
            max-width: 150px;
            padding: 15px 10px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center; 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .stat-card h3 { margin: 0 0 8px 0; font-size: 12px; font-weight: 500; }
        .stat-card .number { font-size: 20px; font-weight: bold; }
        .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .btn { 
            background: #007bff; 
            border: none; 
            color: #fff; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .tabs { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 20px; }
        .tab-link { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 16px; color: #495057; }
        .tab-link.active { color: #007bff; border-bottom: 2px solid #007bff; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: #fff; 
            box-shadow: 0 2px 8px #0001; 
            table-layout: auto; 
        }
        th, td { 
            border: 1px solid #e0e0e0; 
            padding: 10px 12px; 
            text-align: left; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            vertical-align: middle;
            max-width: 200px;
        }
        th { background: #f4f6fa; font-weight: 500; }
        tbody tr:nth-child(odd) { background: #f8f9fa; }
        tbody tr:hover { background: #e3f2fd; transition: background-color 0.2s; }
        tbody tr { cursor: pointer; }
        pre { margin: 0; font-family: Consolas, monaco, monospace; font-size: 13px; }
        .level-info { color: #17a2b8; font-weight: bold; }
        .level-warning { color: #ffc107; font-weight: bold; }
        .level-error { color: #dc3545; font-weight: bold; }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container { 
                min-width: 800px; 
                padding: 20px; 
            }
            .stats-container { 
                gap: 15px; 
            }
            .stat-card {
                min-width: 130px;
                padding: 15px;
            }
        }
        
        @media (max-width: 900px) {
            .container { 
                min-width: 600px; 
                padding: 15px; 
            }
            .stats-container { 
                gap: 10px; 
            }
            .stat-card {
                min-width: 100px;
                padding: 12px;
            }
            .stat-card h3 {
                font-size: 12px;
            }
            .stat-card .number {
                font-size: 20px;
            }
            th, td { 
                padding: 8px 10px; 
                font-size: 13px; 
            }
        }
        
        @media (max-width: 768px) {
            .stats-container {
                flex-direction: column;
            }
            .stat-card {
                min-width: auto;
            }
        }
        
        /* 确保表格容器在大屏幕上也能充分利用空间 */
        .tab-content {
            width: 100%;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="font-size: 2rem; color: #2d3e50; margin-bottom: 32px;">日志管理</h1>
        
        <!-- 安全提示 -->
        <div class="security-notice" id="securityNotice" style="display: none;">
            <strong>安全提示：</strong> 检测到您正在使用HTTP协议访问系统，建议使用HTTPS协议以确保数据传输安全。
        </div>
        
        <!-- 统计信息 -->
        <div class="stats-container" id="statsContainer">
            <!-- 统计卡片将通过JavaScript动态生成 -->
        </div>
        
        <!-- 工具栏 -->
        <div class="toolbar">
            <button class="btn" onclick="refreshLogs()">刷新</button>
            <button id="cleanupBtn" class="btn danger" onclick="cleanupLogs()">清理旧日志</button>
            <button class="btn" onclick="forceRefreshStats()" style="background: #17a2b8;">强制刷新统计</button>
            <button id="clearFilterBtn" class="btn" onclick="clearFilter()" style="background: #6c757d; display: none;">清除筛选</button>
            <div id="filterInfo" style="margin-left: auto; color: #666; font-size: 14px; display: none;">
                <!-- 筛选信息将显示在这里 -->
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'operation')">操作日志</button>
            <button class="tab-link" onclick="openTab(event, 'login')">登录日志</button>
            <button class="tab-link" onclick="openTab(event, 'runtime')">运行日志</button>
        </div>

        <div id="operation" class="tab-content active">
            <table id="operationLogTable">
                <thead><tr><th>ID</th><th>级别</th><th>用户</th><th>信息</th><th>上下文</th><th>时间</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="login" class="tab-content">
            <table id="loginLogTable">
                <thead><tr><th>ID</th><th>级别</th><th>用户</th><th>信息</th><th>上下文</th><th>时间</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="runtime" class="tab-content">
            <table id="runtimeLogTable">
                <thead><tr><th>ID</th><th>级别</th><th>用户</th><th>信息</th><th>上下文</th><th>时间</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- 日志详情弹窗 -->
    <div id="logDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #2d3e50;">日志详情</h3>
                <button onclick="closeLogDetailModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div id="logDetailContent" style="padding: 20px;">
                <!-- 详细内容将通过JavaScript填充 -->
            </div>
        </div>
    </div>

    <script>
        let currentLogType = 'operation';
        let currentFilter = null; // 当前筛选条件

        /**
         * 统一的API请求函数，自动处理认证和错误
         */
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', ...options.headers }
            };

            try {
                const response = await fetch(url, { ...defaultOptions, ...options });
                if (response.status === 401) {
                    window.location.href = '../public/login.html';
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                return { code: -1, msg: '网络错误' };
            }
        }

        function openTab(evt, logType) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(logType).style.display = "block";
            evt.currentTarget.className += " active";
            currentLogType = logType;
            
            // 保持当前筛选条件，但如果是日志类型筛选则清除
            if (currentFilter && currentFilter.type === 'log_type') {
                currentFilter = null;
                clearFilterUI();
            }
            
            fetchLogs(logType, currentFilter);
        }

        async function fetchLogs(logType, filter = null) {
            let url = '../api/logs?log_type=' + logType;
            
            // 添加筛选参数
            if (filter) {
                if (filter.type === 'date') {
                    url += '&date_filter=' + filter.value;
                } else if (filter.type === 'level') {
                    url += '&level_filter=' + filter.value;
                }
            }
            
            const res = await apiRequest(url);
            if (res && res.code === 0 && Array.isArray(res.data)) {
                renderLogTable(logType, res.data, filter);
            } else if (res) {
                console.error('获取日志失败:', res);
            }
        }

        async function fetchStatistics() {
            const res = await apiRequest('../api/logs/statistics');
            if (res && res.code === 0) {
                renderStatistics(res.data);
            } else if (res) {
                console.error('获取统计数据失败:', res);
                const container = document.getElementById('statsContainer');
                container.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">获取统计数据失败: ' + (res.msg || '未知错误') + '</div>';
            }
        }

        function renderStatistics(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';

            if (!stats) {
                container.innerHTML = '<div style="color: red; text-align: center;">统计数据为空</div>';
                return;
            }

            // 今日日志
            const todayCount = stats.today || 0;
            const todayCard = createStatCard('今日日志', todayCount);
            container.appendChild(todayCard);

            // 本周日志
            const weekCount = stats.this_week || 0;
            const weekCard = createStatCard('本周日志', weekCount);
            container.appendChild(weekCard);

            // 按类型统计
            if (stats.by_type && Array.isArray(stats.by_type)) {
                stats.by_type.forEach(item => {
                    const typeNames = {
                        'operation': '操作日志',
                        'login': '登录日志',
                        'runtime': '运行日志'
                    };
                    const typeName = typeNames[item.log_type] || item.log_type;
                    const card = createStatCard(typeName, item.count);
                    container.appendChild(card);
                });
            }

            // 按级别统计
            if (stats.by_level && Array.isArray(stats.by_level)) {
                stats.by_level.forEach(item => {
                    const levelNames = {
                        'info': '信息日志',
                        'warning': '警告日志',
                        'error': '错误日志'
                    };
                    const levelName = levelNames[item.level] || item.level;
                    const card = createStatCard(levelName, item.count);
                    container.appendChild(card);
                });
            }
        }

        function createStatCard(title, number, cardType = 'default') {
            const card = document.createElement('div');
            card.className = 'stat-card';
            
            // 根据卡片类型设置不同的背景颜色和文本颜色
            let backgroundColor = '#007bff';
            let textColor = '#fff'; // 默认白色文本
            let filterType = null; // 筛选类型
            let filterValue = null; // 筛选值
            
            if (title.includes('今日')) {
                backgroundColor = '#28a745'; // 绿色背景
                textColor = '#fff'; // 白色文本
                filterType = 'date';
                filterValue = 'today';
            } else if (title.includes('本周')) {
                backgroundColor = '#17a2b8'; // 青色背景
                textColor = '#fff'; // 白色文本
                filterType = 'date';
                filterValue = 'this_week';
            } else if (title.includes('操作日志')) {
                backgroundColor = '#007bff'; // 蓝色背景
                textColor = '#fff'; // 白色文本
                filterType = 'log_type';
                filterValue = 'operation';
            } else if (title.includes('登录日志')) {
                backgroundColor = '#6610f2'; // 紫色背景
                textColor = '#fff'; // 白色文本
                filterType = 'log_type';
                filterValue = 'login';
            } else if (title.includes('运行日志')) {
                backgroundColor = '#fd7e14'; // 橙色背景
                textColor = '#fff'; // 白色文本
                filterType = 'log_type';
                filterValue = 'runtime';
            } else if (title.includes('信息日志')) {
                backgroundColor = '#17a2b8'; // 青色背景
                textColor = '#fff'; // 白色文本
                filterType = 'level';
                filterValue = 'info';
            } else if (title.includes('警告日志')) {
                backgroundColor = '#ffc107'; // 黄色背景
                textColor = '#000'; // 黑色文本（黄色背景用黑色文本更清晰）
                filterType = 'level';
                filterValue = 'warning';
            } else if (title.includes('错误日志')) {
                backgroundColor = '#dc3545'; // 红色背景
                textColor = '#fff'; // 白色文本
                filterType = 'level';
                filterValue = 'error';
            }
            
            // 设置卡片的背景色和文本颜色
            card.style.background = backgroundColor;
            card.style.color = textColor;
            card.style.cursor = 'pointer';
            card.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
            
            // 添加悬停效果
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-4px)';
                card.style.boxShadow = '0 6px 16px rgba(0,0,0,0.25)';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(-2px)';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            });
            
            // 添加点击事件进行筛选
            if (filterType && filterValue) {
                card.addEventListener('click', () => {
                    filterLogsByCard(filterType, filterValue, title);
                });
                card.title = `点击筛选${title}`;
            }
            
            card.innerHTML = `
                <h3 style="color: ${textColor}; margin: 0 0 8px 0; font-size: 12px; font-weight: 500;">${title}</h3>
                <div class="number" style="color: ${textColor}; font-size: 20px; font-weight: bold;">${number}</div>
            `;
            return card;
        }

        function renderLogTable(logType, data, filter = null) {
            const tableBody = document.querySelector(`#${logType}LogTable tbody`);
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            // 显示筛选提示
            updateFilterInfo(logType, filter, data.length);
            
            data.forEach(log => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.title = '点击查看详细信息';
                
                // 简化上下文显示
                let contextHtml = '';
                if (log.context) {
                    try {
                        const contextObj = JSON.parse(log.context);
                        contextHtml = getSimplifiedContext(logType, contextObj);
                    } catch (e) {
                        contextHtml = escapeHtml(log.context).substring(0, 50) + '...';
                    }
                } else {
                    contextHtml = '-';
                }

                // 设置级别样式
                const levelClass = `level-${log.level || 'info'}`;
                
                // 转换时间为本地时区
                const localTime = formatLocalTime(log.created_at);
                
                tr.innerHTML = `
                    <td>${log.id}</td>
                    <td><span class="${levelClass}">${log.level || ''}</td>
                    <td>${escapeHtml(log.username || 'N/A')}</td>
                    <td>${escapeHtml(log.message || '')}</td>
                    <td>${contextHtml}</td>
                    <td>${localTime}</td>
                `;
                
                // 添加点击事件查看详情
                tr.addEventListener('click', () => {
                    showLogDetail(log);
                });
                
                tableBody.appendChild(tr);
            });
        }

        // 根据日志类型简化上下文显示
        function getSimplifiedContext(logType, contextObj) {
            if (logType === 'login') {
                // 登录日志显示IP和角色信息
                let parts = [];
                if (contextObj.ip) {
                    parts.push(`<span style="color: #666;">IP: ${escapeHtml(contextObj.ip)}</span>`);
                }
                if (contextObj.role) {
                    const roleNames = {
                        'sysadmin': '系统管理员',
                        'admin': '管理员', 
                        'netadmin': '网管'
                    };
                    const roleName = roleNames[contextObj.role] || contextObj.role;
                    parts.push(`<span style="color: #007bff;">角色: ${roleName}</span>`);
                }
                if (contextObj.user_agent) {
                    const ua = contextObj.user_agent;
                    if (ua.includes('Chrome')) parts.push('<span style="color: #666;">Chrome</span>');
                    else if (ua.includes('Firefox')) parts.push('<span style="color: #666;">Firefox</span>');
                    else if (ua.includes('Safari')) parts.push('<span style="color: #666;">Safari</span>');
                    else parts.push('<span style="color: #666;">其他浏览器</span>');
                }
                return parts.length > 0 ? parts.join(' | ') : '-';
            } else if (logType === 'operation') {
                // 操作日志显示简要信息
                if (contextObj.account_id) {
                    return `<span style="color: #007bff;">账户ID: ${contextObj.account_id}</span>`;
                } else if (contextObj.id) {
                    return `<span style="color: #007bff;">ID: ${contextObj.id}</span>`;
                } else if (contextObj.ids && Array.isArray(contextObj.ids)) {
                    return `<span style="color: #007bff;">批量操作: ${contextObj.ids.length} 项</span>`;
                } else if (contextObj.count !== undefined) {
                    return `<span style="color: #28a745;">数量: ${contextObj.count}</span>`;
                } else if (contextObj.changes) {
                    const changeCount = Object.keys(contextObj.changes).length;
                    return `<span style="color: #ffc107;">修改 ${changeCount} 个字段</span>`;
                } else if (contextObj.days) {
                    return `<span style="color: #dc3545;">清理 ${contextObj.days} 天前</span>`;
                } else if (contextObj.segment_id) {
                    return `<span style="color: #17a2b8;">IP段: ${contextObj.segment_id}</span>`;
                }
            } else if (logType === 'runtime') {
                // 运行时日志显示状态和IP信息
                let parts = [];
                if (contextObj.status) {
                    const statusColors = {
                        'started': '#007bff',
                        'completed': '#28a745',
                        'failed': '#dc3545',
                        'error': '#dc3545'
                    };
                    const color = statusColors[contextObj.status] || '#28a745';
                    parts.push(`<span style="color: ${color};">状态: ${escapeHtml(contextObj.status)}</span>`);
                }
                if (contextObj.ip) {
                    parts.push(`<span style="color: #666;">IP: ${escapeHtml(contextObj.ip)}</span>`);
                }
                if (contextObj.segment_id) {
                    parts.push(`<span style="color: #17a2b8;">段ID: ${contextObj.segment_id}</span>`);
                }
                if (contextObj.error) {
                    parts.push(`<span style="color: #dc3545;">错误</span>`);
                }
                return parts.length > 0 ? parts.join(' | ') : '-';
            }
            
            // 默认情况：显示前30个字符，并用省略号
            const jsonStr = JSON.stringify(contextObj);
            if (jsonStr.length <= 30) {
                return `<span style="color: #666;">${jsonStr}</span>`;
            } else {
                return `<span style="color: #666;" title="${escapeHtml(jsonStr)}">${jsonStr.substring(0, 30)}...</span>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function refreshLogs() {
            fetchLogs(currentLogType, currentFilter);
            fetchStatistics();
        }

        /**
         * 根据统计卡片进行筛选
         */
        function filterLogsByCard(filterType, filterValue, cardTitle) {
            currentFilter = { type: filterType, value: filterValue, title: cardTitle };
            
            if (filterType === 'log_type') {
                // 如果是日志类型筛选，切换到对应的标签页
                const tabMap = {
                    'operation': 'operation',
                    'login': 'login', 
                    'runtime': 'runtime'
                };
                
                if (tabMap[filterValue] && tabMap[filterValue] !== currentLogType) {
                    // 切换标签页
                    const targetTab = document.querySelector(`[onclick*="${tabMap[filterValue]}"]`);
                    if (targetTab) {
                        openTab({ currentTarget: targetTab }, tabMap[filterValue]);
                        return; // openTab 已经会调用 fetchLogs
                    }
                }
            }
            
            // 其他类型的筛选或同标签页的日志类型筛选
            fetchLogs(currentLogType, currentFilter);
        }

        /**
         * 清除筛选
         */
        function clearFilter() {
            currentFilter = null;
            clearFilterUI();
            fetchLogs(currentLogType);
        }

        /**
         * 清除筛选UI状态
         */
        function clearFilterUI() {
            const clearBtn = document.getElementById('clearFilterBtn');
            const filterInfo = document.getElementById('filterInfo');
            
            if (clearBtn) clearBtn.style.display = 'none';
            if (filterInfo) filterInfo.style.display = 'none';
        }

        /**
         * 更新筛选信息显示
         */
        function updateFilterInfo(logType, filter, resultCount) {
            const clearBtn = document.getElementById('clearFilterBtn');
            const filterInfo = document.getElementById('filterInfo');
            
            if (!filter) {
                clearFilterUI();
                return;
            }
            
            // 显示筛选信息
            let filterText = '';
            if (filter.type === 'date') {
                const dateNames = {
                    'today': '今日',
                    'this_week': '本周'
                };
                filterText = `筛选：${dateNames[filter.value] || filter.value}`;
            } else if (filter.type === 'level') {
                const levelNames = {
                    'info': '信息级别',
                    'warning': '警告级别',
                    'error': '错误级别'
                };
                filterText = `筛选：${levelNames[filter.value] || filter.value}`;
            } else if (filter.type === 'log_type') {
                // 日志类型筛选通过标签页体现，不需要额外显示
                clearFilterUI();
                return;
            }
            
            if (filterText) {
                filterInfo.textContent = `${filterText} (${resultCount} 条结果)`;
                filterInfo.style.display = 'block';
                clearBtn.style.display = 'inline-block';
            }
        }

        async function cleanupLogs() {
            // 首先检查用户是否有权限
            const data = await apiRequest('../api/auth/check');
            if (!data || data.code !== 0 || !data.data.logged_in) {
                alert('请先登录');
                return;
            }
            
            const user = data.data.user;
            if (user.role !== 'sysadmin' && user.role !== 'admin') {
                alert('权限不足，只有管理员以上权限才能清理日志');
                return;
            }
            
            // 有权限则继续执行清理操作
            if (!confirm('确定要清理30天前的旧日志吗？此操作不可恢复。')) {
                return;
            }

            const res = await apiRequest('../api/logs/cleanup?days=30', { 
                method: 'POST'
            });
            if (res && res.code === 0) {
                alert(res.msg);
                refreshLogs();
            } else if (res) {
                alert('清理失败：' + (res.msg || '未知错误'));
            }
        }

        /**
         * 测试LogService功能
         */
        /**
         * 强制刷新统计数据
         */
        async function forceRefreshStats() {
            console.log('强制刷新统计数据...');
            const container = document.getElementById('statsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在刷新统计数据...</div>';
            
            // 清除可能的缓存
            const res = await apiRequest('../api/logs/statistics?_t=' + Date.now(), {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            console.log('强制刷新统计结果:', res);
            if (res && res.code === 0) {
                renderStatistics(res.data);
            } else if (res) {
                container.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">强制刷新失败: ' + (res.msg || '未知错误') + '</div>';
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查协议安全性
            if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('securityNotice').style.display = 'block';
            }
            
            // 获取当前用户信息并设置权限
            checkUserPermissions();
            
            // 获取统计数据
            fetchStatistics();
            
            // 直接加载默认的操作日志数据
            fetchLogs('operation');
            
            // 每30秒自动刷新统计信息
            setInterval(fetchStatistics, 30000);
        });

        // 检查用户权限
        async function checkUserPermissions() {
            const data = await apiRequest('../api/auth/check');
            if (data && data.code === 0 && data.data.logged_in) {
                const user = data.data.user;
                // 只有管理员以上权限（sysadmin, admin）才能看到清理按钮
                // 网管（netadmin）不能清理日志
                const canCleanup = user.role === 'sysadmin' || user.role === 'admin';
                const cleanupBtn = document.getElementById('cleanupBtn');
                if (cleanupBtn) {
                    cleanupBtn.style.display = canCleanup ? 'inline-block' : 'none';
                }
            } else if (data) {
                // 未登录或获取用户信息失败，隐藏清理按钮
                const cleanupBtn = document.getElementById('cleanupBtn');
                if (cleanupBtn) {
                    cleanupBtn.style.display = 'none';
                }
            }
        }

        // 显示日志详情弹窗
        function showLogDetail(log) {
            const modal = document.getElementById('logDetailModal');
            const content = document.getElementById('logDetailContent');
            
            // 格式化上下文数据
            let contextHtml = '';
            if (log.context) {
                try {
                    const contextObj = JSON.parse(log.context);
                    contextHtml = `<pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-break: break-word;">${JSON.stringify(contextObj, null, 2)}</pre>`;
                } catch (e) {
                    contextHtml = `<div style="background: #f8f9fa; padding: 15px; border-radius: 4px;">${escapeHtml(log.context)}</div>`;
                }
            } else {
                contextHtml = '<div style="color: #666; font-style: italic;">无上下文信息</div>';
            }

            // 级别颜色
            const levelColors = {
                'info': '#17a2b8',
                'warning': '#ffc107',
                'error': '#dc3545'
            };
            const levelColor = levelColors[log.level] || '#17a2b8';
            
            // 转换时间为本地时区并显示详细信息
            const localTime = formatLocalTime(log.created_at);
            const timeZoneInfo = getTimeZoneInfo();

            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <strong>ID:</strong>
                        <span>${log.id}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <strong>级别:</strong>
                        <span style="color: ${levelColor}; font-weight: bold;">${log.level || 'info'}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <strong>用户:</strong>
                        <span>${escapeHtml(log.username || 'N/A')}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <strong>时间:</strong>
                        <span>${localTime} <small style="color: #666;">(${timeZoneInfo})</small></span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>信息:</strong>
                        <div style="margin-top: 5px; background: #f8f9fa; padding: 10px; border-radius: 4px;">${escapeHtml(log.message || '')}</div>
                    </div>
                    <div>
                        <strong>上下文:</strong>
                        <div style="margin-top: 5px;">${contextHtml}</div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // 关闭日志详情弹窗
        function closeLogDetailModal() {
            const modal = document.getElementById('logDetailModal');
            modal.style.display = 'none';
        }

        // 点击弹窗外部区域关闭弹窗
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('logDetailModal');
            if (event.target === modal) {
                closeLogDetailModal();
            }
        });

        // 按ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('logDetailModal');
                if (modal.style.display === 'block') {
                    closeLogDetailModal();
                }
            }
        });

        /**
         * 将UTC时间转换为本地时区时间
         * @param {string} utcTimeString - UTC时间字符串 (YYYY-MM-DD HH:mm:ss)
         * @returns {string} 本地时区时间字符串
         */
        function formatLocalTime(utcTimeString) {
            if (!utcTimeString) return '';
            
            try {
                // 将数据库时间字符串转换为Date对象
                // 假设数据库存储的是UTC时间
                const utcDate = new Date(utcTimeString + ' UTC');
                
                // 如果转换失败，尝试直接解析
                if (isNaN(utcDate.getTime())) {
                    const directDate = new Date(utcTimeString);
                    if (isNaN(directDate.getTime())) {
                        return utcTimeString; // 如果都失败了，返回原始字符串
                    }
                    return directDate.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                }
                
                // 转换为本地时间字符串
                return utcDate.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (error) {
                console.error('时间转换错误:', error, '原始时间:', utcTimeString);
                return utcTimeString;
            }
        }
        
        /**
         * 获取当前时区信息
         * @returns {string} 时区信息字符串
         */
        function getTimeZoneInfo() {
            try {
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const offset = -new Date().getTimezoneOffset() / 60;
                const offsetStr = offset >= 0 ? `+${offset}` : `${offset}`;
                return `${timeZone} UTC${offsetStr}`;
            } catch (error) {
                // 如果Intl API不可用，使用简单的偏移计算
                const offset = -new Date().getTimezoneOffset() / 60;
                const offsetStr = offset >= 0 ? `+${offset}` : `${offset}`;
                return `UTC${offsetStr}`;
            }
        }
    </script>
</body>
</html>