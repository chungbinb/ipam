<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>IT资产管理系统 - 手机版</title>
    <!-- 专用QuaggaJS条码扫描库 - 专注Code 128检测 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* 头部区域 */
        .search-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            max-width: 480px;
            margin: 0 auto;
        }

        .search-box {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 12px 16px;
            font-size: 16px;
            background: transparent;
            color: #333;
        }

        .search-input::placeholder {
            color: #999;
        }

        .search-btn {
            background: #667eea;
            border: none;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .search-btn:hover {
            background: #5a67d8;
        }

        .scan-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* 搜索结果区域 */
        .search-results {
            margin-top: 20px;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .search-results-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .clear-search-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-search-btn:hover {
            background: #c53030;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-result-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .search-result-type {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .search-result-id {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .search-result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .search-result-detail {
            font-size: 13px;
            color: #666;
        }

        .search-result-detail strong {
            color: #333;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* 主要内容区域 */
        .container {
            padding: 30px 20px;
            max-width: 480px;
            margin: 0 auto;
        }

        /* 功能卡片网格 */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 12px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            position: relative;
            z-index: 1;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .feature-desc {
            font-size: 12px;
            color: #718096;
            line-height: 1.4;
            position: relative;
            z-index: 1;
        }

        /* 快速统计区域 */
        .stats-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
        }

        /* 访问提示 */
        .access-tip {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .tip-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .tip-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tip-content {
            font-size: 14px;
            color: #718096;
            line-height: 1.6;
        }

        /* 加载动画 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 响应式调整 */
        @media (max-width: 375px) {
            .container {
                padding: 20px 15px;
            }
            
            .feature-grid {
                gap: 15px;
            }
            
            .feature-card {
                padding: 20px 15px;
            }
            
            .title {
                font-size: 22px;
            }
        }

        /* 暗黑模式适配 */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            }
            
            .search-header, .feature-card, .stats-section, .access-tip, .search-result-item {
                background: rgba(45, 55, 72, 0.9);
                color: #e2e8f0;
            }
            
            .search-box {
                background: #2d3748;
                border-color: #667eea;
            }
            
            .search-input {
                color: #e2e8f0;
            }
            
            .search-input::placeholder {
                color: #a0aec0;
            }
            
            .title, .feature-title, .stats-title, .tip-title, .search-results-header h3, .search-result-id {
                color: #e2e8f0;
            }
            
            .subtitle, .feature-desc, .stat-label, .tip-content, .search-result-detail {
                color: #a0aec0;
            }
        }
    </style>
</head>
<body>
    <!-- 头部搜索区域 -->
    <div class="search-header">
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="搜索资产编号、名称、部门..." class="search-input">
                <button onclick="performSearch()" class="search-btn">🔍</button>
            </div>
            <button onclick="startScan()" class="scan-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
                    <!-- 左上角 -->
                    <path d="M3 3H9V5H5V9H3V3Z" fill="currentColor"/>
                    <!-- 右上角 -->
                    <path d="M21 3V9H19V5H15V3H21Z" fill="currentColor"/>
                    <!-- 左下角 -->
                    <path d="M3 21V15H5V19H9V21H3Z" fill="currentColor"/>
                    <!-- 右下角 -->
                    <path d="M21 21H15V19H19V15H21V21Z" fill="currentColor"/>
                    <!-- 中央水平扫描线 -->
                    <path d="M6 12H18V12.5H6V12Z" fill="currentColor" opacity="0.8"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 主要内容 -->
    <div class="container">
        <!-- 快速统计 -->
        <div class="stats-section" id="statsSection">
            <div class="stats-title">📊 资产概览</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="hostCount">-</div>
                    <div class="stat-label">主机设备</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="laptopCount">-</div>
                    <div class="stat-label">笔记本</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="monitorCount">-</div>
                    <div class="stat-label">显示器</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="printerCount">-</div>
                    <div class="stat-label">打印机</div>
                </div>
            </div>
        </div>

        <!-- 功能模块 -->
        <div class="feature-grid" id="featureGrid">
            <div class="feature-card" onclick="openModule('consumable')">
                <div class="feature-icon">📦</div>
                <div class="feature-title">耗材管理</div>
                <div class="feature-desc">管理办公耗材库存</div>
            </div>
            
            <div class="feature-card" onclick="openModule('host')">
                <div class="feature-icon">🖥️</div>
                <div class="feature-title">主机管理</div>
                <div class="feature-desc">管理台式主机设备</div>
            </div>
            
            <div class="feature-card" onclick="openModule('laptop')">
                <div class="feature-icon">💻</div>
                <div class="feature-title">笔记本</div>
                <div class="feature-desc">管理便携设备</div>
            </div>
            
            <div class="feature-card" onclick="openModule('monitor')">
                <div class="feature-icon">📺</div>
                <div class="feature-title">显示器</div>
                <div class="feature-desc">管理显示设备</div>
            </div>
            
            <div class="feature-card" onclick="openModule('printer')">
                <div class="feature-icon">🖨️</div>
                <div class="feature-title">打印机</div>
                <div class="feature-desc">管理打印设备</div>
            </div>
            
            <div class="feature-card" onclick="openModule('ip')">
                <div class="feature-icon">🌐</div>
                <div class="feature-title">IP段管理</div>
                <div class="feature-desc">网络地址段管理</div>
            </div>
            
            <div class="feature-card" onclick="openModule('log')">
                <div class="feature-icon">📝</div>
                <div class="feature-title">操作日志</div>
                <div class="feature-desc">查看系统日志</div>
            </div>
            
            <div class="feature-card" onclick="openModule('account')">
                <div class="feature-icon">👤</div>
                <div class="feature-title">账号设置</div>
                <div class="feature-desc">个人信息管理</div>
            </div>
        </div>

        <!-- 搜索结果区域 -->
        <div class="search-results" id="searchResults" style="display: none;">
            <div class="search-results-header">
                <h3 id="searchResultsTitle">搜索结果</h3>
                <button onclick="clearSearch()" class="clear-search-btn">✕ 清除</button>
            </div>
            <div class="search-results-list" id="searchResultsList">
                <!-- 搜索结果将在这里动态生成 -->
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>正在加载...</div>
        </div>
    </div>



    <!-- 扫码模态框 -->
    <div id="scanModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000;">
        <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;">
            <!-- 扫码头部 -->
            <div style="background: rgba(255,255,255,0.1); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: white; margin: 0; font-size: 18px;">📷 扫描资产编号</h3>
                <button onclick="closeScan()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
            </div>
            
            <!-- 摄像头预览区域 -->
            <div style="flex: 1; position: relative; overflow: hidden;">
                <video id="scanVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                
                <!-- 条码检测框容器 -->
                <div id="barcodeDetectionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
                
                <!-- Code 128条码扫描框 - 长横条样式 -->
                <div id="barcodeFrame" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 120px; border: 2px solid #00ff88; border-radius: 8px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.6);">
                    <!-- 顶部左右角标 -->
                    <div style="position: absolute; top: -3px; left: -3px; width: 25px; height: 25px; border-top: 4px solid #00ff88; border-left: 4px solid #00ff88; border-radius: 4px 0 0 0;"></div>
                    <div style="position: absolute; top: -3px; right: -3px; width: 25px; height: 25px; border-top: 4px solid #00ff88; border-right: 4px solid #00ff88; border-radius: 0 4px 0 0;"></div>
                    <!-- 底部左右角标 -->
                    <div style="position: absolute; bottom: -3px; left: -3px; width: 25px; height: 25px; border-bottom: 4px solid #00ff88; border-left: 4px solid #00ff88; border-radius: 0 0 0 4px;"></div>
                    <div style="position: absolute; bottom: -3px; right: -3px; width: 25px; height: 25px; border-bottom: 4px solid #00ff88; border-right: 4px solid #00ff88; border-radius: 0 0 4px 0;"></div>
                    
                    <!-- 条码指示文字 -->
                    <div style="position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); color: #00ff88; font-size: 12px; font-weight: bold; text-shadow: 0 0 4px rgba(0,255,136,0.5);">
                        📊 Code 128 条码扫描区域
                    </div>
                </div>
                
                <!-- 随机闪烁的白色扫描点 -->
                <div id="randomScanDots" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 120px; pointer-events: none;">
                    <!-- 随机分布的白色扫描点将在这里动态生成 -->
                </div>
            </div>
            
            <!-- 操作提示 -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; text-align: center;">
                <p style="color: white; margin: 0 0 10px 0; font-size: 14px;">将Code 128条码对准长横扫描框</p>
                <p id="scanMode" style="color: #00ff88; margin: 0 0 15px 0; font-size: 12px;">🚀 Code 128专用扫描引擎准备中...</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="toggleFlash()" id="flashBtn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;">💡 开启闪光灯</button>
                    <button onclick="switchCamera()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;">🔄 切换摄像头</button>
                    <button id="restartCameraBtn" onclick="restartCameraForiOS()" style="background: rgba(255,165,0,0.8); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: none;">🔧 重启摄像头</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 扫码结果模态框 -->
    <div id="resultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; overflow-y: auto;">
        <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0; color: #333;">📦 资产信息</h3>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;" id="scannedCode"></p>
                </div>
                <div id="assetForm" style="padding: 20px;">
                    <!-- 这里将动态填充表单内容 -->
                </div>
                <div style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                    <button onclick="closeResult()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px;">取消</button>
                    <button onclick="saveAsset()" style="flex: 1; background: #007bff; color: white; border: none; padding: 12px; border-radius: 8px;">保存</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes randomDotBlink {
            0% { 
                opacity: 0;
                transform: scale(0.5);
                background: rgba(255, 255, 255, 0.3);
                box-shadow: 0 0 2px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1);
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            }
            100% { 
                opacity: 0;
                transform: scale(0.5);
                background: rgba(255, 255, 255, 0.3);
                box-shadow: 0 0 2px rgba(255, 255, 255, 0.3);
            }
        }
        
        @keyframes scanAnimation {
            0% { 
                transform: translate(-50%, -50%) translateY(-50px);
                opacity: 0.6;
            }
            50% { 
                transform: translate(-50%, -50%) translateY(0px);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) translateY(50px);
                opacity: 0.6;
            }
        }
        
        @keyframes barcodeDetected {
            0% { 
                transform: scale(0.8); 
                opacity: 0;
                border-color: #ff4444;
                box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
            }
            50% { 
                transform: scale(1.05); 
                opacity: 1;
                border-color: #00ff88;
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
            }
            100% { 
                transform: scale(1); 
                opacity: 1;
                border-color: #ff4444;
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.6);
            }
        }
        
        /* 随机扫描点样式 */
        .random-scan-dot {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: randomDotBlink 2s infinite;
            pointer-events: none;
        }
        
        .random-scan-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200%;
            height: 200%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: randomRipple 3s infinite;
        }
        
        @keyframes randomRipple {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0.6;
            }
            50% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0.2;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
    </style>

    <script>
        // 统一的API请求函数
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                if (response.status === 401) {
                    // 会话过期，重定向到登录页
                    window.location.href = '/public/login.html';
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            }
        }

        // 页面加载时获取统计数据
        async function loadStats() {
            try {
                // 分别获取各类资产的数量
                const [hostRes, laptopRes, monitorRes, printerRes] = await Promise.all([
                    apiRequest('/api/host'),
                    apiRequest('/api/laptop'), 
                    apiRequest('/api/monitor'),
                    apiRequest('/api/printer')
                ]);
                
                const hostCount = (hostRes && hostRes.code === 0) ? hostRes.data.length : 0;
                const laptopCount = (laptopRes && laptopRes.code === 0) ? laptopRes.data.length : 0;
                const monitorCount = (monitorRes && monitorRes.code === 0) ? monitorRes.data.length : 0;
                const printerCount = (printerRes && printerRes.code === 0) ? printerRes.data.length : 0;
                
                document.getElementById('hostCount').textContent = hostCount;
                document.getElementById('laptopCount').textContent = laptopCount;
                document.getElementById('monitorCount').textContent = monitorCount;
                document.getElementById('printerCount').textContent = printerCount;
            } catch (error) {
                console.error('获取统计数据失败:', error);
                // 保持默认的 "-" 显示
            }
        }

        // 打开功能模块
        function openModule(module) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            const moduleMap = {
                'consumable': '/public/consumableManage.html',
                'host': '/public/hostManage.html',
                'laptop': '/public/laptopManage.html',
                'monitor': '/public/monitorManage.html',
                'printer': '/public/printerManage.html',
                'ip': '/public/ipSegment.html',
                'log': '/public/logManage.html',
                'account': '/public/accountSetting.html'
            };

            setTimeout(() => {
                loading.style.display = 'none';
                if (moduleMap[module]) {
                    window.location.href = moduleMap[module];
                } else {
                    alert('功能正在开发中...');
                }
            }, 800);
        }

        // 扫码功能相关变量
        let currentStream = null;
        let currentDeviceId = null;
        let videoDevices = [];
        let currentAssetType = null;
        let currentAssetData = null;
        let isFlashOn = false;
        let allAssets = []; // 存储所有资产数据用于搜索

        // 执行搜索
        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const keyword = searchInput.value.trim();
            
            if (!keyword) {
                alert('请输入搜索关键词');
                searchInput.focus();
                return;
            }

            console.log('搜索关键词:', keyword);
            
            // 显示加载状态
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // 如果还没有加载过所有资产数据，先加载
                if (allAssets.length === 0) {
                    await loadAllAssets();
                }
                
                // 执行模糊搜索
                const results = fuzzySearch(keyword, allAssets);
                
                // 显示搜索结果
                showSearchResults(keyword, results);
                
            } catch (error) {
                console.error('搜索失败:', error);
                alert('搜索失败，请重试');
            } finally {
                loading.style.display = 'none';
            }
        }

        // 加载所有资产数据
        async function loadAllAssets() {
            try {
                console.log('正在加载所有资产数据...');
                
                const [hostRes, laptopRes, monitorRes, printerRes, consumableRes] = await Promise.all([
                    apiRequest('/api/host'),
                    apiRequest('/api/laptop'),
                    apiRequest('/api/monitor'),
                    apiRequest('/api/printer'),
                    apiRequest('/api/consumable')
                ]);
                
                allAssets = [];
                
                // 主机数据
                if (hostRes && hostRes.code === 0 && Array.isArray(hostRes.data)) {
                    hostRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'host',
                            typeLabel: '主机设备',
                            icon: '🖥️',
                            searchFields: [item.host_number, item.department, item.user, item.cpu, item.memory, item.ip, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // 笔记本数据
                if (laptopRes && laptopRes.code === 0 && Array.isArray(laptopRes.data)) {
                    laptopRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'laptop',
                            typeLabel: '笔记本',
                            icon: '💻',
                            searchFields: [item.asset_number, item.brand, item.model, item.department, item.user, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // 显示器数据
                if (monitorRes && monitorRes.code === 0 && Array.isArray(monitorRes.data)) {
                    monitorRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'monitor',
                            typeLabel: '显示器',
                            icon: '📺',
                            searchFields: [item.asset_id, item.brand, item.model, item.size, item.department, item.user, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // 打印机数据
                if (printerRes && printerRes.code === 0 && Array.isArray(printerRes.data)) {
                    printerRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'printer',
                            typeLabel: '打印机',
                            icon: '🖨️',
                            searchFields: [item.asset_number, item.brand, item.model, item.type, item.department, item.user, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // 耗材数据
                if (consumableRes && consumableRes.code === 0 && Array.isArray(consumableRes.data)) {
                    consumableRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'consumable',
                            typeLabel: '耗材',
                            icon: '📦',
                            searchFields: [item.barcode, item.name, item.specification, item.unit, item.remark].filter(Boolean)
                        });
                    });
                }
                
                console.log(`加载完成，共 ${allAssets.length} 条资产数据`);
                
            } catch (error) {
                console.error('加载资产数据失败:', error);
                throw error;
            }
        }

        // 模糊搜索函数
        function fuzzySearch(keyword, assets) {
            if (!keyword || !assets.length) return [];
            
            const lowerKeyword = keyword.toLowerCase();
            const results = [];
            
            assets.forEach(asset => {
                let score = 0;
                let matchedFields = [];
                
                // 检查所有搜索字段
                asset.searchFields.forEach(field => {
                    if (field && field.toString().toLowerCase().includes(lowerKeyword)) {
                        score += 1;
                        matchedFields.push(field);
                    }
                });
                
                // 如果有匹配，添加到结果中
                if (score > 0) {
                    results.push({
                        ...asset,
                        score: score,
                        matchedFields: matchedFields
                    });
                }
            });
            
            // 按匹配得分排序
            results.sort((a, b) => b.score - a.score);
            
            console.log(`搜索 "${keyword}" 找到 ${results.length} 条结果`);
            return results;
        }

        // 显示搜索结果
        function showSearchResults(keyword, results) {
            // 隐藏概览和功能模块
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('featureGrid').style.display = 'none';
            
            // 显示搜索结果区域
            const searchResults = document.getElementById('searchResults');
            const searchResultsTitle = document.getElementById('searchResultsTitle');
            const searchResultsList = document.getElementById('searchResultsList');
            
            searchResults.style.display = 'block';
            searchResultsTitle.textContent = `搜索 "${keyword}" (${results.length} 条结果)`;
            
            // 清空之前的结果
            searchResultsList.innerHTML = '';
            
            if (results.length === 0) {
                // 无结果
                searchResultsList.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <p>未找到相关资产</p>
                        <p style="font-size: 12px; margin-top: 8px;">请尝试其他关键词或检查拼写</p>
                    </div>
                `;
            } else {
                // 渲染搜索结果
                results.forEach(asset => {
                    const item = createSearchResultItem(asset);
                    searchResultsList.appendChild(item);
                });
            }
        }

        // 创建搜索结果项
        function createSearchResultItem(asset) {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.onclick = () => showAssetDetails(asset);
            
            let primaryId = '';
            let details = {};
            
            // 根据资产类型设置主要信息
            switch (asset.type) {
                case 'host':
                    primaryId = asset.host_number;
                    details = {
                        '部门': asset.department,
                        '使用人': asset.user,
                        'CPU': asset.cpu,
                        'IP地址': asset.ip
                    };
                    break;
                case 'laptop':
                    primaryId = asset.asset_number;
                    details = {
                        '品牌': asset.brand,
                        '型号': asset.model,
                        '部门': asset.department,
                        '使用人': asset.user
                    };
                    break;
                case 'monitor':
                    primaryId = asset.asset_id;
                    details = {
                        '品牌': asset.brand,
                        '型号': asset.model,
                        '尺寸': asset.size,
                        '部门': asset.department
                    };
                    break;
                case 'printer':
                    primaryId = asset.asset_number;
                    details = {
                        '品牌': asset.brand,
                        '型号': asset.model,
                        '类型': asset.type,
                        '部门': asset.department
                    };
                    break;
                case 'consumable':
                    primaryId = asset.barcode;
                    details = {
                        '名称': asset.name,
                        '规格': asset.specification,
                        '单位': asset.unit,
                        '库存': asset.current_stock
                    };
                    break;
            }
            
            // 过滤掉空值
            const filteredDetails = Object.entries(details).filter(([key, value]) => value);
            
            item.innerHTML = `
                <div class="search-result-header">
                    <div>
                        <span class="search-result-type">${asset.icon} ${asset.typeLabel}</span>
                    </div>
                </div>
                <div class="search-result-id">${primaryId}</div>
                <div class="search-result-details">
                    ${filteredDetails.map(([key, value]) => `
                        <div class="search-result-detail">
                            <strong>${key}:</strong> ${value}
                        </div>
                    `).join('')}
                </div>
            `;
            
            return item;
        }

        // 显示资产详情
        function showAssetDetails(asset) {
            console.log('查看资产详情:', asset);
            
            // 设置当前资产数据
            currentAssetType = asset.type;
            currentAssetData = asset;
            
            // 获取主要标识符
            let code = '';
            switch (asset.type) {
                case 'host':
                    code = asset.host_number;
                    break;
                case 'laptop':
                    code = asset.asset_number;
                    break;
                case 'monitor':
                    code = asset.asset_id;
                    break;
                case 'printer':
                    code = asset.asset_number;
                    break;
                case 'consumable':
                    code = asset.barcode;
                    break;
            }
            
            // 显示资产表单
            showAssetForm(asset.type, code, asset);
        }

        // 清除搜索结果
        function clearSearch() {
            // 清空搜索框
            document.getElementById('searchInput').value = '';
            
            // 隐藏搜索结果
            document.getElementById('searchResults').style.display = 'none';
            
            // 显示概览和功能模块
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('featureGrid').style.display = 'grid';
        }

        // 搜索框回车事件
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        });

        // 生成随机扫描点动画
        function createRandomScanDots() {
            const container = document.getElementById('randomScanDots');
            if (!container) return;
            
            // 清除现有的点
            container.innerHTML = '';
            
            // 生成15-20个随机点
            const dotCount = 15 + Math.floor(Math.random() * 6);
            
            for (let i = 0; i < dotCount; i++) {
                const dot = document.createElement('div');
                dot.className = 'random-scan-dot';
                
                // 随机位置（在扫描框内）
                const x = Math.random() * 90 + 5; // 5% - 95% 的位置
                const y = Math.random() * 80 + 10; // 10% - 90% 的位置
                
                // 随机大小
                const size = Math.random() * 2 + 2; // 2-4px
                
                // 随机动画延迟
                const delay = Math.random() * 2; // 0-2秒延迟
                
                // 随机动画持续时间
                const duration = 1.5 + Math.random() * 1; // 1.5-2.5秒
                
                dot.style.cssText = `
                    position: absolute;
                    left: ${x}%;
                    top: ${y}%;
                    width: ${size}px;
                    height: ${size}px;
                    background: rgba(255, 255, 255, 0.8);
                    border-radius: 50%;
                    animation: randomDotBlink ${duration}s infinite;
                    animation-delay: ${delay}s;
                    box-shadow: 0 0 4px rgba(255, 255, 255, 0.6);
                `;
                
                container.appendChild(dot);
            }
        }
        
        // 启动随机点动画循环
        function startRandomDotsAnimation() {
            createRandomScanDots();
            
            // 每3-5秒重新生成点的位置
            const regenerateInterval = setInterval(() => {
                createRandomScanDots();
            }, 3000 + Math.random() * 2000);
            
            // 返回清理函数
            return () => {
                clearInterval(regenerateInterval);
                const container = document.getElementById('randomScanDots');
                if (container) {
                    container.innerHTML = '';
                }
            };
        }
        
        // 扫描动画清理函数
        let cleanupScanAnimation = null;

        // 开始扫码
        async function startScan() {
            try {
                // 立即显示扫码界面，提供快速反馈
                document.getElementById('scanModal').style.display = 'block';
                updateScanMode('🚀 正在初始化扫描功能...');
                
                // 启动随机扫描点动画
                cleanupScanAnimation = startRandomDotsAnimation();
                
                // 检查浏览器兼容性
                const isSupported = checkCameraSupport();
                if (!isSupported.supported) {
                    updateScanMode('❌ 浏览器不支持摄像头');
                    setTimeout(() => {
                        document.getElementById('scanModal').style.display = 'none';
                        showManualInputDialog();
                    }, 2000);
                    return;
                }

                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                
                // 显示设备检测状态
                updateScanMode('🔍 正在检测摄像头设备...');
                
                // 尝试获取摄像头权限
                try {
                    // 获取可用的摄像头设备
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    if (videoDevices.length === 0) {
                        console.log('未检测到摄像头设备');
                        updateScanMode('📱 未检测到摄像头，请使用手动输入');
                        showManualInputInModal();
                        return;
                    }

                    updateScanMode(`📹 检测到 ${videoDevices.length} 个摄像头设备`);
                    
                    // 启动摄像头
                    await startCamera();
                    
                    // 开始扫码检测
                    startBarcodeDetection();
                    
                } catch (permissionError) {
                    console.error('摄像头权限错误:', permissionError);
                    
                    // iOS Safari特殊处理：系统相机拦截是正常现象
                    if (isIOS && isSafari && 
                        (permissionError.name === 'NotAllowedError' || 
                         permissionError.name === 'AbortError' ||
                         permissionError.message.includes('Permission'))) {
                        
                        console.log('iOS Safari系统相机拦截，这是正常现象，继续等待...');
                        updateScanMode('🍎 iOS检测到相机访问，请在弹窗中选择"允许"');
                        
                        // 减少iOS重试等待时间，提高响应速度
                        setTimeout(async () => {
                            try {
                                console.log('重新尝试获取iOS摄像头权限...');
                                updateScanMode('🔄 正在重新连接摄像头...');
                                await startCamera();
                                startBarcodeDetection();
                            } catch (retryError) {
                                console.error('重试失败:', retryError);
                                updateScanMode('❌ 摄像头连接失败，请使用手动输入');
                                addManualInputButton();
                            }
                        }, 3000); // 缩短到3秒
                        
                    } else {
                        // 非iOS或真正的权限拒绝
                        updateScanMode('❌ 摄像头权限被拒绝，请检查浏览器设置');
                        addManualInputButton();
                    }
                }
                
            } catch (error) {
                console.error('启动扫码失败:', error);
                showManualInputDialog();
            }
        }

        // 检查摄像头支持情况
        function checkCameraSupport() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            // 检查基本API支持
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                return {
                    supported: false,
                    reason: 'MediaDevices API不支持',
                    suggestion: isIOS ? '需要HTTPS环境，请使用HTTPS访问' : '请使用现代浏览器'
                };
            }

            // iOS设备特殊检查
            if (isIOS) {
                // iOS Safari 需要 iOS 11+ 且必须是HTTPS
                if (!window.isSecureContext) {
                    return {
                        supported: false,
                        reason: 'iOS设备需要HTTPS环境',
                        suggestion: '请使用HTTPS访问本站点'
                    };
                }
                
                // iOS 13.4+ 对第三方浏览器有更好的支持
                const match = userAgent.match(/OS (\d+)_(\d+)/);
                if (match) {
                    const major = parseInt(match[1]);
                    const minor = parseInt(match[2]);
                    if (major < 11 || (major === 11 && minor < 0)) {
                        return {
                            supported: false,
                            reason: 'iOS版本过低',
                            suggestion: '请升级iOS到11.0以上'
                        };
                    }
                }
            }

            return { supported: true };
        }

        // 在模态框中显示手动输入
        function showManualInputInModal() {
            const scanModal = document.getElementById('scanModal');
            const videoContainer = scanModal.querySelector('div[style*="flex: 1"]');
            
            videoContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #1a1a1a; color: white; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">📱</div>
                    <h3 style="margin-bottom: 15px; text-align: center;">摄像头不可用</h3>
                    <p style="text-align: center; margin-bottom: 30px; color: #ccc; line-height: 1.5;">
                        检测到您的设备或浏览器不支持摄像头功能<br>
                        请手动输入资产编号或条码
                    </p>
                    <input type="text" id="manualCodeInput" placeholder="请输入资产编号或条码" 
                           style="width: 80%; max-width: 300px; padding: 12px; border: 1px solid #444; border-radius: 8px; font-size: 16px; background: #333; color: white; text-align: center;">
                    <button onclick="processManualInput()" 
                            style="margin-top: 20px; background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        确认查找
                    </button>
                </div>
            `;
        }

        // 直接显示手动输入对话框
        function showManualInputDialog() {
            const code = prompt('检测到您的浏览器不支持摄像头功能\n\n请手动输入资产编号或条码:');
            if (code && code.trim()) {
                handleScanResult(code.trim());
            }
        }

        // 处理手动输入
        function processManualInput() {
            const input = document.getElementById('manualCodeInput');
            const code = input.value.trim();
            if (code) {
                closeScan();
                handleScanResult(code);
            } else {
                alert('请输入有效的资产编号或条码');
                input.focus();
            }
        }

        // 启动摄像头 - iOS优化版本
        async function startCamera(deviceId = null) {
            try {
                // 停止之前的流
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                let constraints;
                
                if (isIOS && isSafari) {
                    // iOS Safari 特殊优化 - 使用最简单的约束
                    constraints = {
                        video: {
                            // 避免使用复杂约束，防止系统相机接管
                            facingMode: deviceId ? undefined : 'environment',
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            // 使用较低分辨率，减少处理负担
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            frameRate: { ideal: 15, max: 30 }
                        }
                    };
                } else if (isMobile) {
                    // 其他移动设备
                    constraints = {
                        video: {
                            facingMode: deviceId ? undefined : 'environment',
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        }
                    };
                } else {
                    // 桌面设备
                    constraints = {
                        video: {
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                }

                console.log('尝试获取摄像头，约束条件:', constraints);
                
                // iOS Safari 特殊处理：减少等待时间，提高响应速度
                if (isIOS && isSafari) {
                    // 立即显示准备状态
                    updateScanMode('📹 正在准备摄像头...');
                    
                    // 减少等待时间到1秒，快速响应用户操作
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 简化流的释放逻辑
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        currentStream = null;
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    updateScanMode('🔐 请允许访问摄像头...');
                }
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('scanVideo');
                video.srcObject = currentStream;
                
                // iOS Safari 特殊设置
                if (isIOS && isSafari) {
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                    video.muted = true; // 静音以避免自动播放问题
                }
                
                // 添加播放事件监听
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('视频元数据已加载');
                        
                        // iOS Safari: 延迟播放并强制刷新
                        const playVideo = async () => {
                            try {
                                await video.play();
                                console.log('摄像头启动成功');
                                currentDeviceId = deviceId;
                                
                                // iOS Safari: 额外的视频流检查和恢复机制
                                if (isIOS && isSafari) {
                                    // 等待一小段时间确保视频流稳定
                                    setTimeout(() => {
                                        if (video.videoWidth === 0 || video.videoHeight === 0) {
                                            console.warn('视频流可能未正确加载，尝试重新播放');
                                            video.play();
                                        }
                                        updateScanMode('📷 摄像头已就绪，开始扫描...');
                                        
                                        // 额外检查：如果仍然是黑屏，提供重试选项
                                        setTimeout(() => {
                                            if (video.videoWidth === 0 || video.videoHeight === 0) {
                                                console.error('摄像头流状态异常，可能需要重试');
                                                updateScanMode('⚠️ 摄像头异常，可点击重启摄像头或使用手动输入');
                                                // 显示重启摄像头按钮
                                                const restartBtn = document.getElementById('restartCameraBtn');
                                                if (restartBtn) {
                                                    restartBtn.style.display = 'inline-block';
                                                }
                                                addManualInputButton();
                                            }
                                        }, 3000);
                                    }, 1000);
                                }
                                
                                resolve();
                            } catch (playError) {
                                console.error('视频播放失败:', playError);
                                reject(playError);
                            }
                        };
                        
                        if (isIOS && isSafari) {
                            // iOS Safari: 延迟播放
                            setTimeout(playVideo, 500);
                        } else {
                            playVideo();
                        }
                    };
                    
                    video.onerror = (error) => {
                        console.error('视频错误:', error);
                        reject(error);
                    };
                    
                    // 超时处理
                    setTimeout(() => {
                        reject(new Error('摄像头启动超时'));
                    }, 15000); // iOS 延长超时时间
                });
                
            } catch (error) {
                console.error('启动摄像头失败:', error);
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                
                // iOS Safari特殊处理：不要立即显示手动输入
                if (isIOS && isSafari) {
                    try {
                        console.log('iOS Safari尝试降级方案（前置摄像头）...');
                        updateScanMode('🔄 尝试前置摄像头...');
                        
                        const fallbackConstraints = {
                            video: {
                                facingMode: 'user', // 前置摄像头
                                width: { ideal: 480, max: 640 },
                                height: { ideal: 320, max: 480 }
                            }
                        };
                        currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                        const video = document.getElementById('scanVideo');
                        video.srcObject = currentStream;
                        video.setAttribute('playsinline', 'true');
                        video.setAttribute('webkit-playsinline', 'true');
                        video.muted = true;
                        await video.play();
                        console.log('iOS降级方案成功');
                        updateScanMode('📷 前置摄像头已启动');
                        return; // 成功后直接返回，不显示手动输入
                    } catch (fallbackError) {
                        console.error('iOS降级方案也失败:', fallbackError);
                        // 延迟显示手动输入，给用户更多时间
                        updateScanMode('⏰ 正在重试摄像头启动...');
                        setTimeout(() => {
                            updateScanMode('❌ 摄像头启动失败，请使用手动输入');
                            addManualInputButton();
                        }, 3000);
                    }
                } else {
                    // 非iOS设备的标准处理
                    updateScanMode('❌ 摄像头启动失败');
                    addManualInputButton();
                }
                
                // 不要立即抛出错误或显示手动输入，让iOS有更多时间
                if (!(isIOS && isSafari)) {
                    throw error;
                }
            }
        }

        // 更新扫描模式显示
        function updateScanMode(message) {
            const scanModeElement = document.getElementById('scanMode');
            if (scanModeElement) {
                scanModeElement.textContent = message;
            }
        }

        // 绘制条码检测框
        function drawBarcodeDetectionBox(barcodes, video) {
            const overlay = document.getElementById('barcodeDetectionOverlay');
            if (!overlay || !video) {
                console.warn('检测框容器或视频元素不存在');
                return;
            }

            // 清除之前的检测框
            overlay.innerHTML = '';

            if (barcodes && barcodes.length > 0) {
                barcodes.forEach((barcode, index) => {
                    const boundingBox = barcode.boundingBox;
                    if (boundingBox) {
                        // 获取容器的实际尺寸
                        const overlayRect = overlay.getBoundingClientRect();
                        console.log(`覆盖层尺寸: ${overlayRect.width}x${overlayRect.height}`);
                        console.log(`视频尺寸: ${video.videoWidth}x${video.videoHeight}`);
                        console.log(`条码位置: x=${boundingBox.x}, y=${boundingBox.y}, w=${boundingBox.width}, h=${boundingBox.height}`);
                        
                        // 计算缩放比例
                        const scaleX = overlayRect.width / video.videoWidth;
                        const scaleY = overlayRect.height / video.videoHeight;
                        
                        console.log(`缩放比例: scaleX=${scaleX.toFixed(3)}, scaleY=${scaleY.toFixed(3)}`);
                        
                        // 计算实际显示位置
                        const displayX = boundingBox.x * scaleX;
                        const displayY = boundingBox.y * scaleY;
                        const displayWidth = boundingBox.width * scaleX;
                        const displayHeight = boundingBox.height * scaleY;
                        
                        // 创建检测框元素
                        const detectionBox = document.createElement('div');
                        detectionBox.style.cssText = `
                            position: absolute;
                            border: 4px solid #ff4444;
                            background: rgba(255, 68, 68, 0.15);
                            left: ${displayX}px;
                            top: ${displayY}px;
                            width: ${displayWidth}px;
                            height: ${displayHeight}px;
                            border-radius: 8px;
                            animation: barcodeDetected 0.6s ease-in-out;
                            z-index: 10;
                            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
                        `;
                        
                        // 添加条码值标签
                        const label = document.createElement('div');
                        label.style.cssText = `
                            position: absolute;
                            top: -30px;
                            left: 0;
                            background: rgba(255, 68, 68, 0.95);
                            color: white;
                            padding: 4px 12px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: bold;
                            white-space: nowrap;
                            max-width: 250px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        `;
                        
                        const codeText = barcode.rawValue || 'Unknown';
                        const formatText = barcode.format ? ` (${barcode.format})` : '';
                        label.textContent = codeText + formatText;
                        
                        detectionBox.appendChild(label);
                        overlay.appendChild(detectionBox);
                        
                        console.log(`✅ 检测框已绘制: ${displayX.toFixed(1)}, ${displayY.toFixed(1)}, ${displayWidth.toFixed(1)}, ${displayHeight.toFixed(1)}`);
                        
                        // 3秒后自动移除检测框
                        setTimeout(() => {
                            if (detectionBox.parentNode) {
                                detectionBox.parentNode.removeChild(detectionBox);
                                console.log('检测框已移除');
                            }
                        }, 3000);
                    } else {
                        console.warn(`条码 ${index} 没有边界框信息`);
                    }
                });
            }
        }

        // 清除所有检测框
        function clearBarcodeDetectionBoxes() {
            const overlay = document.getElementById('barcodeDetectionOverlay');
            if (overlay) {
                overlay.innerHTML = '';
            }
        }

        // iOS Safari专用：重启摄像头流
        async function restartCameraForiOS() {
            try {
                console.log('iOS Safari: 尝试重启摄像头流');
                updateScanMode('🔄 正在重启摄像头...');
                
                const video = document.getElementById('scanVideo');
                
                // 完全停止当前流
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                // 清除视频源
                video.srcObject = null;
                video.load();
                
                // 等待一段时间让系统完全释放资源
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 重新启动摄像头
                await startCamera(currentDeviceId);
                updateScanMode('✅ 摄像头重启成功');
                
                // 隐藏重启按钮
                const restartBtn = document.getElementById('restartCameraBtn');
                if (restartBtn) {
                    restartBtn.style.display = 'none';
                }
                
                // 重新开始扫描检测
                startBarcodeDetection();
                
            } catch (error) {
                console.error('重启摄像头失败:', error);
                updateScanMode('❌ 重启失败，请使用手动输入');
                addManualInputButton();
            }
        }

        // 开始条码检测 - 修复版本，使用现有视频流
        function startBarcodeDetection() {
            const scanModeElement = document.getElementById('scanMode');
            const video = document.getElementById('scanVideo');
            
            // 检查QuaggaJS库是否可用
            if (typeof Quagga === 'undefined') {
                console.error('QuaggaJS库未加载，使用手动输入');
                if (scanModeElement) scanModeElement.textContent = '❌ 扫描库加载失败，请使用手动输入';
                addManualInputButton();
                return;
            }

            // 检查视频元素是否存在且有流
            if (!video || !video.srcObject) {
                console.error('视频元素不存在或没有摄像头流');
                if (scanModeElement) scanModeElement.textContent = '❌ 摄像头未就绪，请手动输入';
                addManualInputButton();
                return;
            }

            console.log('🚀 启动QuaggaJS专用Code 128条码检测引擎...');
            if (scanModeElement) scanModeElement.textContent = '📊 Code 128专用检测引擎启动中...';
            
            // 等待视频完全加载后再启动检测
            const startDetection = () => {
                try {
                    // 创建检测画布元素
                    let canvas = document.getElementById('quaggaCanvas');
                    if (!canvas) {
                        canvas = document.createElement('canvas');
                        canvas.id = 'quaggaCanvas';
                        canvas.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 3;
                            pointer-events: none;
                        `;
                        video.parentNode.appendChild(canvas);
                    }
                    
                    // QuaggaJS配置 - 专门优化Code 128检测
                    const quaggaConfig = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: canvas,
                            constraints: {
                                width: { min: 480, ideal: 800, max: 1280 },
                                height: { min: 320, ideal: 600, max: 720 },
                                facingMode: "environment"
                            },
                            area: {     // 限制检测区域，减少误检
                                top: "35%",
                                right: "15%", 
                                left: "15%",
                                bottom: "35%"
                            }
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: false,   // 关闭半采样，提高精度
                            willReadFrequently: true
                        },
                        numOfWorkers: 1,
                        frequency: 8,            // 降低频率，提高稳定性
                        decoder: {
                            readers: [
                                "code_128_reader"    // 只检测Code 128，避免误检EAN格式
                            ],
                            multiple: false      // 只检测单个条码
                        },
                        locate: true,
                        debug: {
                            showCanvas: false,
                            showPatches: false,
                            showFoundPatches: false,
                            showSkeleton: false,
                            showLabels: false,
                            showPatchLabels: false,
                            showRemainingPatchLabels: false,
                            boxFromPatches: {
                                showTransformed: false,
                                showTransformedBox: false,
                                showBB: false
                            }
                        }
                    };
                    
                    let detectionCount = 0;
                    let detectionStartTime = Date.now();
                    
                    // 成功检测回调 - 增强Code 128验证
                    Quagga.onDetected((result) => {
                        const code = result.codeResult.code;
                        const format = result.codeResult.format;
                        const confidence = 1 - (result.codeResult.startInfo.error || 0);
                        
                        console.log(`🔍 QuaggaJS检测结果: ${code} (${format}), 置信度: ${(confidence*100).toFixed(1)}%`);
                        
                        // 只接受Code 128格式，且置信度要求更高
                        if (format === 'code_128' && confidence > 0.85) {
                            console.log(`✅ Code 128检测成功: ${code}, 置信度: ${(confidence*100).toFixed(1)}%`);
                            
                            // 停止检测
                            stopQuaggaDetection();
                            
                            // 更新状态显示
                            if (scanModeElement) {
                                scanModeElement.textContent = `✅ 检测到Code 128: ${code}`;
                            }
                            
                            // 创建检测框显示
                            const mockBarcodes = [{
                                rawValue: code,
                                format: format,
                                boundingBox: {
                                    x: result.box ? result.box[0][0] : (video.offsetWidth * 0.15),
                                    y: result.box ? result.box[0][1] : (video.offsetHeight * 0.35), 
                                    width: result.box ? Math.abs(result.box[2][0] - result.box[0][0]) : (video.offsetWidth * 0.7),
                                    height: result.box ? Math.abs(result.box[2][1] - result.box[0][1]) : (video.offsetHeight * 0.3)
                                }
                            }];
                            
                            drawBarcodeDetectionBox(mockBarcodes, video);
                            
                            // 延迟处理，让用户看到检测框
                            setTimeout(() => {
                                handleScanResult(code);
                            }, 1200);
                        } else {
                            console.log(`❌ 检测结果不符合要求: 格式=${format}, 置信度=${(confidence*100).toFixed(1)}%`);
                            
                            // 如果不是Code 128或置信度不够，继续检测
                            if (scanModeElement) {
                                if (format !== 'code_128') {
                                    scanModeElement.textContent = `⚠️ 检测到${format}格式，请对准Code 128条码`;
                                } else {
                                    scanModeElement.textContent = `⚠️ 信号较弱(${(confidence*100).toFixed(0)}%)，请调整角度和距离`;
                                }
                            }
                        }
                    });
                    
                    // 处理每一帧 - 显示Code 128检测进度
                    Quagga.onProcessed((result) => {
                        detectionCount++;
                        
                        if (detectionCount % 30 === 0) {
                            const elapsed = (Date.now() - detectionStartTime) / 1000;
                            const rate = (detectionCount / elapsed).toFixed(1);
                            
                            if (scanModeElement) {
                                scanModeElement.textContent = `🎯 Code 128专用检测中... ${rate}帧/秒`;
                            }
                            
                            console.log(`📊 Code 128检测进度: ${detectionCount} 帧，用时 ${elapsed.toFixed(1)}秒，检测率 ${rate}/秒`);
                            
                            // 30秒后自动显示手动输入选项
                            if (elapsed > 30) {
                                console.log('⏰ Code 128检测超时，显示手动输入选项');
                                if (scanModeElement) {
                                    scanModeElement.textContent = '⏰ 检测超时，可点击手动输入';
                                }
                                addManualInputButton();
                            }
                        }
                    });
                    
                    // 初始化QuaggaJS
                    Quagga.init(quaggaConfig, (err) => {
                        if (err) {
                            console.error('❌ QuaggaJS初始化失败:', err.message || err);
                            if (scanModeElement) {
                                scanModeElement.textContent = '❌ 检测引擎初始化失败，请手动输入';
                            }
                            addManualInputButton();
                            return;
                        }
                        
                        console.log('✅ QuaggaJS初始化成功，开始专用Code 128条码扫描...');
                        Quagga.start();
                        
                        // 更新状态提示
                        if (scanModeElement) {
                            scanModeElement.textContent = '🎯 Code 128检测中... 请将条码对准横框';
                        }
                        
                        // 15秒后显示手动输入选项作为备选
                        setTimeout(() => {
                            addManualInputButton();
                        }, 15000);
                    });
                    
                } catch (error) {
                    console.error('启动检测时出错:', error);
                    if (scanModeElement) {
                        scanModeElement.textContent = '❌ 启动检测失败，请手动输入';
                    }
                    addManualInputButton();
                }
            };
            
            // 检查视频是否已经准备好
            if (video.readyState >= 2) {
                // 视频已加载，直接启动检测
                startDetection();
            } else {
                // 等待视频加载
                video.addEventListener('loadeddata', startDetection, { once: true });
                // 超时保护
                setTimeout(() => {
                    if (video.readyState < 2) {
                        console.warn('视频加载超时，尝试强制启动检测');
                        startDetection();
                    }
                }, 3000);
            }
        }
        
        // 停止QuaggaJS检测
        function stopQuaggaDetection() {
            try {
                if (typeof Quagga !== 'undefined') {
                    Quagga.stop();
                    Quagga.offDetected();
                    Quagga.offProcessed();
                    
                    // 清理canvas元素
                    const canvas = document.getElementById('quaggaCanvas');
                    if (canvas) {
                        canvas.remove();
                    }
                    
                    // 清理旧的检测容器（如果存在）
                    const container = document.getElementById('quaggaDetectionContainer');
                    if (container) {
                        container.remove();
                    }
                    
                    console.log('🛑 QuaggaJS检测已停止');
                }
            } catch (e) {
                console.warn('停止QuaggaJS检测时出错:', e);
            }
        }

        // 添加手动输入按钮到扫码界面
        function addManualInputButton() {
            const scanModal = document.getElementById('scanModal');
            
            // 检查是否已经添加了按钮
            if (scanModal.querySelector('.manual-input-btn')) {
                return;
            }
            
            const manualInput = document.createElement('button');
            manualInput.className = 'manual-input-btn';
            manualInput.innerHTML = '📝 手动输入编号';
            manualInput.style.cssText = `
                position: absolute; 
                top: 70px; 
                right: 20px; 
                background: rgba(0, 123, 255, 0.8); 
                border: none; 
                color: white; 
                padding: 10px 16px; 
                border-radius: 8px; 
                font-size: 14px; 
                cursor: pointer;
                z-index: 10001;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            manualInput.onclick = () => {
                const code = prompt('请输入资产编号或条码:');
                if (code && code.trim()) {
                    handleScanResult(code.trim());
                }
            };
            scanModal.appendChild(manualInput);
        }

        // 处理扫码结果
        async function handleScanResult(code) {
            console.log('扫码结果:', code);
            
            // 停止摄像头
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // 隐藏扫码界面
            document.getElementById('scanModal').style.display = 'none';
            
            // 解析资产类型和编号
            const assetInfo = parseAssetCode(code);
            currentAssetType = assetInfo.type;
            
            // 显示加载状态
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // 根据资产类型查询数据
                let assetData = null;
                
                if (assetInfo.type === 'host') {
                    assetData = await findAssetByNumber('/api/host', 'host_number', code);
                } else if (assetInfo.type === 'monitor') {
                    assetData = await findAssetByNumber('/api/monitor', 'asset_id', code);
                } else if (assetInfo.type === 'printer') {
                    assetData = await findAssetByNumber('/api/printer', 'asset_number', code);
                } else if (assetInfo.type === 'consumable') {
                    assetData = await findAssetByNumber('/api/consumable', 'barcode', code);
                }
                
                loading.style.display = 'none';
                
                // 显示资产信息表单
                showAssetForm(assetInfo.type, code, assetData);
                
            } catch (error) {
                loading.style.display = 'none';
                console.error('查询资产失败:', error);
                alert('查询资产信息失败，请重试');
            }
        }

        // 解析资产编号，确定资产类型
        function parseAssetCode(code) {
            const upperCode = code.toUpperCase();
            
            if (upperCode.startsWith('PC-')) {
                return { type: 'host', prefix: 'PC-' };
            } else if (upperCode.startsWith('MONITOR-')) {
                return { type: 'monitor', prefix: 'MONITOR-' };
            } else if (upperCode.startsWith('PRINT-')) {
                return { type: 'printer', prefix: 'PRINT-' };
            } else {
                // 默认归类为耗材
                return { type: 'consumable', prefix: '' };
            }
        }

        // 根据编号查找资产
        async function findAssetByNumber(apiUrl, fieldName, code) {
            const response = await apiRequest(apiUrl);
            if (response && response.code === 0 && Array.isArray(response.data)) {
                return response.data.find(item => item[fieldName] === code) || null;
            }
            return null;
        }

        // 显示资产信息表单
        function showAssetForm(assetType, code, existingData) {
            currentAssetData = existingData;
            
            document.getElementById('scannedCode').textContent = `扫描结果: ${code}`;
            
            const formContainer = document.getElementById('assetForm');
            let formHTML = '';
            
            if (assetType === 'host') {
                formHTML = generateHostForm(code, existingData);
            } else if (assetType === 'monitor') {
                formHTML = generateMonitorForm(code, existingData);
            } else if (assetType === 'printer') {
                formHTML = generatePrinterForm(code, existingData);
            } else if (assetType === 'consumable') {
                formHTML = generateConsumableForm(code, existingData);
            }
            
            formContainer.innerHTML = formHTML;
            document.getElementById('resultModal').style.display = 'block';
        }

        // 生成主机表单
        function generateHostForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">主机编号</label>
                    <input type="text" class="form-input" id="host_number" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">部门</label>
                    <input type="text" class="form-input" id="department" value="${data?.department || ''}" placeholder="请输入部门">
                </div>
                <div class="form-group">
                    <label class="form-label">使用人员</label>
                    <input type="text" class="form-input" id="user" value="${data?.user || ''}" placeholder="请输入使用人员">
                </div>
                <div class="form-group">
                    <label class="form-label">CPU</label>
                    <input type="text" class="form-input" id="cpu" value="${data?.cpu || ''}" placeholder="请输入CPU型号">
                </div>
                <div class="form-group">
                    <label class="form-label">内存</label>
                    <input type="text" class="form-input" id="memory" value="${data?.memory || ''}" placeholder="请输入内存配置">
                </div>
                <div class="form-group">
                    <label class="form-label">硬盘</label>
                    <input type="text" class="form-input" id="disk" value="${data?.disk || ''}" placeholder="请输入硬盘配置">
                </div>
                <div class="form-group">
                    <label class="form-label">IP地址</label>
                    <input type="text" class="form-input" id="ip" value="${data?.ip || ''}" placeholder="请输入IP地址">
                </div>
                <div class="form-group">
                    <label class="form-label">MAC地址</label>
                    <input type="text" class="form-input" id="mac" value="${data?.mac || ''}" placeholder="请输入MAC地址">
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="请输入备注信息">
                </div>
            `;
        }

        // 生成显示器表单
        function generateMonitorForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">显示器编号</label>
                    <input type="text" class="form-input" id="asset_id" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">品牌</label>
                    <input type="text" class="form-input" id="brand" value="${data?.brand || ''}" placeholder="请输入品牌">
                </div>
                <div class="form-group">
                    <label class="form-label">型号</label>
                    <input type="text" class="form-input" id="model" value="${data?.model || ''}" placeholder="请输入型号">
                </div>
                <div class="form-group">
                    <label class="form-label">尺寸</label>
                    <input type="text" class="form-input" id="size" value="${data?.size || ''}" placeholder="请输入尺寸">
                </div>
                <div class="form-group">
                    <label class="form-label">部门</label>
                    <input type="text" class="form-input" id="department" value="${data?.department || ''}" placeholder="请输入部门">
                </div>
                <div class="form-group">
                    <label class="form-label">使用人员</label>
                    <input type="text" class="form-input" id="user" value="${data?.user || ''}" placeholder="请输入使用人员">
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="请输入备注信息">
                </div>
            `;
        }

        // 生成打印机表单
        function generatePrinterForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">打印机编号</label>
                    <input type="text" class="form-input" id="asset_number" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">品牌</label>
                    <input type="text" class="form-input" id="brand" value="${data?.brand || ''}" placeholder="请输入品牌">
                </div>
                <div class="form-group">
                    <label class="form-label">型号</label>
                    <input type="text" class="form-input" id="model" value="${data?.model || ''}" placeholder="请输入型号">
                </div>
                <div class="form-group">
                    <label class="form-label">类型</label>
                    <select class="form-input" id="type">
                        <option value="激光打印机" ${data?.type === '激光打印机' ? 'selected' : ''}>激光打印机</option>
                        <option value="喷墨打印机" ${data?.type === '喷墨打印机' ? 'selected' : ''}>喷墨打印机</option>
                        <option value="针式打印机" ${data?.type === '针式打印机' ? 'selected' : ''}>针式打印机</option>
                        <option value="多功能一体机" ${data?.type === '多功能一体机' ? 'selected' : ''}>多功能一体机</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">部门</label>
                    <input type="text" class="form-input" id="department" value="${data?.department || ''}" placeholder="请输入部门">
                </div>
                <div class="form-group">
                    <label class="form-label">使用人员</label>
                    <input type="text" class="form-input" id="user" value="${data?.user || ''}" placeholder="请输入使用人员">
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="请输入备注信息">
                </div>
            `;
        }

        // 生成耗材表单
        function generateConsumableForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">条码</label>
                    <input type="text" class="form-input" id="barcode" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">耗材名称</label>
                    <input type="text" class="form-input" id="name" value="${data?.name || ''}" placeholder="请输入耗材名称" required>
                </div>
                <div class="form-group">
                    <label class="form-label">规格型号</label>
                    <input type="text" class="form-input" id="specification" value="${data?.specification || ''}" placeholder="请输入规格型号">
                </div>
                <div class="form-group">
                    <label class="form-label">单位</label>
                    <select class="form-input" id="unit">
                        <option value="个" ${data?.unit === '个' ? 'selected' : ''}>个</option>
                        <option value="支" ${data?.unit === '支' ? 'selected' : ''}>支</option>
                        <option value="盒" ${data?.unit === '盒' ? 'selected' : ''}>盒</option>
                        <option value="套" ${data?.unit === '套' ? 'selected' : ''}>套</option>
                        <option value="包" ${data?.unit === '包' ? 'selected' : ''}>包</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">当前库存</label>
                    <input type="number" class="form-input" id="current_stock" value="${data?.current_stock || 0}" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">最小库存</label>
                    <input type="number" class="form-input" id="min_stock" value="${data?.min_stock || 0}" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="请输入备注信息">
                </div>
            `;
        }

        // 保存资产信息
        async function saveAsset() {
            try {
                const formData = new FormData();
                const inputs = document.querySelectorAll('#assetForm input, #assetForm select');
                
                // 收集表单数据
                const data = {};
                inputs.forEach(input => {
                    data[input.id] = input.value;
                });

                let apiUrl = '';
                let method = 'POST';
                let apiData = data;

                // 根据资产类型确定API端点
                if (currentAssetType === 'host') {
                    apiUrl = '/api/host';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                } else if (currentAssetType === 'monitor') {
                    apiUrl = '/api/monitor';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                } else if (currentAssetType === 'printer') {
                    apiUrl = '/api/printer';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                } else if (currentAssetType === 'consumable') {
                    apiUrl = '/api/consumable';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                }

                // 发送请求
                const response = await apiRequest(apiUrl, {
                    method: method,
                    body: JSON.stringify(apiData)
                });

                if (response && response.code === 0) {
                    alert(currentAssetData ? '更新成功！' : '新增成功！');
                    closeResult();
                    // 刷新统计数据
                    loadStats();
                } else {
                    alert('保存失败：' + (response?.msg || '未知错误'));
                }

            } catch (error) {
                console.error('保存资产失败:', error);
                alert('保存失败，请重试');
            }
        }

        // 关闭扫码界面
        function closeScan() {
            // 停止摄像头流
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // 停止QuaggaJS检测
            stopQuaggaDetection();
            
            // 清除条码检测框
            clearBarcodeDetectionBoxes();
            
            // 清理随机扫描点动画
            if (cleanupScanAnimation) {
                cleanupScanAnimation();
                cleanupScanAnimation = null;
            }
            
            // 清理手动输入按钮
            const scanModal = document.getElementById('scanModal');
            const manualBtn = scanModal.querySelector('.manual-input-btn');
            if (manualBtn) {
                manualBtn.remove();
            }
            
            // 重置重启摄像头按钮状态
            const restartBtn = document.getElementById('restartCameraBtn');
            if (restartBtn) {
                restartBtn.style.display = 'none';
            }
            
            // 重置视频容器（如果被修改过）
            const videoContainer = scanModal.querySelector('div[style*="flex: 1"]');
            if (videoContainer && !videoContainer.querySelector('#scanVideo')) {
                videoContainer.innerHTML = `
                    <video id="scanVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                    
                    <!-- 条码检测框容器 -->
                    <div id="barcodeDetectionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
                    
                    <!-- 扫描框 -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 200px; border: 2px solid #00ff88; border-radius: 12px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5);">
                        <div style="position: absolute; top: -2px; left: -2px; width: 20px; height: 20px; border-top: 3px solid #00ff88; border-left: 3px solid #00ff88;"></div>
                        <div style="position: absolute; top: -2px; right: -2px; width: 20px; height: 20px; border-top: 3px solid #00ff88; border-right: 3px solid #00ff88;"></div>
                        <div style="position: absolute; bottom: -2px; left: -2px; width: 20px; height: 20px; border-bottom: 3px solid #00ff88; border-left: 3px solid #00ff88;"></div>
                        <div style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; border-bottom: 3px solid #00ff88; border-right: 3px solid #00ff88;"></div>
                    </div>
                    
                    <!-- 扫描线动画 -->
                    <div id="scanLine" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 2px; background: linear-gradient(90deg, transparent, #00ff88, transparent); animation: scanAnimation 2s linear infinite;"></div>
                `;
            }
            
            document.getElementById('scanModal').style.display = 'none';
        }

        // 关闭结果界面
        function closeResult() {
            document.getElementById('resultModal').style.display = 'none';
            currentAssetType = null;
            currentAssetData = null;
        }

        // 切换闪光灯
        function toggleFlash() {
            if (currentStream) {
                const track = currentStream.getVideoTracks()[0];
                if (track && track.getCapabilities && track.getCapabilities().torch) {
                    isFlashOn = !isFlashOn;
                    track.applyConstraints({
                        advanced: [{ torch: isFlashOn }]
                    });
                    document.getElementById('flashBtn').textContent = isFlashOn ? '💡 关闭闪光灯' : '💡 开启闪光灯';
                } else {
                    alert('当前设备不支持闪光灯');
                }
            }
        }

        // 切换摄像头
        async function switchCamera() {
            if (videoDevices.length > 1) {
                const currentIndex = videoDevices.findIndex(device => device.deviceId === currentDeviceId);
                const nextIndex = (currentIndex + 1) % videoDevices.length;
                const nextDevice = videoDevices[nextIndex];
                
                try {
                    await startCamera(nextDevice.deviceId);
                } catch (error) {
                    console.error('切换摄像头失败:', error);
                    alert('切换摄像头失败');
                }
            } else {
                alert('只检测到一个摄像头设备');
            }
        }

        // 跳转到桌面版（保留原功能，但隐藏）
        function goToDesktop() {
            if (confirm('即将跳转到完整版系统，建议使用电脑浏览器访问以获得最佳体验。是否继续？')) {
                window.location.href = '/public/index.html?desktop=1';
            }
        }

        // 检查用户代理，如果是移动设备则添加特殊样式
        function checkMobileDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('mobile-device');
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            checkMobileDevice();
            loadStats();
            
            // 添加触摸反馈
            const cards = document.querySelectorAll('.feature-card');
            cards.forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                card.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });

        // 检查登录状态
        async function checkAuth() {
            try {
                const response = await apiRequest('/api/auth/check');
                if (!response || response.code !== 0) {
                    window.location.href = '/public/login.html';
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                window.location.href = '/public/login.html';
            }
        }

        // 页面加载时检查登录状态
        checkAuth();
    </script>
</body>
</html>
