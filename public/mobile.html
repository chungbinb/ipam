<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ITèµ„äº§ç®¡ç†ç³»ç»Ÿ - æ‰‹æœºç‰ˆ</title>
    <!-- ä¸“ç”¨QuaggaJSæ¡ç æ‰«æåº“ - ä¸“æ³¨Code 128æ£€æµ‹ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .search-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-container {
            display: flex;
            gap: 10px;
            align-items: center;
            max-width: 480px;
            margin: 0 auto;
        }

        .search-box {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 12px 16px;
            font-size: 16px;
            background: transparent;
            color: #333;
        }

        .search-input::placeholder {
            color: #999;
        }

        .search-btn {
            background: #667eea;
            border: none;
            color: white;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .search-btn:hover {
            background: #5a67d8;
        }

        .scan-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* æœç´¢ç»“æœåŒºåŸŸ */
        .search-results {
            margin-top: 20px;
        }

        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .search-results-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .clear-search-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-search-btn:hover {
            background: #c53030;
        }

        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-result-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .search-result-type {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .search-result-id {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .search-result-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .search-result-detail {
            font-size: 13px;
            color: #666;
        }

        .search-result-detail strong {
            color: #333;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .container {
            padding: 30px 20px;
            max-width: 480px;
            margin: 0 auto;
        }

        /* åŠŸèƒ½å¡ç‰‡ç½‘æ ¼ */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 12px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            position: relative;
            z-index: 1;
        }

        .feature-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .feature-desc {
            font-size: 12px;
            color: #718096;
            line-height: 1.4;
            position: relative;
            z-index: 1;
        }

        /* å¿«é€Ÿç»Ÿè®¡åŒºåŸŸ */
        .stats-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
        }

        /* è®¿é—®æç¤º */
        .access-tip {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .tip-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .tip-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tip-content {
            font-size: 14px;
            color: #718096;
            line-height: 1.6;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 3px solid rgba(102, 126, 234, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 375px) {
            .container {
                padding: 20px 15px;
            }
            
            .feature-grid {
                gap: 15px;
            }
            
            .feature-card {
                padding: 20px 15px;
            }
            
            .title {
                font-size: 22px;
            }
        }

        /* æš—é»‘æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            }
            
            .search-header, .feature-card, .stats-section, .access-tip, .search-result-item {
                background: rgba(45, 55, 72, 0.9);
                color: #e2e8f0;
            }
            
            .search-box {
                background: #2d3748;
                border-color: #667eea;
            }
            
            .search-input {
                color: #e2e8f0;
            }
            
            .search-input::placeholder {
                color: #a0aec0;
            }
            
            .title, .feature-title, .stats-title, .tip-title, .search-results-header h3, .search-result-id {
                color: #e2e8f0;
            }
            
            .subtitle, .feature-desc, .stat-label, .tip-content, .search-result-detail {
                color: #a0aec0;
            }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨æœç´¢åŒºåŸŸ -->
    <div class="search-header">
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢èµ„äº§ç¼–å·ã€åç§°ã€éƒ¨é—¨..." class="search-input">
                <button onclick="performSearch()" class="search-btn">ğŸ”</button>
            </div>
            <button onclick="startScan()" class="scan-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
                    <!-- å·¦ä¸Šè§’ -->
                    <path d="M3 3H9V5H5V9H3V3Z" fill="currentColor"/>
                    <!-- å³ä¸Šè§’ -->
                    <path d="M21 3V9H19V5H15V3H21Z" fill="currentColor"/>
                    <!-- å·¦ä¸‹è§’ -->
                    <path d="M3 21V15H5V19H9V21H3Z" fill="currentColor"/>
                    <!-- å³ä¸‹è§’ -->
                    <path d="M21 21H15V19H19V15H21V21Z" fill="currentColor"/>
                    <!-- ä¸­å¤®æ°´å¹³æ‰«æçº¿ -->
                    <path d="M6 12H18V12.5H6V12Z" fill="currentColor" opacity="0.8"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <!-- å¿«é€Ÿç»Ÿè®¡ -->
        <div class="stats-section" id="statsSection">
            <div class="stats-title">ğŸ“Š èµ„äº§æ¦‚è§ˆ</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="hostCount">-</div>
                    <div class="stat-label">ä¸»æœºè®¾å¤‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="laptopCount">-</div>
                    <div class="stat-label">ç¬”è®°æœ¬</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="monitorCount">-</div>
                    <div class="stat-label">æ˜¾ç¤ºå™¨</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="printerCount">-</div>
                    <div class="stat-label">æ‰“å°æœº</div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½æ¨¡å— -->
        <div class="feature-grid" id="featureGrid">
            <div class="feature-card" onclick="openModule('consumable')">
                <div class="feature-icon">ğŸ“¦</div>
                <div class="feature-title">è€—æç®¡ç†</div>
                <div class="feature-desc">ç®¡ç†åŠå…¬è€—æåº“å­˜</div>
            </div>
            
            <div class="feature-card" onclick="openModule('host')">
                <div class="feature-icon">ğŸ–¥ï¸</div>
                <div class="feature-title">ä¸»æœºç®¡ç†</div>
                <div class="feature-desc">ç®¡ç†å°å¼ä¸»æœºè®¾å¤‡</div>
            </div>
            
            <div class="feature-card" onclick="openModule('laptop')">
                <div class="feature-icon">ğŸ’»</div>
                <div class="feature-title">ç¬”è®°æœ¬</div>
                <div class="feature-desc">ç®¡ç†ä¾¿æºè®¾å¤‡</div>
            </div>
            
            <div class="feature-card" onclick="openModule('monitor')">
                <div class="feature-icon">ğŸ“º</div>
                <div class="feature-title">æ˜¾ç¤ºå™¨</div>
                <div class="feature-desc">ç®¡ç†æ˜¾ç¤ºè®¾å¤‡</div>
            </div>
            
            <div class="feature-card" onclick="openModule('printer')">
                <div class="feature-icon">ğŸ–¨ï¸</div>
                <div class="feature-title">æ‰“å°æœº</div>
                <div class="feature-desc">ç®¡ç†æ‰“å°è®¾å¤‡</div>
            </div>
            
            <div class="feature-card" onclick="openModule('ip')">
                <div class="feature-icon">ğŸŒ</div>
                <div class="feature-title">IPæ®µç®¡ç†</div>
                <div class="feature-desc">ç½‘ç»œåœ°å€æ®µç®¡ç†</div>
            </div>
            
            <div class="feature-card" onclick="openModule('log')">
                <div class="feature-icon">ğŸ“</div>
                <div class="feature-title">æ“ä½œæ—¥å¿—</div>
                <div class="feature-desc">æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—</div>
            </div>
            
            <div class="feature-card" onclick="openModule('account')">
                <div class="feature-icon">ğŸ‘¤</div>
                <div class="feature-title">è´¦å·è®¾ç½®</div>
                <div class="feature-desc">ä¸ªäººä¿¡æ¯ç®¡ç†</div>
            </div>
        </div>

        <!-- æœç´¢ç»“æœåŒºåŸŸ -->
        <div class="search-results" id="searchResults" style="display: none;">
            <div class="search-results-header">
                <h3 id="searchResultsTitle">æœç´¢ç»“æœ</h3>
                <button onclick="clearSearch()" class="clear-search-btn">âœ• æ¸…é™¤</button>
            </div>
            <div class="search-results-list" id="searchResultsList">
                <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>æ­£åœ¨åŠ è½½...</div>
        </div>
    </div>



    <!-- æ‰«ç æ¨¡æ€æ¡† -->
    <div id="scanModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000;">
        <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column;">
            <!-- æ‰«ç å¤´éƒ¨ -->
            <div style="background: rgba(255,255,255,0.1); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: white; margin: 0; font-size: 18px;">ğŸ“· æ‰«æèµ„äº§ç¼–å·</h3>
                <button onclick="closeScan()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
            </div>
            
            <!-- æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ -->
            <div style="flex: 1; position: relative; overflow: hidden;">
                <video id="scanVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                
                <!-- æ¡ç æ£€æµ‹æ¡†å®¹å™¨ -->
                <div id="barcodeDetectionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
                
                <!-- Code 128æ¡ç æ‰«ææ¡† - é•¿æ¨ªæ¡æ ·å¼ -->
                <div id="barcodeFrame" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 120px; border: 2px solid #00ff88; border-radius: 8px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.6);">
                    <!-- é¡¶éƒ¨å·¦å³è§’æ ‡ -->
                    <div style="position: absolute; top: -3px; left: -3px; width: 25px; height: 25px; border-top: 4px solid #00ff88; border-left: 4px solid #00ff88; border-radius: 4px 0 0 0;"></div>
                    <div style="position: absolute; top: -3px; right: -3px; width: 25px; height: 25px; border-top: 4px solid #00ff88; border-right: 4px solid #00ff88; border-radius: 0 4px 0 0;"></div>
                    <!-- åº•éƒ¨å·¦å³è§’æ ‡ -->
                    <div style="position: absolute; bottom: -3px; left: -3px; width: 25px; height: 25px; border-bottom: 4px solid #00ff88; border-left: 4px solid #00ff88; border-radius: 0 0 0 4px;"></div>
                    <div style="position: absolute; bottom: -3px; right: -3px; width: 25px; height: 25px; border-bottom: 4px solid #00ff88; border-right: 4px solid #00ff88; border-radius: 0 0 4px 0;"></div>
                    
                    <!-- æ¡ç æŒ‡ç¤ºæ–‡å­— -->
                    <div style="position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); color: #00ff88; font-size: 12px; font-weight: bold; text-shadow: 0 0 4px rgba(0,255,136,0.5);">
                        ğŸ“Š Code 128 æ¡ç æ‰«æåŒºåŸŸ
                    </div>
                </div>
                
                <!-- éšæœºé—ªçƒçš„ç™½è‰²æ‰«æç‚¹ -->
                <div id="randomScanDots" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 120px; pointer-events: none;">
                    <!-- éšæœºåˆ†å¸ƒçš„ç™½è‰²æ‰«æç‚¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ“ä½œæç¤º -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; text-align: center;">
                <p style="color: white; margin: 0 0 10px 0; font-size: 14px;">å°†Code 128æ¡ç å¯¹å‡†é•¿æ¨ªæ‰«ææ¡†</p>
                <p id="scanMode" style="color: #00ff88; margin: 0 0 15px 0; font-size: 12px;">ğŸš€ Code 128ä¸“ç”¨æ‰«æå¼•æ“å‡†å¤‡ä¸­...</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="toggleFlash()" id="flashBtn" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;">ğŸ’¡ å¼€å¯é—ªå…‰ç¯</button>
                    <button onclick="switchCamera()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px;">ğŸ”„ åˆ‡æ¢æ‘„åƒå¤´</button>
                    <button id="restartCameraBtn" onclick="restartCameraForiOS()" style="background: rgba(255,165,0,0.8); border: none; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: none;">ğŸ”§ é‡å¯æ‘„åƒå¤´</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰«ç ç»“æœæ¨¡æ€æ¡† -->
    <div id="resultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; overflow-y: auto;">
        <div style="min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 16px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0; color: #333;">ğŸ“¦ èµ„äº§ä¿¡æ¯</h3>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;" id="scannedCode"></p>
                </div>
                <div id="assetForm" style="padding: 20px;">
                    <!-- è¿™é‡Œå°†åŠ¨æ€å¡«å……è¡¨å•å†…å®¹ -->
                </div>
                <div style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
                    <button onclick="closeResult()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 8px;">å–æ¶ˆ</button>
                    <button onclick="saveAsset()" style="flex: 1; background: #007bff; color: white; border: none; padding: 12px; border-radius: 8px;">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes randomDotBlink {
            0% { 
                opacity: 0;
                transform: scale(0.5);
                background: rgba(255, 255, 255, 0.3);
                box-shadow: 0 0 2px rgba(255, 255, 255, 0.3);
            }
            50% { 
                opacity: 1;
                transform: scale(1);
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            }
            100% { 
                opacity: 0;
                transform: scale(0.5);
                background: rgba(255, 255, 255, 0.3);
                box-shadow: 0 0 2px rgba(255, 255, 255, 0.3);
            }
        }
        
        @keyframes scanAnimation {
            0% { 
                transform: translate(-50%, -50%) translateY(-50px);
                opacity: 0.6;
            }
            50% { 
                transform: translate(-50%, -50%) translateY(0px);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) translateY(50px);
                opacity: 0.6;
            }
        }
        
        @keyframes barcodeDetected {
            0% { 
                transform: scale(0.8); 
                opacity: 0;
                border-color: #ff4444;
                box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
            }
            50% { 
                transform: scale(1.05); 
                opacity: 1;
                border-color: #00ff88;
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
            }
            100% { 
                transform: scale(1); 
                opacity: 1;
                border-color: #ff4444;
                box-shadow: 0 0 15px rgba(255, 68, 68, 0.6);
            }
        }
        
        /* éšæœºæ‰«æç‚¹æ ·å¼ */
        .random-scan-dot {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: randomDotBlink 2s infinite;
            pointer-events: none;
        }
        
        .random-scan-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200%;
            height: 200%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: randomRipple 3s infinite;
        }
        
        @keyframes randomRipple {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0.6;
            }
            50% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0.2;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
    </style>

    <script>
        // ç»Ÿä¸€çš„APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(url, finalOptions);
                
                if (response.status === 401) {
                    // ä¼šè¯è¿‡æœŸï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    window.location.href = '/public/login.html';
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                throw error;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                // åˆ†åˆ«è·å–å„ç±»èµ„äº§çš„æ•°é‡
                const [hostRes, laptopRes, monitorRes, printerRes] = await Promise.all([
                    apiRequest('/api/host'),
                    apiRequest('/api/laptop'), 
                    apiRequest('/api/monitor'),
                    apiRequest('/api/printer')
                ]);
                
                const hostCount = (hostRes && hostRes.code === 0) ? hostRes.data.length : 0;
                const laptopCount = (laptopRes && laptopRes.code === 0) ? laptopRes.data.length : 0;
                const monitorCount = (monitorRes && monitorRes.code === 0) ? monitorRes.data.length : 0;
                const printerCount = (printerRes && printerRes.code === 0) ? printerRes.data.length : 0;
                
                document.getElementById('hostCount').textContent = hostCount;
                document.getElementById('laptopCount').textContent = laptopCount;
                document.getElementById('monitorCount').textContent = monitorCount;
                document.getElementById('printerCount').textContent = printerCount;
            } catch (error) {
                console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // ä¿æŒé»˜è®¤çš„ "-" æ˜¾ç¤º
            }
        }

        // æ‰“å¼€åŠŸèƒ½æ¨¡å—
        function openModule(module) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            const moduleMap = {
                'consumable': '/public/consumableManage.html',
                'host': '/public/hostManage.html',
                'laptop': '/public/laptopManage.html',
                'monitor': '/public/monitorManage.html',
                'printer': '/public/printerManage.html',
                'ip': '/public/ipSegment.html',
                'log': '/public/logManage.html',
                'account': '/public/accountSetting.html'
            };

            setTimeout(() => {
                loading.style.display = 'none';
                if (moduleMap[module]) {
                    window.location.href = moduleMap[module];
                } else {
                    alert('åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
                }
            }, 800);
        }

        // æ‰«ç åŠŸèƒ½ç›¸å…³å˜é‡
        let currentStream = null;
        let currentDeviceId = null;
        let videoDevices = [];
        let currentAssetType = null;
        let currentAssetData = null;
        let isFlashOn = false;
        let allAssets = []; // å­˜å‚¨æ‰€æœ‰èµ„äº§æ•°æ®ç”¨äºæœç´¢

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const keyword = searchInput.value.trim();
            
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                searchInput.focus();
                return;
            }

            console.log('æœç´¢å…³é”®è¯:', keyword);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡æ‰€æœ‰èµ„äº§æ•°æ®ï¼Œå…ˆåŠ è½½
                if (allAssets.length === 0) {
                    await loadAllAssets();
                }
                
                // æ‰§è¡Œæ¨¡ç³Šæœç´¢
                const results = fuzzySearch(keyword, allAssets);
                
                // æ˜¾ç¤ºæœç´¢ç»“æœ
                showSearchResults(keyword, results);
                
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                alert('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                loading.style.display = 'none';
            }
        }

        // åŠ è½½æ‰€æœ‰èµ„äº§æ•°æ®
        async function loadAllAssets() {
            try {
                console.log('æ­£åœ¨åŠ è½½æ‰€æœ‰èµ„äº§æ•°æ®...');
                
                const [hostRes, laptopRes, monitorRes, printerRes, consumableRes] = await Promise.all([
                    apiRequest('/api/host'),
                    apiRequest('/api/laptop'),
                    apiRequest('/api/monitor'),
                    apiRequest('/api/printer'),
                    apiRequest('/api/consumable')
                ]);
                
                allAssets = [];
                
                // ä¸»æœºæ•°æ®
                if (hostRes && hostRes.code === 0 && Array.isArray(hostRes.data)) {
                    hostRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'host',
                            typeLabel: 'ä¸»æœºè®¾å¤‡',
                            icon: 'ğŸ–¥ï¸',
                            searchFields: [item.host_number, item.department, item.user, item.cpu, item.memory, item.ip, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // ç¬”è®°æœ¬æ•°æ®
                if (laptopRes && laptopRes.code === 0 && Array.isArray(laptopRes.data)) {
                    laptopRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'laptop',
                            typeLabel: 'ç¬”è®°æœ¬',
                            icon: 'ğŸ’»',
                            searchFields: [item.asset_number, item.brand, item.model, item.department, item.user, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // æ˜¾ç¤ºå™¨æ•°æ®
                if (monitorRes && monitorRes.code === 0 && Array.isArray(monitorRes.data)) {
                    monitorRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'monitor',
                            typeLabel: 'æ˜¾ç¤ºå™¨',
                            icon: 'ğŸ“º',
                            searchFields: [item.asset_id, item.brand, item.model, item.size, item.department, item.user, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // æ‰“å°æœºæ•°æ®
                if (printerRes && printerRes.code === 0 && Array.isArray(printerRes.data)) {
                    printerRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'printer',
                            typeLabel: 'æ‰“å°æœº',
                            icon: 'ğŸ–¨ï¸',
                            searchFields: [item.asset_number, item.brand, item.model, item.type, item.department, item.user, item.remark].filter(Boolean)
                        });
                    });
                }
                
                // è€—ææ•°æ®
                if (consumableRes && consumableRes.code === 0 && Array.isArray(consumableRes.data)) {
                    consumableRes.data.forEach(item => {
                        allAssets.push({
                            ...item,
                            type: 'consumable',
                            typeLabel: 'è€—æ',
                            icon: 'ğŸ“¦',
                            searchFields: [item.barcode, item.name, item.specification, item.unit, item.remark].filter(Boolean)
                        });
                    });
                }
                
                console.log(`åŠ è½½å®Œæˆï¼Œå…± ${allAssets.length} æ¡èµ„äº§æ•°æ®`);
                
            } catch (error) {
                console.error('åŠ è½½èµ„äº§æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // æ¨¡ç³Šæœç´¢å‡½æ•°
        function fuzzySearch(keyword, assets) {
            if (!keyword || !assets.length) return [];
            
            const lowerKeyword = keyword.toLowerCase();
            const results = [];
            
            assets.forEach(asset => {
                let score = 0;
                let matchedFields = [];
                
                // æ£€æŸ¥æ‰€æœ‰æœç´¢å­—æ®µ
                asset.searchFields.forEach(field => {
                    if (field && field.toString().toLowerCase().includes(lowerKeyword)) {
                        score += 1;
                        matchedFields.push(field);
                    }
                });
                
                // å¦‚æœæœ‰åŒ¹é…ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
                if (score > 0) {
                    results.push({
                        ...asset,
                        score: score,
                        matchedFields: matchedFields
                    });
                }
            });
            
            // æŒ‰åŒ¹é…å¾—åˆ†æ’åº
            results.sort((a, b) => b.score - a.score);
            
            console.log(`æœç´¢ "${keyword}" æ‰¾åˆ° ${results.length} æ¡ç»“æœ`);
            return results;
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function showSearchResults(keyword, results) {
            // éšè—æ¦‚è§ˆå’ŒåŠŸèƒ½æ¨¡å—
            document.getElementById('statsSection').style.display = 'none';
            document.getElementById('featureGrid').style.display = 'none';
            
            // æ˜¾ç¤ºæœç´¢ç»“æœåŒºåŸŸ
            const searchResults = document.getElementById('searchResults');
            const searchResultsTitle = document.getElementById('searchResultsTitle');
            const searchResultsList = document.getElementById('searchResultsList');
            
            searchResults.style.display = 'block';
            searchResultsTitle.textContent = `æœç´¢ "${keyword}" (${results.length} æ¡ç»“æœ)`;
            
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            searchResultsList.innerHTML = '';
            
            if (results.length === 0) {
                // æ— ç»“æœ
                searchResultsList.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ”</div>
                        <p>æœªæ‰¾åˆ°ç›¸å…³èµ„äº§</p>
                        <p style="font-size: 12px; margin-top: 8px;">è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–æ£€æŸ¥æ‹¼å†™</p>
                    </div>
                `;
            } else {
                // æ¸²æŸ“æœç´¢ç»“æœ
                results.forEach(asset => {
                    const item = createSearchResultItem(asset);
                    searchResultsList.appendChild(item);
                });
            }
        }

        // åˆ›å»ºæœç´¢ç»“æœé¡¹
        function createSearchResultItem(asset) {
            const item = document.createElement('div');
            item.className = 'search-result-item';
            item.onclick = () => showAssetDetails(asset);
            
            let primaryId = '';
            let details = {};
            
            // æ ¹æ®èµ„äº§ç±»å‹è®¾ç½®ä¸»è¦ä¿¡æ¯
            switch (asset.type) {
                case 'host':
                    primaryId = asset.host_number;
                    details = {
                        'éƒ¨é—¨': asset.department,
                        'ä½¿ç”¨äºº': asset.user,
                        'CPU': asset.cpu,
                        'IPåœ°å€': asset.ip
                    };
                    break;
                case 'laptop':
                    primaryId = asset.asset_number;
                    details = {
                        'å“ç‰Œ': asset.brand,
                        'å‹å·': asset.model,
                        'éƒ¨é—¨': asset.department,
                        'ä½¿ç”¨äºº': asset.user
                    };
                    break;
                case 'monitor':
                    primaryId = asset.asset_id;
                    details = {
                        'å“ç‰Œ': asset.brand,
                        'å‹å·': asset.model,
                        'å°ºå¯¸': asset.size,
                        'éƒ¨é—¨': asset.department
                    };
                    break;
                case 'printer':
                    primaryId = asset.asset_number;
                    details = {
                        'å“ç‰Œ': asset.brand,
                        'å‹å·': asset.model,
                        'ç±»å‹': asset.type,
                        'éƒ¨é—¨': asset.department
                    };
                    break;
                case 'consumable':
                    primaryId = asset.barcode;
                    details = {
                        'åç§°': asset.name,
                        'è§„æ ¼': asset.specification,
                        'å•ä½': asset.unit,
                        'åº“å­˜': asset.current_stock
                    };
                    break;
            }
            
            // è¿‡æ»¤æ‰ç©ºå€¼
            const filteredDetails = Object.entries(details).filter(([key, value]) => value);
            
            item.innerHTML = `
                <div class="search-result-header">
                    <div>
                        <span class="search-result-type">${asset.icon} ${asset.typeLabel}</span>
                    </div>
                </div>
                <div class="search-result-id">${primaryId}</div>
                <div class="search-result-details">
                    ${filteredDetails.map(([key, value]) => `
                        <div class="search-result-detail">
                            <strong>${key}:</strong> ${value}
                        </div>
                    `).join('')}
                </div>
            `;
            
            return item;
        }

        // æ˜¾ç¤ºèµ„äº§è¯¦æƒ…
        function showAssetDetails(asset) {
            console.log('æŸ¥çœ‹èµ„äº§è¯¦æƒ…:', asset);
            
            // è®¾ç½®å½“å‰èµ„äº§æ•°æ®
            currentAssetType = asset.type;
            currentAssetData = asset;
            
            // è·å–ä¸»è¦æ ‡è¯†ç¬¦
            let code = '';
            switch (asset.type) {
                case 'host':
                    code = asset.host_number;
                    break;
                case 'laptop':
                    code = asset.asset_number;
                    break;
                case 'monitor':
                    code = asset.asset_id;
                    break;
                case 'printer':
                    code = asset.asset_number;
                    break;
                case 'consumable':
                    code = asset.barcode;
                    break;
            }
            
            // æ˜¾ç¤ºèµ„äº§è¡¨å•
            showAssetForm(asset.type, code, asset);
        }

        // æ¸…é™¤æœç´¢ç»“æœ
        function clearSearch() {
            // æ¸…ç©ºæœç´¢æ¡†
            document.getElementById('searchInput').value = '';
            
            // éšè—æœç´¢ç»“æœ
            document.getElementById('searchResults').style.display = 'none';
            
            // æ˜¾ç¤ºæ¦‚è§ˆå’ŒåŠŸèƒ½æ¨¡å—
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('featureGrid').style.display = 'grid';
        }

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        });

        // ç”Ÿæˆéšæœºæ‰«æç‚¹åŠ¨ç”»
        function createRandomScanDots() {
            const container = document.getElementById('randomScanDots');
            if (!container) return;
            
            // æ¸…é™¤ç°æœ‰çš„ç‚¹
            container.innerHTML = '';
            
            // ç”Ÿæˆ15-20ä¸ªéšæœºç‚¹
            const dotCount = 15 + Math.floor(Math.random() * 6);
            
            for (let i = 0; i < dotCount; i++) {
                const dot = document.createElement('div');
                dot.className = 'random-scan-dot';
                
                // éšæœºä½ç½®ï¼ˆåœ¨æ‰«ææ¡†å†…ï¼‰
                const x = Math.random() * 90 + 5; // 5% - 95% çš„ä½ç½®
                const y = Math.random() * 80 + 10; // 10% - 90% çš„ä½ç½®
                
                // éšæœºå¤§å°
                const size = Math.random() * 2 + 2; // 2-4px
                
                // éšæœºåŠ¨ç”»å»¶è¿Ÿ
                const delay = Math.random() * 2; // 0-2ç§’å»¶è¿Ÿ
                
                // éšæœºåŠ¨ç”»æŒç»­æ—¶é—´
                const duration = 1.5 + Math.random() * 1; // 1.5-2.5ç§’
                
                dot.style.cssText = `
                    position: absolute;
                    left: ${x}%;
                    top: ${y}%;
                    width: ${size}px;
                    height: ${size}px;
                    background: rgba(255, 255, 255, 0.8);
                    border-radius: 50%;
                    animation: randomDotBlink ${duration}s infinite;
                    animation-delay: ${delay}s;
                    box-shadow: 0 0 4px rgba(255, 255, 255, 0.6);
                `;
                
                container.appendChild(dot);
            }
        }
        
        // å¯åŠ¨éšæœºç‚¹åŠ¨ç”»å¾ªç¯
        function startRandomDotsAnimation() {
            createRandomScanDots();
            
            // æ¯3-5ç§’é‡æ–°ç”Ÿæˆç‚¹çš„ä½ç½®
            const regenerateInterval = setInterval(() => {
                createRandomScanDots();
            }, 3000 + Math.random() * 2000);
            
            // è¿”å›æ¸…ç†å‡½æ•°
            return () => {
                clearInterval(regenerateInterval);
                const container = document.getElementById('randomScanDots');
                if (container) {
                    container.innerHTML = '';
                }
            };
        }
        
        // æ‰«æåŠ¨ç”»æ¸…ç†å‡½æ•°
        let cleanupScanAnimation = null;

        // å¼€å§‹æ‰«ç 
        async function startScan() {
            try {
                // ç«‹å³æ˜¾ç¤ºæ‰«ç ç•Œé¢ï¼Œæä¾›å¿«é€Ÿåé¦ˆ
                document.getElementById('scanModal').style.display = 'block';
                updateScanMode('ğŸš€ æ­£åœ¨åˆå§‹åŒ–æ‰«æåŠŸèƒ½...');
                
                // å¯åŠ¨éšæœºæ‰«æç‚¹åŠ¨ç”»
                cleanupScanAnimation = startRandomDotsAnimation();
                
                // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
                const isSupported = checkCameraSupport();
                if (!isSupported.supported) {
                    updateScanMode('âŒ æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´');
                    setTimeout(() => {
                        document.getElementById('scanModal').style.display = 'none';
                        showManualInputDialog();
                    }, 2000);
                    return;
                }

                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                
                // æ˜¾ç¤ºè®¾å¤‡æ£€æµ‹çŠ¶æ€
                updateScanMode('ğŸ” æ­£åœ¨æ£€æµ‹æ‘„åƒå¤´è®¾å¤‡...');
                
                // å°è¯•è·å–æ‘„åƒå¤´æƒé™
                try {
                    // è·å–å¯ç”¨çš„æ‘„åƒå¤´è®¾å¤‡
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    if (videoDevices.length === 0) {
                        console.log('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡');
                        updateScanMode('ğŸ“± æœªæ£€æµ‹åˆ°æ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                        showManualInputInModal();
                        return;
                    }

                    updateScanMode(`ğŸ“¹ æ£€æµ‹åˆ° ${videoDevices.length} ä¸ªæ‘„åƒå¤´è®¾å¤‡`);
                    
                    // å¯åŠ¨æ‘„åƒå¤´
                    await startCamera();
                    
                    // å¼€å§‹æ‰«ç æ£€æµ‹
                    startBarcodeDetection();
                    
                } catch (permissionError) {
                    console.error('æ‘„åƒå¤´æƒé™é”™è¯¯:', permissionError);
                    
                    // iOS Safariç‰¹æ®Šå¤„ç†ï¼šç³»ç»Ÿç›¸æœºæ‹¦æˆªæ˜¯æ­£å¸¸ç°è±¡
                    if (isIOS && isSafari && 
                        (permissionError.name === 'NotAllowedError' || 
                         permissionError.name === 'AbortError' ||
                         permissionError.message.includes('Permission'))) {
                        
                        console.log('iOS Safariç³»ç»Ÿç›¸æœºæ‹¦æˆªï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œç»§ç»­ç­‰å¾…...');
                        updateScanMode('ğŸ iOSæ£€æµ‹åˆ°ç›¸æœºè®¿é—®ï¼Œè¯·åœ¨å¼¹çª—ä¸­é€‰æ‹©"å…è®¸"');
                        
                        // å‡å°‘iOSé‡è¯•ç­‰å¾…æ—¶é—´ï¼Œæé«˜å“åº”é€Ÿåº¦
                        setTimeout(async () => {
                            try {
                                console.log('é‡æ–°å°è¯•è·å–iOSæ‘„åƒå¤´æƒé™...');
                                updateScanMode('ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥æ‘„åƒå¤´...');
                                await startCamera();
                                startBarcodeDetection();
                            } catch (retryError) {
                                console.error('é‡è¯•å¤±è´¥:', retryError);
                                updateScanMode('âŒ æ‘„åƒå¤´è¿æ¥å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                                addManualInputButton();
                            }
                        }, 3000); // ç¼©çŸ­åˆ°3ç§’
                        
                    } else {
                        // éiOSæˆ–çœŸæ­£çš„æƒé™æ‹’ç»
                        updateScanMode('âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                        addManualInputButton();
                    }
                }
                
            } catch (error) {
                console.error('å¯åŠ¨æ‰«ç å¤±è´¥:', error);
                showManualInputDialog();
            }
        }

        // æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒæƒ…å†µ
        function checkCameraSupport() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            // æ£€æŸ¥åŸºæœ¬APIæ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                return {
                    supported: false,
                    reason: 'MediaDevices APIä¸æ”¯æŒ',
                    suggestion: isIOS ? 'éœ€è¦HTTPSç¯å¢ƒï¼Œè¯·ä½¿ç”¨HTTPSè®¿é—®' : 'è¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨'
                };
            }

            // iOSè®¾å¤‡ç‰¹æ®Šæ£€æŸ¥
            if (isIOS) {
                // iOS Safari éœ€è¦ iOS 11+ ä¸”å¿…é¡»æ˜¯HTTPS
                if (!window.isSecureContext) {
                    return {
                        supported: false,
                        reason: 'iOSè®¾å¤‡éœ€è¦HTTPSç¯å¢ƒ',
                        suggestion: 'è¯·ä½¿ç”¨HTTPSè®¿é—®æœ¬ç«™ç‚¹'
                    };
                }
                
                // iOS 13.4+ å¯¹ç¬¬ä¸‰æ–¹æµè§ˆå™¨æœ‰æ›´å¥½çš„æ”¯æŒ
                const match = userAgent.match(/OS (\d+)_(\d+)/);
                if (match) {
                    const major = parseInt(match[1]);
                    const minor = parseInt(match[2]);
                    if (major < 11 || (major === 11 && minor < 0)) {
                        return {
                            supported: false,
                            reason: 'iOSç‰ˆæœ¬è¿‡ä½',
                            suggestion: 'è¯·å‡çº§iOSåˆ°11.0ä»¥ä¸Š'
                        };
                    }
                }
            }

            return { supported: true };
        }

        // åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥
        function showManualInputInModal() {
            const scanModal = document.getElementById('scanModal');
            const videoContainer = scanModal.querySelector('div[style*="flex: 1"]');
            
            videoContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background: #1a1a1a; color: white; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“±</div>
                    <h3 style="margin-bottom: 15px; text-align: center;">æ‘„åƒå¤´ä¸å¯ç”¨</h3>
                    <p style="text-align: center; margin-bottom: 30px; color: #ccc; line-height: 1.5;">
                        æ£€æµ‹åˆ°æ‚¨çš„è®¾å¤‡æˆ–æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½<br>
                        è¯·æ‰‹åŠ¨è¾“å…¥èµ„äº§ç¼–å·æˆ–æ¡ç 
                    </p>
                    <input type="text" id="manualCodeInput" placeholder="è¯·è¾“å…¥èµ„äº§ç¼–å·æˆ–æ¡ç " 
                           style="width: 80%; max-width: 300px; padding: 12px; border: 1px solid #444; border-radius: 8px; font-size: 16px; background: #333; color: white; text-align: center;">
                    <button onclick="processManualInput()" 
                            style="margin-top: 20px; background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        ç¡®è®¤æŸ¥æ‰¾
                    </button>
                </div>
            `;
        }

        // ç›´æ¥æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥å¯¹è¯æ¡†
        function showManualInputDialog() {
            const code = prompt('æ£€æµ‹åˆ°æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½\n\nè¯·æ‰‹åŠ¨è¾“å…¥èµ„äº§ç¼–å·æˆ–æ¡ç :');
            if (code && code.trim()) {
                handleScanResult(code.trim());
            }
        }

        // å¤„ç†æ‰‹åŠ¨è¾“å…¥
        function processManualInput() {
            const input = document.getElementById('manualCodeInput');
            const code = input.value.trim();
            if (code) {
                closeScan();
                handleScanResult(code);
            } else {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„èµ„äº§ç¼–å·æˆ–æ¡ç ');
                input.focus();
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´ - iOSä¼˜åŒ–ç‰ˆæœ¬
        async function startCamera(deviceId = null) {
            try {
                // åœæ­¢ä¹‹å‰çš„æµ
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                let constraints;
                
                if (isIOS && isSafari) {
                    // iOS Safari ç‰¹æ®Šä¼˜åŒ– - ä½¿ç”¨æœ€ç®€å•çš„çº¦æŸ
                    constraints = {
                        video: {
                            // é¿å…ä½¿ç”¨å¤æ‚çº¦æŸï¼Œé˜²æ­¢ç³»ç»Ÿç›¸æœºæ¥ç®¡
                            facingMode: deviceId ? undefined : 'environment',
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            // ä½¿ç”¨è¾ƒä½åˆ†è¾¨ç‡ï¼Œå‡å°‘å¤„ç†è´Ÿæ‹…
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            frameRate: { ideal: 15, max: 30 }
                        }
                    };
                } else if (isMobile) {
                    // å…¶ä»–ç§»åŠ¨è®¾å¤‡
                    constraints = {
                        video: {
                            facingMode: deviceId ? undefined : 'environment',
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        }
                    };
                } else {
                    // æ¡Œé¢è®¾å¤‡
                    constraints = {
                        video: {
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                }

                console.log('å°è¯•è·å–æ‘„åƒå¤´ï¼Œçº¦æŸæ¡ä»¶:', constraints);
                
                // iOS Safari ç‰¹æ®Šå¤„ç†ï¼šå‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæé«˜å“åº”é€Ÿåº¦
                if (isIOS && isSafari) {
                    // ç«‹å³æ˜¾ç¤ºå‡†å¤‡çŠ¶æ€
                    updateScanMode('ğŸ“¹ æ­£åœ¨å‡†å¤‡æ‘„åƒå¤´...');
                    
                    // å‡å°‘ç­‰å¾…æ—¶é—´åˆ°1ç§’ï¼Œå¿«é€Ÿå“åº”ç”¨æˆ·æ“ä½œ
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // ç®€åŒ–æµçš„é‡Šæ”¾é€»è¾‘
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        currentStream = null;
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    updateScanMode('ğŸ” è¯·å…è®¸è®¿é—®æ‘„åƒå¤´...');
                }
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const video = document.getElementById('scanVideo');
                video.srcObject = currentStream;
                
                // iOS Safari ç‰¹æ®Šè®¾ç½®
                if (isIOS && isSafari) {
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                    video.muted = true; // é™éŸ³ä»¥é¿å…è‡ªåŠ¨æ’­æ”¾é—®é¢˜
                }
                
                // æ·»åŠ æ’­æ”¾äº‹ä»¶ç›‘å¬
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        console.log('è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
                        
                        // iOS Safari: å»¶è¿Ÿæ’­æ”¾å¹¶å¼ºåˆ¶åˆ·æ–°
                        const playVideo = async () => {
                            try {
                                await video.play();
                                console.log('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
                                currentDeviceId = deviceId;
                                
                                // iOS Safari: é¢å¤–çš„è§†é¢‘æµæ£€æŸ¥å’Œæ¢å¤æœºåˆ¶
                                if (isIOS && isSafari) {
                                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿è§†é¢‘æµç¨³å®š
                                    setTimeout(() => {
                                        if (video.videoWidth === 0 || video.videoHeight === 0) {
                                            console.warn('è§†é¢‘æµå¯èƒ½æœªæ­£ç¡®åŠ è½½ï¼Œå°è¯•é‡æ–°æ’­æ”¾');
                                            video.play();
                                        }
                                        updateScanMode('ğŸ“· æ‘„åƒå¤´å·²å°±ç»ªï¼Œå¼€å§‹æ‰«æ...');
                                        
                                        // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœä»ç„¶æ˜¯é»‘å±ï¼Œæä¾›é‡è¯•é€‰é¡¹
                                        setTimeout(() => {
                                            if (video.videoWidth === 0 || video.videoHeight === 0) {
                                                console.error('æ‘„åƒå¤´æµçŠ¶æ€å¼‚å¸¸ï¼Œå¯èƒ½éœ€è¦é‡è¯•');
                                                updateScanMode('âš ï¸ æ‘„åƒå¤´å¼‚å¸¸ï¼Œå¯ç‚¹å‡»é‡å¯æ‘„åƒå¤´æˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                                                // æ˜¾ç¤ºé‡å¯æ‘„åƒå¤´æŒ‰é’®
                                                const restartBtn = document.getElementById('restartCameraBtn');
                                                if (restartBtn) {
                                                    restartBtn.style.display = 'inline-block';
                                                }
                                                addManualInputButton();
                                            }
                                        }, 3000);
                                    }, 1000);
                                }
                                
                                resolve();
                            } catch (playError) {
                                console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', playError);
                                reject(playError);
                            }
                        };
                        
                        if (isIOS && isSafari) {
                            // iOS Safari: å»¶è¿Ÿæ’­æ”¾
                            setTimeout(playVideo, 500);
                        } else {
                            playVideo();
                        }
                    };
                    
                    video.onerror = (error) => {
                        console.error('è§†é¢‘é”™è¯¯:', error);
                        reject(error);
                    };
                    
                    // è¶…æ—¶å¤„ç†
                    setTimeout(() => {
                        reject(new Error('æ‘„åƒå¤´å¯åŠ¨è¶…æ—¶'));
                    }, 15000); // iOS å»¶é•¿è¶…æ—¶æ—¶é—´
                });
                
            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                
                // iOS Safariç‰¹æ®Šå¤„ç†ï¼šä¸è¦ç«‹å³æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥
                if (isIOS && isSafari) {
                    try {
                        console.log('iOS Safariå°è¯•é™çº§æ–¹æ¡ˆï¼ˆå‰ç½®æ‘„åƒå¤´ï¼‰...');
                        updateScanMode('ğŸ”„ å°è¯•å‰ç½®æ‘„åƒå¤´...');
                        
                        const fallbackConstraints = {
                            video: {
                                facingMode: 'user', // å‰ç½®æ‘„åƒå¤´
                                width: { ideal: 480, max: 640 },
                                height: { ideal: 320, max: 480 }
                            }
                        };
                        currentStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                        const video = document.getElementById('scanVideo');
                        video.srcObject = currentStream;
                        video.setAttribute('playsinline', 'true');
                        video.setAttribute('webkit-playsinline', 'true');
                        video.muted = true;
                        await video.play();
                        console.log('iOSé™çº§æ–¹æ¡ˆæˆåŠŸ');
                        updateScanMode('ğŸ“· å‰ç½®æ‘„åƒå¤´å·²å¯åŠ¨');
                        return; // æˆåŠŸåç›´æ¥è¿”å›ï¼Œä¸æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥
                    } catch (fallbackError) {
                        console.error('iOSé™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                        // å»¶è¿Ÿæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ï¼Œç»™ç”¨æˆ·æ›´å¤šæ—¶é—´
                        updateScanMode('â° æ­£åœ¨é‡è¯•æ‘„åƒå¤´å¯åŠ¨...');
                        setTimeout(() => {
                            updateScanMode('âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                            addManualInputButton();
                        }, 3000);
                    }
                } else {
                    // éiOSè®¾å¤‡çš„æ ‡å‡†å¤„ç†
                    updateScanMode('âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥');
                    addManualInputButton();
                }
                
                // ä¸è¦ç«‹å³æŠ›å‡ºé”™è¯¯æˆ–æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ï¼Œè®©iOSæœ‰æ›´å¤šæ—¶é—´
                if (!(isIOS && isSafari)) {
                    throw error;
                }
            }
        }

        // æ›´æ–°æ‰«ææ¨¡å¼æ˜¾ç¤º
        function updateScanMode(message) {
            const scanModeElement = document.getElementById('scanMode');
            if (scanModeElement) {
                scanModeElement.textContent = message;
            }
        }

        // ç»˜åˆ¶æ¡ç æ£€æµ‹æ¡†
        function drawBarcodeDetectionBox(barcodes, video) {
            const overlay = document.getElementById('barcodeDetectionOverlay');
            if (!overlay || !video) {
                console.warn('æ£€æµ‹æ¡†å®¹å™¨æˆ–è§†é¢‘å…ƒç´ ä¸å­˜åœ¨');
                return;
            }

            // æ¸…é™¤ä¹‹å‰çš„æ£€æµ‹æ¡†
            overlay.innerHTML = '';

            if (barcodes && barcodes.length > 0) {
                barcodes.forEach((barcode, index) => {
                    const boundingBox = barcode.boundingBox;
                    if (boundingBox) {
                        // è·å–å®¹å™¨çš„å®é™…å°ºå¯¸
                        const overlayRect = overlay.getBoundingClientRect();
                        console.log(`è¦†ç›–å±‚å°ºå¯¸: ${overlayRect.width}x${overlayRect.height}`);
                        console.log(`è§†é¢‘å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}`);
                        console.log(`æ¡ç ä½ç½®: x=${boundingBox.x}, y=${boundingBox.y}, w=${boundingBox.width}, h=${boundingBox.height}`);
                        
                        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                        const scaleX = overlayRect.width / video.videoWidth;
                        const scaleY = overlayRect.height / video.videoHeight;
                        
                        console.log(`ç¼©æ”¾æ¯”ä¾‹: scaleX=${scaleX.toFixed(3)}, scaleY=${scaleY.toFixed(3)}`);
                        
                        // è®¡ç®—å®é™…æ˜¾ç¤ºä½ç½®
                        const displayX = boundingBox.x * scaleX;
                        const displayY = boundingBox.y * scaleY;
                        const displayWidth = boundingBox.width * scaleX;
                        const displayHeight = boundingBox.height * scaleY;
                        
                        // åˆ›å»ºæ£€æµ‹æ¡†å…ƒç´ 
                        const detectionBox = document.createElement('div');
                        detectionBox.style.cssText = `
                            position: absolute;
                            border: 4px solid #ff4444;
                            background: rgba(255, 68, 68, 0.15);
                            left: ${displayX}px;
                            top: ${displayY}px;
                            width: ${displayWidth}px;
                            height: ${displayHeight}px;
                            border-radius: 8px;
                            animation: barcodeDetected 0.6s ease-in-out;
                            z-index: 10;
                            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
                        `;
                        
                        // æ·»åŠ æ¡ç å€¼æ ‡ç­¾
                        const label = document.createElement('div');
                        label.style.cssText = `
                            position: absolute;
                            top: -30px;
                            left: 0;
                            background: rgba(255, 68, 68, 0.95);
                            color: white;
                            padding: 4px 12px;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: bold;
                            white-space: nowrap;
                            max-width: 250px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        `;
                        
                        const codeText = barcode.rawValue || 'Unknown';
                        const formatText = barcode.format ? ` (${barcode.format})` : '';
                        label.textContent = codeText + formatText;
                        
                        detectionBox.appendChild(label);
                        overlay.appendChild(detectionBox);
                        
                        console.log(`âœ… æ£€æµ‹æ¡†å·²ç»˜åˆ¶: ${displayX.toFixed(1)}, ${displayY.toFixed(1)}, ${displayWidth.toFixed(1)}, ${displayHeight.toFixed(1)}`);
                        
                        // 3ç§’åè‡ªåŠ¨ç§»é™¤æ£€æµ‹æ¡†
                        setTimeout(() => {
                            if (detectionBox.parentNode) {
                                detectionBox.parentNode.removeChild(detectionBox);
                                console.log('æ£€æµ‹æ¡†å·²ç§»é™¤');
                            }
                        }, 3000);
                    } else {
                        console.warn(`æ¡ç  ${index} æ²¡æœ‰è¾¹ç•Œæ¡†ä¿¡æ¯`);
                    }
                });
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ£€æµ‹æ¡†
        function clearBarcodeDetectionBoxes() {
            const overlay = document.getElementById('barcodeDetectionOverlay');
            if (overlay) {
                overlay.innerHTML = '';
            }
        }

        // iOS Safariä¸“ç”¨ï¼šé‡å¯æ‘„åƒå¤´æµ
        async function restartCameraForiOS() {
            try {
                console.log('iOS Safari: å°è¯•é‡å¯æ‘„åƒå¤´æµ');
                updateScanMode('ğŸ”„ æ­£åœ¨é‡å¯æ‘„åƒå¤´...');
                
                const video = document.getElementById('scanVideo');
                
                // å®Œå…¨åœæ­¢å½“å‰æµ
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                // æ¸…é™¤è§†é¢‘æº
                video.srcObject = null;
                video.load();
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©ç³»ç»Ÿå®Œå…¨é‡Šæ”¾èµ„æº
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // é‡æ–°å¯åŠ¨æ‘„åƒå¤´
                await startCamera(currentDeviceId);
                updateScanMode('âœ… æ‘„åƒå¤´é‡å¯æˆåŠŸ');
                
                // éšè—é‡å¯æŒ‰é’®
                const restartBtn = document.getElementById('restartCameraBtn');
                if (restartBtn) {
                    restartBtn.style.display = 'none';
                }
                
                // é‡æ–°å¼€å§‹æ‰«ææ£€æµ‹
                startBarcodeDetection();
                
            } catch (error) {
                console.error('é‡å¯æ‘„åƒå¤´å¤±è´¥:', error);
                updateScanMode('âŒ é‡å¯å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                addManualInputButton();
            }
        }

        // å¼€å§‹æ¡ç æ£€æµ‹ - ä¿®å¤ç‰ˆæœ¬ï¼Œä½¿ç”¨ç°æœ‰è§†é¢‘æµ
        function startBarcodeDetection() {
            const scanModeElement = document.getElementById('scanMode');
            const video = document.getElementById('scanVideo');
            
            // æ£€æŸ¥QuaggaJSåº“æ˜¯å¦å¯ç”¨
            if (typeof Quagga === 'undefined') {
                console.error('QuaggaJSåº“æœªåŠ è½½ï¼Œä½¿ç”¨æ‰‹åŠ¨è¾“å…¥');
                if (scanModeElement) scanModeElement.textContent = 'âŒ æ‰«æåº“åŠ è½½å¤±è´¥ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥';
                addManualInputButton();
                return;
            }

            // æ£€æŸ¥è§†é¢‘å…ƒç´ æ˜¯å¦å­˜åœ¨ä¸”æœ‰æµ
            if (!video || !video.srcObject) {
                console.error('è§†é¢‘å…ƒç´ ä¸å­˜åœ¨æˆ–æ²¡æœ‰æ‘„åƒå¤´æµ');
                if (scanModeElement) scanModeElement.textContent = 'âŒ æ‘„åƒå¤´æœªå°±ç»ªï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
                addManualInputButton();
                return;
            }

            console.log('ğŸš€ å¯åŠ¨QuaggaJSä¸“ç”¨Code 128æ¡ç æ£€æµ‹å¼•æ“...');
            if (scanModeElement) scanModeElement.textContent = 'ğŸ“Š Code 128ä¸“ç”¨æ£€æµ‹å¼•æ“å¯åŠ¨ä¸­...';
            
            // ç­‰å¾…è§†é¢‘å®Œå…¨åŠ è½½åå†å¯åŠ¨æ£€æµ‹
            const startDetection = () => {
                try {
                    // åˆ›å»ºæ£€æµ‹ç”»å¸ƒå…ƒç´ 
                    let canvas = document.getElementById('quaggaCanvas');
                    if (!canvas) {
                        canvas = document.createElement('canvas');
                        canvas.id = 'quaggaCanvas';
                        canvas.style.cssText = `
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 3;
                            pointer-events: none;
                        `;
                        video.parentNode.appendChild(canvas);
                    }
                    
                    // QuaggaJSé…ç½® - ä¸“é—¨ä¼˜åŒ–Code 128æ£€æµ‹
                    const quaggaConfig = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: canvas,
                            constraints: {
                                width: { min: 480, ideal: 800, max: 1280 },
                                height: { min: 320, ideal: 600, max: 720 },
                                facingMode: "environment"
                            },
                            area: {     // é™åˆ¶æ£€æµ‹åŒºåŸŸï¼Œå‡å°‘è¯¯æ£€
                                top: "35%",
                                right: "15%", 
                                left: "15%",
                                bottom: "35%"
                            }
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: false,   // å…³é—­åŠé‡‡æ ·ï¼Œæé«˜ç²¾åº¦
                            willReadFrequently: true
                        },
                        numOfWorkers: 1,
                        frequency: 8,            // é™ä½é¢‘ç‡ï¼Œæé«˜ç¨³å®šæ€§
                        decoder: {
                            readers: [
                                "code_128_reader"    // åªæ£€æµ‹Code 128ï¼Œé¿å…è¯¯æ£€EANæ ¼å¼
                            ],
                            multiple: false      // åªæ£€æµ‹å•ä¸ªæ¡ç 
                        },
                        locate: true,
                        debug: {
                            showCanvas: false,
                            showPatches: false,
                            showFoundPatches: false,
                            showSkeleton: false,
                            showLabels: false,
                            showPatchLabels: false,
                            showRemainingPatchLabels: false,
                            boxFromPatches: {
                                showTransformed: false,
                                showTransformedBox: false,
                                showBB: false
                            }
                        }
                    };
                    
                    let detectionCount = 0;
                    let detectionStartTime = Date.now();
                    
                    // æˆåŠŸæ£€æµ‹å›è°ƒ - å¢å¼ºCode 128éªŒè¯
                    Quagga.onDetected((result) => {
                        const code = result.codeResult.code;
                        const format = result.codeResult.format;
                        const confidence = 1 - (result.codeResult.startInfo.error || 0);
                        
                        console.log(`ğŸ” QuaggaJSæ£€æµ‹ç»“æœ: ${code} (${format}), ç½®ä¿¡åº¦: ${(confidence*100).toFixed(1)}%`);
                        
                        // åªæ¥å—Code 128æ ¼å¼ï¼Œä¸”ç½®ä¿¡åº¦è¦æ±‚æ›´é«˜
                        if (format === 'code_128' && confidence > 0.85) {
                            console.log(`âœ… Code 128æ£€æµ‹æˆåŠŸ: ${code}, ç½®ä¿¡åº¦: ${(confidence*100).toFixed(1)}%`);
                            
                            // åœæ­¢æ£€æµ‹
                            stopQuaggaDetection();
                            
                            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                            if (scanModeElement) {
                                scanModeElement.textContent = `âœ… æ£€æµ‹åˆ°Code 128: ${code}`;
                            }
                            
                            // åˆ›å»ºæ£€æµ‹æ¡†æ˜¾ç¤º
                            const mockBarcodes = [{
                                rawValue: code,
                                format: format,
                                boundingBox: {
                                    x: result.box ? result.box[0][0] : (video.offsetWidth * 0.15),
                                    y: result.box ? result.box[0][1] : (video.offsetHeight * 0.35), 
                                    width: result.box ? Math.abs(result.box[2][0] - result.box[0][0]) : (video.offsetWidth * 0.7),
                                    height: result.box ? Math.abs(result.box[2][1] - result.box[0][1]) : (video.offsetHeight * 0.3)
                                }
                            }];
                            
                            drawBarcodeDetectionBox(mockBarcodes, video);
                            
                            // å»¶è¿Ÿå¤„ç†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ£€æµ‹æ¡†
                            setTimeout(() => {
                                handleScanResult(code);
                            }, 1200);
                        } else {
                            console.log(`âŒ æ£€æµ‹ç»“æœä¸ç¬¦åˆè¦æ±‚: æ ¼å¼=${format}, ç½®ä¿¡åº¦=${(confidence*100).toFixed(1)}%`);
                            
                            // å¦‚æœä¸æ˜¯Code 128æˆ–ç½®ä¿¡åº¦ä¸å¤Ÿï¼Œç»§ç»­æ£€æµ‹
                            if (scanModeElement) {
                                if (format !== 'code_128') {
                                    scanModeElement.textContent = `âš ï¸ æ£€æµ‹åˆ°${format}æ ¼å¼ï¼Œè¯·å¯¹å‡†Code 128æ¡ç `;
                                } else {
                                    scanModeElement.textContent = `âš ï¸ ä¿¡å·è¾ƒå¼±(${(confidence*100).toFixed(0)}%)ï¼Œè¯·è°ƒæ•´è§’åº¦å’Œè·ç¦»`;
                                }
                            }
                        }
                    });
                    
                    // å¤„ç†æ¯ä¸€å¸§ - æ˜¾ç¤ºCode 128æ£€æµ‹è¿›åº¦
                    Quagga.onProcessed((result) => {
                        detectionCount++;
                        
                        if (detectionCount % 30 === 0) {
                            const elapsed = (Date.now() - detectionStartTime) / 1000;
                            const rate = (detectionCount / elapsed).toFixed(1);
                            
                            if (scanModeElement) {
                                scanModeElement.textContent = `ğŸ¯ Code 128ä¸“ç”¨æ£€æµ‹ä¸­... ${rate}å¸§/ç§’`;
                            }
                            
                            console.log(`ğŸ“Š Code 128æ£€æµ‹è¿›åº¦: ${detectionCount} å¸§ï¼Œç”¨æ—¶ ${elapsed.toFixed(1)}ç§’ï¼Œæ£€æµ‹ç‡ ${rate}/ç§’`);
                            
                            // 30ç§’åè‡ªåŠ¨æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹
                            if (elapsed > 30) {
                                console.log('â° Code 128æ£€æµ‹è¶…æ—¶ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹');
                                if (scanModeElement) {
                                    scanModeElement.textContent = 'â° æ£€æµ‹è¶…æ—¶ï¼Œå¯ç‚¹å‡»æ‰‹åŠ¨è¾“å…¥';
                                }
                                addManualInputButton();
                            }
                        }
                    });
                    
                    // åˆå§‹åŒ–QuaggaJS
                    Quagga.init(quaggaConfig, (err) => {
                        if (err) {
                            console.error('âŒ QuaggaJSåˆå§‹åŒ–å¤±è´¥:', err.message || err);
                            if (scanModeElement) {
                                scanModeElement.textContent = 'âŒ æ£€æµ‹å¼•æ“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
                            }
                            addManualInputButton();
                            return;
                        }
                        
                        console.log('âœ… QuaggaJSåˆå§‹åŒ–æˆåŠŸï¼Œå¼€å§‹ä¸“ç”¨Code 128æ¡ç æ‰«æ...');
                        Quagga.start();
                        
                        // æ›´æ–°çŠ¶æ€æç¤º
                        if (scanModeElement) {
                            scanModeElement.textContent = 'ğŸ¯ Code 128æ£€æµ‹ä¸­... è¯·å°†æ¡ç å¯¹å‡†æ¨ªæ¡†';
                        }
                        
                        // 15ç§’åæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹ä½œä¸ºå¤‡é€‰
                        setTimeout(() => {
                            addManualInputButton();
                        }, 15000);
                    });
                    
                } catch (error) {
                    console.error('å¯åŠ¨æ£€æµ‹æ—¶å‡ºé”™:', error);
                    if (scanModeElement) {
                        scanModeElement.textContent = 'âŒ å¯åŠ¨æ£€æµ‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
                    }
                    addManualInputButton();
                }
            };
            
            // æ£€æŸ¥è§†é¢‘æ˜¯å¦å·²ç»å‡†å¤‡å¥½
            if (video.readyState >= 2) {
                // è§†é¢‘å·²åŠ è½½ï¼Œç›´æ¥å¯åŠ¨æ£€æµ‹
                startDetection();
            } else {
                // ç­‰å¾…è§†é¢‘åŠ è½½
                video.addEventListener('loadeddata', startDetection, { once: true });
                // è¶…æ—¶ä¿æŠ¤
                setTimeout(() => {
                    if (video.readyState < 2) {
                        console.warn('è§†é¢‘åŠ è½½è¶…æ—¶ï¼Œå°è¯•å¼ºåˆ¶å¯åŠ¨æ£€æµ‹');
                        startDetection();
                    }
                }, 3000);
            }
        }
        
        // åœæ­¢QuaggaJSæ£€æµ‹
        function stopQuaggaDetection() {
            try {
                if (typeof Quagga !== 'undefined') {
                    Quagga.stop();
                    Quagga.offDetected();
                    Quagga.offProcessed();
                    
                    // æ¸…ç†canvaså…ƒç´ 
                    const canvas = document.getElementById('quaggaCanvas');
                    if (canvas) {
                        canvas.remove();
                    }
                    
                    // æ¸…ç†æ—§çš„æ£€æµ‹å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const container = document.getElementById('quaggaDetectionContainer');
                    if (container) {
                        container.remove();
                    }
                    
                    console.log('ğŸ›‘ QuaggaJSæ£€æµ‹å·²åœæ­¢');
                }
            } catch (e) {
                console.warn('åœæ­¢QuaggaJSæ£€æµ‹æ—¶å‡ºé”™:', e);
            }
        }

        // æ·»åŠ æ‰‹åŠ¨è¾“å…¥æŒ‰é’®åˆ°æ‰«ç ç•Œé¢
        function addManualInputButton() {
            const scanModal = document.getElementById('scanModal');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†æŒ‰é’®
            if (scanModal.querySelector('.manual-input-btn')) {
                return;
            }
            
            const manualInput = document.createElement('button');
            manualInput.className = 'manual-input-btn';
            manualInput.innerHTML = 'ğŸ“ æ‰‹åŠ¨è¾“å…¥ç¼–å·';
            manualInput.style.cssText = `
                position: absolute; 
                top: 70px; 
                right: 20px; 
                background: rgba(0, 123, 255, 0.8); 
                border: none; 
                color: white; 
                padding: 10px 16px; 
                border-radius: 8px; 
                font-size: 14px; 
                cursor: pointer;
                z-index: 10001;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            `;
            manualInput.onclick = () => {
                const code = prompt('è¯·è¾“å…¥èµ„äº§ç¼–å·æˆ–æ¡ç :');
                if (code && code.trim()) {
                    handleScanResult(code.trim());
                }
            };
            scanModal.appendChild(manualInput);
        }

        // å¤„ç†æ‰«ç ç»“æœ
        async function handleScanResult(code) {
            console.log('æ‰«ç ç»“æœ:', code);
            
            // åœæ­¢æ‘„åƒå¤´
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // éšè—æ‰«ç ç•Œé¢
            document.getElementById('scanModal').style.display = 'none';
            
            // è§£æèµ„äº§ç±»å‹å’Œç¼–å·
            const assetInfo = parseAssetCode(code);
            currentAssetType = assetInfo.type;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // æ ¹æ®èµ„äº§ç±»å‹æŸ¥è¯¢æ•°æ®
                let assetData = null;
                
                if (assetInfo.type === 'host') {
                    assetData = await findAssetByNumber('/api/host', 'host_number', code);
                } else if (assetInfo.type === 'monitor') {
                    assetData = await findAssetByNumber('/api/monitor', 'asset_id', code);
                } else if (assetInfo.type === 'printer') {
                    assetData = await findAssetByNumber('/api/printer', 'asset_number', code);
                } else if (assetInfo.type === 'consumable') {
                    assetData = await findAssetByNumber('/api/consumable', 'barcode', code);
                }
                
                loading.style.display = 'none';
                
                // æ˜¾ç¤ºèµ„äº§ä¿¡æ¯è¡¨å•
                showAssetForm(assetInfo.type, code, assetData);
                
            } catch (error) {
                loading.style.display = 'none';
                console.error('æŸ¥è¯¢èµ„äº§å¤±è´¥:', error);
                alert('æŸ¥è¯¢èµ„äº§ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è§£æèµ„äº§ç¼–å·ï¼Œç¡®å®šèµ„äº§ç±»å‹
        function parseAssetCode(code) {
            const upperCode = code.toUpperCase();
            
            if (upperCode.startsWith('PC-')) {
                return { type: 'host', prefix: 'PC-' };
            } else if (upperCode.startsWith('MONITOR-')) {
                return { type: 'monitor', prefix: 'MONITOR-' };
            } else if (upperCode.startsWith('PRINT-')) {
                return { type: 'printer', prefix: 'PRINT-' };
            } else {
                // é»˜è®¤å½’ç±»ä¸ºè€—æ
                return { type: 'consumable', prefix: '' };
            }
        }

        // æ ¹æ®ç¼–å·æŸ¥æ‰¾èµ„äº§
        async function findAssetByNumber(apiUrl, fieldName, code) {
            const response = await apiRequest(apiUrl);
            if (response && response.code === 0 && Array.isArray(response.data)) {
                return response.data.find(item => item[fieldName] === code) || null;
            }
            return null;
        }

        // æ˜¾ç¤ºèµ„äº§ä¿¡æ¯è¡¨å•
        function showAssetForm(assetType, code, existingData) {
            currentAssetData = existingData;
            
            document.getElementById('scannedCode').textContent = `æ‰«æç»“æœ: ${code}`;
            
            const formContainer = document.getElementById('assetForm');
            let formHTML = '';
            
            if (assetType === 'host') {
                formHTML = generateHostForm(code, existingData);
            } else if (assetType === 'monitor') {
                formHTML = generateMonitorForm(code, existingData);
            } else if (assetType === 'printer') {
                formHTML = generatePrinterForm(code, existingData);
            } else if (assetType === 'consumable') {
                formHTML = generateConsumableForm(code, existingData);
            }
            
            formContainer.innerHTML = formHTML;
            document.getElementById('resultModal').style.display = 'block';
        }

        // ç”Ÿæˆä¸»æœºè¡¨å•
        function generateHostForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">ä¸»æœºç¼–å·</label>
                    <input type="text" class="form-input" id="host_number" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">éƒ¨é—¨</label>
                    <input type="text" class="form-input" id="department" value="${data?.department || ''}" placeholder="è¯·è¾“å…¥éƒ¨é—¨">
                </div>
                <div class="form-group">
                    <label class="form-label">ä½¿ç”¨äººå‘˜</label>
                    <input type="text" class="form-input" id="user" value="${data?.user || ''}" placeholder="è¯·è¾“å…¥ä½¿ç”¨äººå‘˜">
                </div>
                <div class="form-group">
                    <label class="form-label">CPU</label>
                    <input type="text" class="form-input" id="cpu" value="${data?.cpu || ''}" placeholder="è¯·è¾“å…¥CPUå‹å·">
                </div>
                <div class="form-group">
                    <label class="form-label">å†…å­˜</label>
                    <input type="text" class="form-input" id="memory" value="${data?.memory || ''}" placeholder="è¯·è¾“å…¥å†…å­˜é…ç½®">
                </div>
                <div class="form-group">
                    <label class="form-label">ç¡¬ç›˜</label>
                    <input type="text" class="form-input" id="disk" value="${data?.disk || ''}" placeholder="è¯·è¾“å…¥ç¡¬ç›˜é…ç½®">
                </div>
                <div class="form-group">
                    <label class="form-label">IPåœ°å€</label>
                    <input type="text" class="form-input" id="ip" value="${data?.ip || ''}" placeholder="è¯·è¾“å…¥IPåœ°å€">
                </div>
                <div class="form-group">
                    <label class="form-label">MACåœ°å€</label>
                    <input type="text" class="form-input" id="mac" value="${data?.mac || ''}" placeholder="è¯·è¾“å…¥MACåœ°å€">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">
                </div>
            `;
        }

        // ç”Ÿæˆæ˜¾ç¤ºå™¨è¡¨å•
        function generateMonitorForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">æ˜¾ç¤ºå™¨ç¼–å·</label>
                    <input type="text" class="form-input" id="asset_id" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">å“ç‰Œ</label>
                    <input type="text" class="form-input" id="brand" value="${data?.brand || ''}" placeholder="è¯·è¾“å…¥å“ç‰Œ">
                </div>
                <div class="form-group">
                    <label class="form-label">å‹å·</label>
                    <input type="text" class="form-input" id="model" value="${data?.model || ''}" placeholder="è¯·è¾“å…¥å‹å·">
                </div>
                <div class="form-group">
                    <label class="form-label">å°ºå¯¸</label>
                    <input type="text" class="form-input" id="size" value="${data?.size || ''}" placeholder="è¯·è¾“å…¥å°ºå¯¸">
                </div>
                <div class="form-group">
                    <label class="form-label">éƒ¨é—¨</label>
                    <input type="text" class="form-input" id="department" value="${data?.department || ''}" placeholder="è¯·è¾“å…¥éƒ¨é—¨">
                </div>
                <div class="form-group">
                    <label class="form-label">ä½¿ç”¨äººå‘˜</label>
                    <input type="text" class="form-input" id="user" value="${data?.user || ''}" placeholder="è¯·è¾“å…¥ä½¿ç”¨äººå‘˜">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">
                </div>
            `;
        }

        // ç”Ÿæˆæ‰“å°æœºè¡¨å•
        function generatePrinterForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">æ‰“å°æœºç¼–å·</label>
                    <input type="text" class="form-input" id="asset_number" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">å“ç‰Œ</label>
                    <input type="text" class="form-input" id="brand" value="${data?.brand || ''}" placeholder="è¯·è¾“å…¥å“ç‰Œ">
                </div>
                <div class="form-group">
                    <label class="form-label">å‹å·</label>
                    <input type="text" class="form-input" id="model" value="${data?.model || ''}" placeholder="è¯·è¾“å…¥å‹å·">
                </div>
                <div class="form-group">
                    <label class="form-label">ç±»å‹</label>
                    <select class="form-input" id="type">
                        <option value="æ¿€å…‰æ‰“å°æœº" ${data?.type === 'æ¿€å…‰æ‰“å°æœº' ? 'selected' : ''}>æ¿€å…‰æ‰“å°æœº</option>
                        <option value="å–·å¢¨æ‰“å°æœº" ${data?.type === 'å–·å¢¨æ‰“å°æœº' ? 'selected' : ''}>å–·å¢¨æ‰“å°æœº</option>
                        <option value="é’ˆå¼æ‰“å°æœº" ${data?.type === 'é’ˆå¼æ‰“å°æœº' ? 'selected' : ''}>é’ˆå¼æ‰“å°æœº</option>
                        <option value="å¤šåŠŸèƒ½ä¸€ä½“æœº" ${data?.type === 'å¤šåŠŸèƒ½ä¸€ä½“æœº' ? 'selected' : ''}>å¤šåŠŸèƒ½ä¸€ä½“æœº</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">éƒ¨é—¨</label>
                    <input type="text" class="form-input" id="department" value="${data?.department || ''}" placeholder="è¯·è¾“å…¥éƒ¨é—¨">
                </div>
                <div class="form-group">
                    <label class="form-label">ä½¿ç”¨äººå‘˜</label>
                    <input type="text" class="form-input" id="user" value="${data?.user || ''}" placeholder="è¯·è¾“å…¥ä½¿ç”¨äººå‘˜">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">
                </div>
            `;
        }

        // ç”Ÿæˆè€—æè¡¨å•
        function generateConsumableForm(code, data) {
            return `
                <div class="form-group">
                    <label class="form-label">æ¡ç </label>
                    <input type="text" class="form-input" id="barcode" value="${code}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">è€—æåç§°</label>
                    <input type="text" class="form-input" id="name" value="${data?.name || ''}" placeholder="è¯·è¾“å…¥è€—æåç§°" required>
                </div>
                <div class="form-group">
                    <label class="form-label">è§„æ ¼å‹å·</label>
                    <input type="text" class="form-input" id="specification" value="${data?.specification || ''}" placeholder="è¯·è¾“å…¥è§„æ ¼å‹å·">
                </div>
                <div class="form-group">
                    <label class="form-label">å•ä½</label>
                    <select class="form-input" id="unit">
                        <option value="ä¸ª" ${data?.unit === 'ä¸ª' ? 'selected' : ''}>ä¸ª</option>
                        <option value="æ”¯" ${data?.unit === 'æ”¯' ? 'selected' : ''}>æ”¯</option>
                        <option value="ç›’" ${data?.unit === 'ç›’' ? 'selected' : ''}>ç›’</option>
                        <option value="å¥—" ${data?.unit === 'å¥—' ? 'selected' : ''}>å¥—</option>
                        <option value="åŒ…" ${data?.unit === 'åŒ…' ? 'selected' : ''}>åŒ…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å½“å‰åº“å­˜</label>
                    <input type="number" class="form-input" id="current_stock" value="${data?.current_stock || 0}" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">æœ€å°åº“å­˜</label>
                    <input type="number" class="form-input" id="min_stock" value="${data?.min_stock || 0}" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <input type="text" class="form-input" id="remark" value="${data?.remark || ''}" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯">
                </div>
            `;
        }

        // ä¿å­˜èµ„äº§ä¿¡æ¯
        async function saveAsset() {
            try {
                const formData = new FormData();
                const inputs = document.querySelectorAll('#assetForm input, #assetForm select');
                
                // æ”¶é›†è¡¨å•æ•°æ®
                const data = {};
                inputs.forEach(input => {
                    data[input.id] = input.value;
                });

                let apiUrl = '';
                let method = 'POST';
                let apiData = data;

                // æ ¹æ®èµ„äº§ç±»å‹ç¡®å®šAPIç«¯ç‚¹
                if (currentAssetType === 'host') {
                    apiUrl = '/api/host';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                } else if (currentAssetType === 'monitor') {
                    apiUrl = '/api/monitor';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                } else if (currentAssetType === 'printer') {
                    apiUrl = '/api/printer';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                } else if (currentAssetType === 'consumable') {
                    apiUrl = '/api/consumable';
                    if (currentAssetData) {
                        apiUrl += '/' + currentAssetData.id;
                        method = 'PUT';
                    }
                }

                // å‘é€è¯·æ±‚
                const response = await apiRequest(apiUrl, {
                    method: method,
                    body: JSON.stringify(apiData)
                });

                if (response && response.code === 0) {
                    alert(currentAssetData ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
                    closeResult();
                    // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                    loadStats();
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (response?.msg || 'æœªçŸ¥é”™è¯¯'));
                }

            } catch (error) {
                console.error('ä¿å­˜èµ„äº§å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å…³é—­æ‰«ç ç•Œé¢
        function closeScan() {
            // åœæ­¢æ‘„åƒå¤´æµ
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            // åœæ­¢QuaggaJSæ£€æµ‹
            stopQuaggaDetection();
            
            // æ¸…é™¤æ¡ç æ£€æµ‹æ¡†
            clearBarcodeDetectionBoxes();
            
            // æ¸…ç†éšæœºæ‰«æç‚¹åŠ¨ç”»
            if (cleanupScanAnimation) {
                cleanupScanAnimation();
                cleanupScanAnimation = null;
            }
            
            // æ¸…ç†æ‰‹åŠ¨è¾“å…¥æŒ‰é’®
            const scanModal = document.getElementById('scanModal');
            const manualBtn = scanModal.querySelector('.manual-input-btn');
            if (manualBtn) {
                manualBtn.remove();
            }
            
            // é‡ç½®é‡å¯æ‘„åƒå¤´æŒ‰é’®çŠ¶æ€
            const restartBtn = document.getElementById('restartCameraBtn');
            if (restartBtn) {
                restartBtn.style.display = 'none';
            }
            
            // é‡ç½®è§†é¢‘å®¹å™¨ï¼ˆå¦‚æœè¢«ä¿®æ”¹è¿‡ï¼‰
            const videoContainer = scanModal.querySelector('div[style*="flex: 1"]');
            if (videoContainer && !videoContainer.querySelector('#scanVideo')) {
                videoContainer.innerHTML = `
                    <video id="scanVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                    
                    <!-- æ¡ç æ£€æµ‹æ¡†å®¹å™¨ -->
                    <div id="barcodeDetectionOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
                    
                    <!-- æ‰«ææ¡† -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 200px; border: 2px solid #00ff88; border-radius: 12px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5);">
                        <div style="position: absolute; top: -2px; left: -2px; width: 20px; height: 20px; border-top: 3px solid #00ff88; border-left: 3px solid #00ff88;"></div>
                        <div style="position: absolute; top: -2px; right: -2px; width: 20px; height: 20px; border-top: 3px solid #00ff88; border-right: 3px solid #00ff88;"></div>
                        <div style="position: absolute; bottom: -2px; left: -2px; width: 20px; height: 20px; border-bottom: 3px solid #00ff88; border-left: 3px solid #00ff88;"></div>
                        <div style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; border-bottom: 3px solid #00ff88; border-right: 3px solid #00ff88;"></div>
                    </div>
                    
                    <!-- æ‰«æçº¿åŠ¨ç”» -->
                    <div id="scanLine" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 2px; background: linear-gradient(90deg, transparent, #00ff88, transparent); animation: scanAnimation 2s linear infinite;"></div>
                `;
            }
            
            document.getElementById('scanModal').style.display = 'none';
        }

        // å…³é—­ç»“æœç•Œé¢
        function closeResult() {
            document.getElementById('resultModal').style.display = 'none';
            currentAssetType = null;
            currentAssetData = null;
        }

        // åˆ‡æ¢é—ªå…‰ç¯
        function toggleFlash() {
            if (currentStream) {
                const track = currentStream.getVideoTracks()[0];
                if (track && track.getCapabilities && track.getCapabilities().torch) {
                    isFlashOn = !isFlashOn;
                    track.applyConstraints({
                        advanced: [{ torch: isFlashOn }]
                    });
                    document.getElementById('flashBtn').textContent = isFlashOn ? 'ğŸ’¡ å…³é—­é—ªå…‰ç¯' : 'ğŸ’¡ å¼€å¯é—ªå…‰ç¯';
                } else {
                    alert('å½“å‰è®¾å¤‡ä¸æ”¯æŒé—ªå…‰ç¯');
                }
            }
        }

        // åˆ‡æ¢æ‘„åƒå¤´
        async function switchCamera() {
            if (videoDevices.length > 1) {
                const currentIndex = videoDevices.findIndex(device => device.deviceId === currentDeviceId);
                const nextIndex = (currentIndex + 1) % videoDevices.length;
                const nextDevice = videoDevices[nextIndex];
                
                try {
                    await startCamera(nextDevice.deviceId);
                } catch (error) {
                    console.error('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
                    alert('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥');
                }
            } else {
                alert('åªæ£€æµ‹åˆ°ä¸€ä¸ªæ‘„åƒå¤´è®¾å¤‡');
            }
        }

        // è·³è½¬åˆ°æ¡Œé¢ç‰ˆï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼Œä½†éšè—ï¼‰
        function goToDesktop() {
            if (confirm('å³å°†è·³è½¬åˆ°å®Œæ•´ç‰ˆç³»ç»Ÿï¼Œå»ºè®®ä½¿ç”¨ç”µè„‘æµè§ˆå™¨è®¿é—®ä»¥è·å¾—æœ€ä½³ä½“éªŒã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                window.location.href = '/public/index.html?desktop=1';
            }
        }

        // æ£€æŸ¥ç”¨æˆ·ä»£ç†ï¼Œå¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡åˆ™æ·»åŠ ç‰¹æ®Šæ ·å¼
        function checkMobileDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('mobile-device');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            checkMobileDevice();
            loadStats();
            
            // æ·»åŠ è§¦æ‘¸åé¦ˆ
            const cards = document.querySelectorAll('.feature-card');
            cards.forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                card.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const response = await apiRequest('/api/auth/check');
                if (!response || response.code !== 0) {
                    window.location.href = '/public/login.html';
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                window.location.href = '/public/login.html';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkAuth();
    </script>
</body>
</html>
